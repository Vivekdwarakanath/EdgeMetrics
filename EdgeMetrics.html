<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdgeMetrics ‚Ä¢ Trading Journal</title>
    <!-- PWA Meta Tags -->
<meta name="theme-color" content="#0a0a0a">
<meta name="description" content="Privacy-first trading journal with AI insights, live charts, and professional analytics.">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="EdgeMetrics">
<link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['IBM Plex Mono', 'monospace'],
          },
        },
      };
    </script>
    
    <style>
      * { 
        font-family: 'Inter', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      /* Theme Variables */
      :root {
        --bg-primary: #0a0a0a;
        --bg-secondary: #111111;
        --bg-tertiary: #1a1a1a;
        --border-color: #222222;
        --border-hover: #333333;
        --text-primary: #e5e5e5;
        --text-secondary: #9ca3af;
        --text-muted: #6b7280;
      }
      
      body.light-theme {
        --bg-primary: #ffffff;
        --bg-secondary: #f9fafb;
        --bg-tertiary: #f3f4f6;
        --border-color: #e5e7eb;
        --border-hover: #d1d5db;
        --text-primary: #111827;
        --text-secondary: #4b5563;
        --text-muted: #6b7280;
      }
      
      body {
        background: var(--bg-primary);
        color: var(--text-primary);
        overflow-x: hidden;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      
      header {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
      }
      
      /* Logo styling */
      .logo-container {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      
      .logo-icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.25rem;
        color: #fff;
      }
      
      /* AI indicator */
      .ai-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        color: #fff;
      }
      
      .ai-pulse {
        width: 6px;
        height: 6px;
        background: #fff;
        border-radius: 50%;
        animation: pulse 2s ease-in-out infinite;
      }
      
      /* Footer */
      footer {
        margin-top: auto;
        border-top: 1px solid var(--border-color);
        padding: 3rem 0;
        background: var(--bg-primary);
      }
      
      /* Feature badge */
      .feature-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.875rem;
        background: #111111;
        border: 1px solid #222222;
        border-radius: 16px;
        font-size: 0.75rem;
        font-weight: 500;
        color: #9ca3af;
      }
      
      /* Session card styling - execution log aesthetic */
      .session-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 1.25rem;
        transition: border-color 0.2s ease;
      }
      
      .session-card:hover {
        border-color: var(--border-hover);
      }
      
      /* Outcome indicators - semantic only */
      .session-card.outcome-win {
        border-left: 2px solid #10b981;
      }
      
      .session-card.outcome-loss {
        border-left: 2px solid #ef4444;
      }
      
      .session-card.outcome-breakeven,
      .session-card.outcome-no-trade {
        border-left: 2px solid #6b7280;
      }
      
      /* Stats cards */
      .stat-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 1.5rem;
        transition: all 0.2s ease;
      }
      
      .stat-card:hover {
        border-color: var(--border-hover);
      }
      
      /* Button styling - minimal */
      .btn-primary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-hover);
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.875rem;
        letter-spacing: 0.025em;
        transition: all 0.2s ease;
        cursor: pointer;
      }
      
      .btn-primary:hover {
        background: var(--bg-secondary);
        border-color: var(--border-hover);
      }
      
      .btn-secondary {
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--border-hover);
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.875rem;
        letter-spacing: 0.025em;
        transition: all 0.2s ease;
        cursor: pointer;
      }
      
      .btn-secondary:hover {
        color: var(--text-primary);
        border-color: var(--border-hover);
      }
      
      /* Form elements */
      .input-field, select, textarea {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 0.75rem 1rem;
        border-radius: 4px;
        font-size: 0.875rem;
        transition: border-color 0.2s ease;
        width: 100%;
      }
      
      .input-field:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--border-hover);
      }
      
      textarea {
        resize: vertical;
      }
      
      /* Modal overlay */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }
      
      .modal-overlay.active {
        opacity: 1;
        pointer-events: all;
      }
      
      .modal-content {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        max-width: 900px;
        width: 100%;
        max-height: 85vh;
        overflow-y: auto;
        padding: 2rem;
        transition: transform 0.3s ease, max-width 0.3s ease;
      }
      
      /* Shift learning content left when module panel is open */
      #learning-overlay.module-open .modal-content {
        transform: translateX(-300px);
        max-width: 600px;
      }
      
      /* Progress bar */
      .progress-bar {
        background: #1a1a1a;
        height: 4px;
        border-radius: 2px;
        overflow: hidden;
      }
      
      .progress-fill {
        background: #4b5563;
        height: 100%;
        transition: width 0.3s ease;
      }
      
      /* Typography */
      .text-primary { color: #e5e5e5; }
      .text-secondary { color: #9ca3af; }
      .text-muted { color: #6b7280; }
      .text-success { color: #10b981; }
      .text-error { color: #ef4444; }
      
      /* Animations - minimal */
      .fade-in {
        animation: fadeIn 0.3s ease forwards;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      /* Scrollbar */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #222222; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #333333; }
      
      /* Mood selection grid */
      .mood-option {
        background: #111111;
        border: 1px solid #222222;
        border-radius: 4px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
      }
      
      .mood-option:hover {
        border-color: #444444;
      }
      
      .mood-option.selected {
        border-color: #10b981;
        background: #111111;
      }
      
      /* Live session indicator */
      .live-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #ef4444;
        border-radius: 50%;
        animation: pulse 2s ease-in-out infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
      }
      
      /* Calendar Styles */
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
        margin-top: 1rem;
      }
      
      .calendar-day {
        aspect-ratio: 1;
        background: #111111;
        border: 1px solid #222222;
        border-radius: 4px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
      }
      
      .calendar-day:hover {
        border-color: #444444;
      }
      
      .calendar-day.has-session {
        border-color: #4b5563;
      }
      
      .calendar-day.has-win {
        background: rgba(16, 185, 129, 0.1);
        border-color: #10b981;
      }
      
      .calendar-day.has-loss {
        background: rgba(239, 68, 68, 0.1);
        border-color: #ef4444;
      }
      
      .calendar-day.has-breakeven {
        background: rgba(107, 114, 128, 0.1);
        border-color: #6b7280;
      }
      
      .calendar-day-number {
        font-weight: 600;
        margin-bottom: 2px;
      }
      
      .calendar-day-indicator {
        font-size: 0.625rem;
        color: #6b7280;
      }
      
      .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        text-align: center;
      }
      
      .calendar-header-day {
        font-size: 0.75rem;
        color: #9ca3af;
        font-weight: 600;
        padding: 0.5rem;
      }
      
      /* Module Content Panel */
      .module-panel {
        position: fixed;
        right: -600px;
        top: 0;
        width: 600px;
        height: 100vh;
        background: #0a0a0a;
        border-left: 1px solid #222222;
        z-index: 1100;
        transition: right 0.3s ease;
        overflow-y: auto;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.5);
      }
      
      .module-panel.active {
        right: 0;
      }
      
      .module-panel-header {
        position: sticky;
        top: 0;
        background: #0a0a0a;
        border-bottom: 1px solid #222222;
        padding: 1.5rem;
        z-index: 10;
      }
      
      .module-panel-content {
        padding: 1.5rem;
      }
      
      .lesson-item {
        background: #111111;
        border: 1px solid #222222;
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        transition: all 0.2s ease;
        cursor: pointer;
      }
      
      .lesson-item:hover {
        border-color: #444444;
        background: #151515;
      }
      
      .lesson-item.active {
        border-color: #eab308;
        background: rgba(234, 179, 8, 0.05);
      }
      
      /* ===== NEW ENHANCEMENTS ===== */
      
      /* Toast Notifications */
      .toast-container {
        position: fixed;
        top: 5rem;
        right: 1.5rem;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        pointer-events: none;
      }
      
      .toast {
        background: #111111;
        border: 1px solid #222222;
        border-radius: 4px;
        padding: 1rem 1.25rem;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        pointer-events: all;
        animation: slideInRight 0.3s ease forwards;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      
      .toast.success { border-left: 3px solid #10b981; }
      .toast.error { border-left: 3px solid #ef4444; }
      .toast.info { border-left: 3px solid #3b82f6; }
      .toast.warning { border-left: 3px solid #f59e0b; }
      
      .toast.removing {
        animation: slideOutRight 0.3s ease forwards;
      }
      
      @keyframes slideInRight {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
      
      /* Tooltip System */
      .tooltip {
        position: relative;
        display: inline-block;
      }
      
      .tooltip .tooltiptext {
        visibility: hidden;
        background: #1a1a1a;
        color: #e5e5e5;
        text-align: center;
        border-radius: 4px;
        padding: 0.5rem 0.75rem;
        position: absolute;
        z-index: 1500;
        top: 125%;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-size: 0.75rem;
        border: 1px solid #333333;
        opacity: 0;
        transition: opacity 0.2s;
      }
      
      .tooltip .tooltiptext::after {
        content: "";
        position: absolute;
        bottom: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: transparent transparent #1a1a1a transparent;
      }
      
      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }
      
      /* Loading Skeleton */
      .skeleton {
        background: linear-gradient(90deg, #111111 25%, #1a1a1a 50%, #111111 75%);
        background-size: 200% 100%;
        animation: loading 1.5s ease-in-out infinite;
        border-radius: 4px;
      }
      
      @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }
      
      .skeleton-text {
        height: 1rem;
        margin: 0.5rem 0;
      }
      
      .skeleton-title {
        height: 1.5rem;
        width: 60%;
        margin-bottom: 1rem;
      }
      
      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: #111111;
        border: 1px dashed #333333;
        border-radius: 4px;
      }
      
      .empty-state-icon {
        font-size: 4rem;
        color: #333333;
        margin-bottom: 1rem;
      }
      
      /* Confirmation Dialog */
      .confirm-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #0a0a0a;
        border: 1px solid #222222;
        border-radius: 4px;
        padding: 2rem;
        max-width: 400px;
        z-index: 2100;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
      }
      
      /* Session Timer Display */
      .timer-display {
        font-family: 'IBM Plex Mono', monospace;
        font-size: 2rem;
        font-weight: 600;
        color: #10b981;
        text-align: center;
        padding: 1rem;
        background: #111111;
        border: 1px solid #222222;
        border-radius: 4px;
      }
      
      /* Export Menu */
      .export-menu {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 0.5rem;
        background: #111111;
        border: 1px solid #222222;
        border-radius: 4px;
        min-width: 200px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        opacity: 0;
        pointer-events: none;
        transform: translateY(-10px);
        transition: all 0.2s ease;
        z-index: 100;
      }
      
      .export-menu.active {
        opacity: 1;
        pointer-events: all;
        transform: translateY(0);
      }
      
      .export-menu-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.875rem;
      }
      
      .export-menu-item:hover {
        background: #1a1a1a;
      }
      
      /* Theme Toggle */
      .theme-toggle {
        background: #1a1a1a;
        border: 1px solid #333333;
        border-radius: 20px;
        padding: 0.25rem;
        display: flex;
        gap: 0.25rem;
        cursor: pointer;
      }
      
      .theme-option {
        padding: 0.375rem 0.75rem;
        border-radius: 16px;
        font-size: 0.75rem;
        transition: all 0.2s ease;
      }
      
      .theme-option.active {
        background: #10b981;
        color: #fff;
      }
      
      /* Quick Stats Badge */
      .quick-stat {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        background: #111111;
        border: 1px solid #222222;
        border-radius: 12px;
        font-size: 0.75rem;
      }
      
      .quick-stat-value {
        font-family: 'IBM Plex Mono', monospace;
        font-weight: 600;
        color: #10b981;
      }
      
      /* Keyboard Shortcut Hint */
      .kbd {
        display: inline-block;
        padding: 0.125rem 0.375rem;
        font-size: 0.75rem;
        font-family: 'IBM Plex Mono', monospace;
        background: #1a1a1a;
        border: 1px solid #333333;
        border-radius: 3px;
        color: #9ca3af;
      }
      
      /* Progress Ring (for analytics) */
      .progress-ring {
        transform: rotate(-90deg);
      }
      
      .progress-ring-circle {
        transition: stroke-dashoffset 0.5s ease;
      }
      
      /* Mobile Responsiveness */
      @media (max-width: 1024px) {
        .modal-content {
          max-width: 90vw;
          max-height: 90vh;
        }
        
        .module-panel {
          width: 100%;
          right: -100%;
        }
      }
      
      @media (max-width: 768px) {
        .grid-cols-4 {
          grid-template-columns: repeat(2, 1fr);
        }
        
        .grid-cols-3 {
          grid-template-columns: repeat(1, 1fr);
        }
        
        .modal-content {
          padding: 1rem;
          max-width: 95vw;
        }
        
        footer .grid-cols-1.md\\:grid-cols-4 {
          grid-template-columns: 1fr;
        }
        
        .toast {
          min-width: auto;
          width: calc(100vw - 3rem);
        }
        
        .toast-container {
          right: 1rem;
          left: 1rem;
        }
        
        .timer-display {
          font-size: 1.5rem;
        }
        
        header .flex.items-center.gap-4 {
          flex-direction: column;
          align-items: flex-end;
          gap: 0.5rem;
        }
      }
      
      @media (max-width: 640px) {
        .stat-card {
          padding: 1rem;
        }
        
        .grid-cols-2 {
          grid-template-columns: 1fr;
        }
        
        .quick-stat {
          font-size: 0.625rem;
          padding: 0.25rem 0.5rem;
        }
      }
      
      /* Focus visible for accessibility */
      button:focus-visible,
      a:focus-visible,
      input:focus-visible,
      select:focus-visible,
      textarea:focus-visible {
        outline: 2px solid #10b981;
        outline-offset: 2px;
      }
      
      /* Smooth page transitions */
      .page-transition {
        animation: fadeInUp 0.3s ease forwards;
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* Enhanced hover states */
      .stat-card:hover,
      .session-card:hover,
      .help-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      
      /* Loading overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      
      .loading-overlay.active {
        opacity: 1;
        pointer-events: all;
      }
      
      /* Enhanced spinner */
      .spinner-large {
        border: 3px solid #222222;
        border-top: 3px solid #10b981;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        animation: spin 1s linear infinite;
      }
      
      /* ===== ULTIMATE ENHANCEMENTS ===== */
      
      /* Welcome Tour */
      .welcome-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      
      .welcome-overlay.active {
        opacity: 1;
        pointer-events: all;
      }
      
      .welcome-card {
        background: #111111;
        border: 1px solid #222222;
        border-radius: 8px;
        padding: 3rem;
        max-width: 600px;
        text-align: center;
        animation: scaleIn 0.4s ease;
      }
      
      @keyframes scaleIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }
      
      .welcome-icon {
        font-size: 4rem;
        margin-bottom: 1.5rem;
      }
      
      .tour-step {
        position: absolute;
        background: #111111;
        border: 2px solid #10b981;
        border-radius: 8px;
        padding: 1.5rem;
        max-width: 300px;
        z-index: 10001;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
        animation: bounceIn 0.4s ease;
      }
      
      @keyframes bounceIn {
        0% { transform: scale(0.8); opacity: 0; }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); opacity: 1; }
      }
      
      .tour-arrow {
        position: absolute;
        width: 0;
        height: 0;
        border-style: solid;
      }
      
      .tour-arrow.top {
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        border-width: 0 10px 10px 10px;
        border-color: transparent transparent #10b981 transparent;
      }
      
      .tour-arrow.bottom {
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        border-width: 10px 10px 0 10px;
        border-color: #10b981 transparent transparent transparent;
      }
      
      /* Achievement System */
      .achievement-card {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%);
        border: 1px solid #10b981;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        position: relative;
        overflow: hidden;
      }
      
      .achievement-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        animation: shimmer 2s infinite;
      }
      
      @keyframes shimmer {
        100% { left: 100%; }
      }
      
      .achievement-locked {
        background: #111111;
        border: 1px solid #333333;
        opacity: 0.6;
      }
      
      .achievement-locked::before {
        display: none;
      }
      
      .achievement-icon {
        font-size: 3rem;
        display: inline-block;
        margin-bottom: 0.5rem;
      }
      
      .achievement-progress {
        width: 100%;
        height: 6px;
        background: #1a1a1a;
        border-radius: 3px;
        overflow: hidden;
        margin-top: 0.5rem;
      }
      
      .achievement-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #059669);
        border-radius: 3px;
        transition: width 0.5s ease;
      }
      
      /* EdgeScore Display */
      .edge-score-card {
        background: linear-gradient(135deg, #111111 0%, #1a1a1a 100%);
        border: 1px solid #222222;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
      }
      
      .score-circle {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto 1.5rem;
      }
      
      .score-circle svg {
        transform: rotate(-90deg);
      }
      
      .score-circle .score {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3.5rem;
        font-weight: 700;
        font-family: 'IBM Plex Mono', monospace;
      }
      
      .score-breakdown {
        margin-top: 1.5rem;
        text-align: left;
      }
      
      .score-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      
      .score-item span:first-child {
        min-width: 100px;
        font-size: 0.875rem;
        color: #9ca3af;
      }
      
      .score-bar {
        flex: 1;
        height: 8px;
        background: #1a1a1a;
        border-radius: 4px;
        overflow: hidden;
      }
      
      .score-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #059669);
        border-radius: 4px;
        transition: width 0.8s ease;
      }
      
      .score-item span:last-child {
        min-width: 50px;
        text-align: right;
        font-family: 'IBM Plex Mono', monospace;
        font-size: 0.875rem;
      }
      
      /* P&L Charts */
      .pnl-card {
        background: #111111;
        border: 1px solid #222222;
        border-radius: 8px;
        padding: 1.5rem;
      }
      
      .pnl-summary {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1rem;
      }
      
      .pnl-stat {
        text-align: center;
        padding: 1rem;
        background: #0a0a0a;
        border-radius: 4px;
      }
      
      .pnl-value {
        font-size: 1.5rem;
        font-weight: 700;
        font-family: 'IBM Plex Mono', monospace;
        margin-top: 0.5rem;
      }
      
      .pnl-value.positive {
        color: #10b981;
      }
      
      .pnl-value.negative {
        color: #ef4444;
      }
      
      /* Quick Log Modal */
      .quick-log-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #0a0a0a;
        border: 1px solid #222222;
        border-radius: 8px;
        padding: 2rem;
        max-width: 400px;
        width: 90%;
        z-index: 2000;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
      }
      
      .quick-outcomes {
        display: flex;
        gap: 1rem;
        margin: 1.5rem 0;
      }
      
      .quick-outcome-btn {
        flex: 1;
        padding: 2rem 1rem;
        background: #111111;
        border: 2px solid #222222;
        border-radius: 8px;
        font-size: 2rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .quick-outcome-btn:hover {
        transform: translateY(-4px);
        border-color: #444444;
      }
      
      .quick-outcome-btn.win {
        color: #10b981;
      }
      
      .quick-outcome-btn.win:hover,
      .quick-outcome-btn.win.selected {
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.1);
      }
      
      .quick-outcome-btn.loss {
        color: #ef4444;
      }
      
      .quick-outcome-btn.loss:hover,
      .quick-outcome-btn.loss.selected {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
      }
      
      .quick-outcome-btn.breakeven {
        color: #6b7280;
      }
      
      .quick-outcome-btn.breakeven:hover,
      .quick-outcome-btn.breakeven.selected {
        border-color: #6b7280;
        background: rgba(107, 114, 128, 0.1);
      }
      
      /* Confetti Canvas */
      #confetti-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
      }
      
      /* Monthly Report */
      .report-card {
        background: #111111;
        border: 1px solid #222222;
        border-radius: 8px;
        padding: 2rem;
        margin-bottom: 1.5rem;
      }
      
      .report-header {
        border-bottom: 2px solid #10b981;
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
      }
      
      .report-stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin: 1.5rem 0;
      }
      
      .report-stat {
        text-align: center;
      }
      
      .report-stat-value {
        font-size: 2rem;
        font-weight: 700;
        font-family: 'IBM Plex Mono', monospace;
        color: #10b981;
        margin-top: 0.5rem;
      }
      
      .report-insights {
        background: rgba(16, 185, 129, 0.05);
        border-left: 3px solid #10b981;
        padding: 1rem 1.5rem;
        margin: 1.5rem 0;
      }
      
      .report-goals {
        list-style: none;
        padding: 0;
      }
      
      .report-goals li {
        padding: 0.75rem 0;
        border-bottom: 1px solid #222222;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      
      .report-goals li:last-child {
        border-bottom: none;
      }
      
      /* Streak Visualization */
      .streak-display {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%);
        border: 1px solid #ef4444;
        border-radius: 8px;
        font-weight: 600;
      }
      
      .streak-fire {
        display: inline-block;
        animation: flicker 1.5s ease-in-out infinite;
      }
      
      .streak-fire.small { font-size: 1.25rem; }
      .streak-fire.medium { font-size: 1.75rem; }
      .streak-fire.large { font-size: 2.5rem; }
      
      @keyframes flicker {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.8; transform: scale(1.1); }
      }
      
      .streak-calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
        margin-top: 1rem;
      }
      
      .streak-day {
        aspect-ratio: 1;
        background: #111111;
        border: 1px solid #222222;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
      }
      
      .streak-day.logged {
        background: rgba(16, 185, 129, 0.2);
        border-color: #10b981;
      }
      
      .streak-day.today {
        border-color: #3b82f6;
        border-width: 2px;
      }
      
      /* Journal Prompt */
      .journal-prompt {
        background: linear-gradient(135deg, rgba(234, 179, 8, 0.1) 0%, rgba(202, 138, 4, 0.05) 100%);
        border: 1px solid #eab308;
        border-radius: 8px;
        padding: 1rem 1.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      
      .journal-prompt iconify-icon {
        color: #eab308;
        font-size: 1.5rem;
      }
      
      /* Pattern Alert */
      .pattern-alert {
        background: #111111;
        border-left: 3px solid #f59e0b;
        border-radius: 4px;
        padding: 1rem 1.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: start;
        gap: 1rem;
        animation: slideInLeft 0.4s ease;
      }
      
      @keyframes slideInLeft {
        from { transform: translateX(-20px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      
      .pattern-alert.warning {
        border-color: #ef4444;
      }
      
      .pattern-alert.success {
        border-color: #10b981;
      }
      
      .pattern-alert.info {
        border-color: #3b82f6;
      }
      
      /* Beginner Mode Toggle */
      .mode-toggle {
        background: #111111;
        border: 1px solid #222222;
        border-radius: 20px;
        padding: 0.25rem;
        display: inline-flex;
        gap: 0.25rem;
      }
      
      .mode-option {
        padding: 0.5rem 1rem;
        border-radius: 16px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .mode-option.active {
        background: #10b981;
        color: #fff;
        font-weight: 600;
      }
      
      /* Advanced Analytics Charts */
      .analytics-section {
        margin-bottom: 2rem;
      }
      
      .chart-container {
        background: #111111;
        border: 1px solid #222222;
        border-radius: 8px;
        padding: 1.5rem;
        height: 300px;
      }
      
      .comparison-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }
      
      .comparison-card {
        background: #111111;
        border: 1px solid #222222;
        border-radius: 4px;
        padding: 1rem;
        text-align: center;
      }
      
      .comparison-value {
        font-size: 1.5rem;
        font-weight: 700;
        font-family: 'IBM Plex Mono', monospace;
        margin: 0.5rem 0;
      }
      
      /* Mobile Optimizations for New Features */
      @media (max-width: 768px) {
        .welcome-card {
          padding: 2rem 1.5rem;
          margin: 1rem;
        }
        
        .score-circle {
          width: 150px;
          height: 150px;
        }
        
        .score-circle .score {
          font-size: 2.5rem;
        }
        
        .pnl-summary {
          grid-template-columns: 1fr;
        }
        
        .report-stats-grid {
          grid-template-columns: 1fr;
        }
        
        .quick-outcomes {
          flex-direction: column;
        }
        
        .achievement-icon {
          font-size: 2rem;
        }
      }
      
      /* Day History Panel */
      .day-history-panel {
        display: none;
        background: #111111;
        border: 1px solid #222222;
        border-radius: 8px;
        padding: 2rem;
        margin-top: 2rem;
        max-width: 100%;
      }
      
      .day-history-panel.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }
      
      .session-detail-card {
        background: #0a0a0a;
        border: 1px solid #222222;
        border-radius: 4px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.2s ease;
      }
      
      .session-detail-card:hover {
        border-color: #333333;
      }
      
      /* Session Detail Modal */
      .session-detail-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 2000;
        padding: 2rem;
        overflow-y: auto;
      }
      
      .session-detail-modal.active {
        display: flex;
        align-items: flex-start;
        justify-content: center;
      }
      
      .session-detail-content {
        background: #0a0a0a;
        border: 1px solid #222222;
        border-radius: 8px;
        max-width: 900px;
        width: 100%;
        margin: auto;
        padding: 2rem;
        animation: fadeIn 0.3s ease;
      }
      
      @media (max-width: 768px) {
        .session-detail-content {
          padding: 1.5rem;
        }
        
        .day-history-panel {
          padding: 1.5rem;
        }
      }
    </style>
</head>
<body>
    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-large mx-auto mb-4"></div>
            <div class="loading-message text-sm text-secondary">Loading...</div>
        </div>
    </div>
    
    <!-- ===== NEW ULTIMATE FEATURES ===== -->
    
    <!-- Confetti Canvas -->
    <canvas id="confetti-canvas"></canvas>
    
    <!-- Welcome Tour Overlay -->
    <div id="welcome-overlay" class="welcome-overlay">
        <div class="welcome-card">
            <div class="welcome-icon">üéØ</div>
            <h1 class="text-3xl font-bold mb-4">Welcome to EdgeMetrics!</h1>
            <p class="text-secondary mb-6">
                Your AI-powered trading journal for consistent performance improvement.
                Let's take a quick tour to get you started.
            </p>
            <div class="flex gap-4 justify-center">
                <button onclick="app.startTour()" class="btn-primary">
                    Start Tour (2 minutes)
                </button>
                <button onclick="app.skipTour()" class="btn-secondary">
                    Skip, I'll Explore
                </button>
            </div>
        </div>
    </div>
    
    <!-- Quick Log Modal (Ctrl+Q) -->
    <div id="quick-log-overlay" class="modal-overlay">
        <div class="quick-log-modal">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">Quick Log Session</h2>
                <button onclick="app.closeQuickLog()" class="text-secondary hover:text-primary" aria-label="Close quick log">
                    <iconify-icon icon="solar:close-circle-bold" width="24"></iconify-icon>
                </button>
            </div>
            
            <div class="quick-outcomes">
                <button class="quick-outcome-btn win" onclick="app.selectQuickOutcome('win')">
                    <div>W</div>
                    <div style="font-size: 0.75rem; margin-top: 0.5rem;">Win</div>
                </button>
                <button class="quick-outcome-btn loss" onclick="app.selectQuickOutcome('loss')">
                    <div>L</div>
                    <div style="font-size: 0.75rem; margin-top: 0.5rem;">Loss</div>
                </button>
                <button class="quick-outcome-btn breakeven" onclick="app.selectQuickOutcome('breakeven')">
                    <div>BE</div>
                    <div style="font-size: 0.75rem; margin-top: 0.5rem;">Break Even</div>
                </button>
            </div>
            
            <div class="space-y-3">
                <select id="quick-instrument" class="input-field" onchange="if(this.value && app.quickOutcome) document.getElementById('quick-save-btn').disabled = false;">
                    <option value="">Select Instrument</option>
                </select>
                <input type="number" id="quick-pnl" placeholder="P&L (optional)" class="input-field" step="0.01">
                <textarea id="quick-note" placeholder="Quick note (optional)" class="input-field" rows="2"></textarea>
                <button onclick="app.saveQuickLog()" class="btn-primary w-full" disabled id="quick-save-btn">
                    Save Session
                </button>
            </div>
            
            <div class="text-xs text-muted text-center mt-3">
                Keyboard: W = Win, L = Loss, B = Breakeven, Enter = Save
            </div>
        </div>
    </div>
    
    <!-- Achievements Overlay -->
    <div id="achievements-overlay" class="modal-overlay">
        <div class="modal-content" style="max-width: 900px;">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-semibold">üèÜ Your Achievements</h2>
                    <p class="text-sm text-secondary mt-1">Track your progress and unlock rewards</p>
                </div>
                <button onclick="app.closeAchievements()" class="text-secondary hover:text-primary" aria-label="Close achievements">
                    <iconify-icon icon="solar:close-circle-bold" width="28"></iconify-icon>
                </button>
            </div>
            
            <div id="achievements-container"></div>
        </div>
    </div>
    
    <!-- EdgeScore Overlay -->
    <div id="edgescore-overlay" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-semibold">Your EdgeScore‚Ñ¢</h2>
                <button onclick="app.closeEdgeScore()" class="text-secondary hover:text-primary" aria-label="Close EdgeScore">
                    <iconify-icon icon="solar:close-circle-bold" width="28"></iconify-icon>
                </button>
            </div>
            
            <div class="edge-score-card">
                <div class="score-circle">
                    <svg width="200" height="200">
                        <circle cx="100" cy="100" r="85" stroke="#222222" stroke-width="12" fill="none"></circle>
                        <circle id="score-ring" cx="100" cy="100" r="85" stroke="#10b981" stroke-width="12" fill="none"
                                stroke-dasharray="534" stroke-dashoffset="534" stroke-linecap="round"></circle>
                    </svg>
                    <div class="score" id="edge-score-value">0</div>
                </div>
                
                <h3 class="text-lg font-semibold mb-4">Score Breakdown</h3>
                
                <div class="score-breakdown" id="score-breakdown"></div>
                
                <div class="mt-6 p-4 bg-[#0a0a0a] rounded border border-[#222222]">
                    <h4 class="font-semibold mb-2">How to Improve</h4>
                    <ul class="text-sm text-secondary space-y-1" id="improvement-tips">
                        <li>‚Ä¢ Loading...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Monthly Report Overlay -->
    <div id="report-overlay" class="modal-overlay">
        <div class="modal-content" style="max-width: 900px;">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-semibold">üìä Monthly Report Card</h2>
                <button onclick="app.closeReport()" class="text-secondary hover:text-primary" aria-label="Close report">
                    <iconify-icon icon="solar:close-circle-bold" width="28"></iconify-icon>
                </button>
            </div>
            
            <div id="monthly-report-content"></div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="bg-[#111111] border-b border-[#222222] sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="logo-container">
                    <div class="logo-icon">E</div>
                    <div>
                        <h1 class="text-xl font-semibold tracking-tight">EdgeMetrics</h1>
                        <p class="text-xs text-secondary">Trading Journal</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Quick Stats -->
                    <div class="hidden md:flex items-center gap-2">
                        <span class="quick-stat tooltip">
                            <iconify-icon icon="solar:calendar-bold" width="14" class="text-secondary"></iconify-icon>
                            <span class="text-muted">Today:</span>
                            <span class="quick-stat-value" id="header-today-sessions">0</span>
                            <span class="tooltiptext">Sessions completed today</span>
                        </span>
                        <span class="quick-stat tooltip">
                            <iconify-icon icon="solar:fire-bold" width="14" class="text-secondary"></iconify-icon>
                            <span class="text-muted">Streak:</span>
                            <span class="quick-stat-value" id="header-win-streak">0</span>
                            <span class="tooltiptext">Current win streak</span>
                        </span>
                    </div>
                    
                    <!-- Export Menu -->
                    <div class="relative">
                        <button onclick="app.toggleExportMenu()" class="btn-secondary px-3 py-2 text-xs tooltip">
                            <iconify-icon icon="solar:download-bold" width="16"></iconify-icon>
                            <span class="tooltiptext">Export data <span class="kbd">Ctrl+E</span></span>
                        </button>
                        <div id="export-menu" class="export-menu">
                            <div class="export-menu-item" onclick="app.exportToJSON()">
                                <iconify-icon icon="solar:file-text-bold" width="16"></iconify-icon>
                                Export as JSON
                            </div>
                            <div class="export-menu-item" onclick="app.exportToCSV()">
                                <iconify-icon icon="solar:document-bold" width="16"></iconify-icon>
                                Export as CSV
                            </div>
                            <!-- NEW: PDF Export -->
                            <div class="export-menu-item" onclick="app.exportToPDF()">
                                <iconify-icon icon="solar:file-download-bold" width="16"></iconify-icon>
                                Export as PDF Report
                            </div>
                            <div class="export-menu-item" onclick="app.importData()">
                                <iconify-icon icon="solar:upload-bold" width="16"></iconify-icon>
                                Import Data
                            </div>
                            <div class="border-t border-[#222222] my-1"></div>
                            <div class="export-menu-item" onclick="app.showMonthlyReport()">
                                <iconify-icon icon="solar:document-text-bold" width="16"></iconify-icon>
                                Monthly Report
                            </div>
                            <div class="border-t border-[#222222] my-1"></div>
                            <div class="export-menu-item text-error" onclick="app.clearAllData()">
                                <iconify-icon icon="solar:trash-bin-2-bold" width="16"></iconify-icon>
                                Clear All History
                            </div>
                        </div>
                    </div>
                    
                    <!-- NEW: Theme Customization Menu -->
                    <div class="relative">
                        <button onclick="app.toggleThemeMenu()" class="btn-secondary px-3 py-2 text-xs tooltip" id="theme-toggle">
                            <iconify-icon icon="solar:pallete-2-bold" width="16" id="theme-icon"></iconify-icon>
                            <span class="tooltiptext">Theme Settings</span>
                        </button>
                        
                        <div id="theme-menu" class="hidden absolute right-0 mt-2 bg-[#0a0a0a] border border-[#222] rounded shadow-xl p-4 z-50" style="width: 260px;">
                            <div class="text-sm font-semibold mb-3">üé® Theme Settings</div>
                            
                            <div class="space-y-2 mb-4">
                                <label class="flex items-center justify-between p-2 hover:bg-[#1a1a1a] rounded cursor-pointer">
                                    <span class="text-sm">üåô Dark Mode</span>
                                    <input type="radio" name="theme" value="dark" checked onchange="app.setTheme('dark')" class="accent-green-500">
                                </label>
                                
                                <label class="flex items-center justify-between p-2 hover:bg-[#1a1a1a] rounded cursor-pointer">
                                    <span class="text-sm">‚òÄÔ∏è Light Mode</span>
                                    <input type="radio" name="theme" value="light" onchange="app.setTheme('light')" class="accent-green-500">
                                </label>
                                
                                <label class="flex items-center justify-between p-2 hover:bg-[#1a1a1a] rounded cursor-pointer">
                                    <span class="text-sm">‚öôÔ∏è Auto (System)</span>
                                    <input type="radio" name="theme" value="auto" onchange="app.setTheme('auto')" class="accent-green-500">
                                </label>
                            </div>
                            
                            <div class="border-t border-[#222] pt-3 mb-3">
                                <div class="text-xs text-secondary mb-2">Accent Color</div>
                                <div class="grid grid-cols-5 gap-2">
                                    <button onclick="app.setAccentColor('green')" class="w-8 h-8 rounded bg-green-500 hover:ring-2 ring-green-400" title="Green (Default)"></button>
                                    <button onclick="app.setAccentColor('blue')" class="w-8 h-8 rounded bg-blue-500 hover:ring-2 ring-blue-400" title="Blue"></button>
                                    <button onclick="app.setAccentColor('purple')" class="w-8 h-8 rounded bg-purple-500 hover:ring-2 ring-purple-400" title="Purple"></button>
                                    <button onclick="app.setAccentColor('orange')" class="w-8 h-8 rounded bg-orange-500 hover:ring-2 ring-orange-400" title="Orange"></button>
                                    <button onclick="app.setAccentColor('pink')" class="w-8 h-8 rounded bg-pink-500 hover:ring-2 ring-pink-400" title="Pink"></button>
                                </div>
                            </div>
                            
                            <div class="border-t border-[#222] pt-3">
                                <div class="text-xs text-secondary mb-2">Preferences</div>
                                <label class="flex items-center justify-between p-2 hover:bg-[#1a1a1a] rounded cursor-pointer">
                                    <span class="text-xs">Reduced Motion</span>
                                    <input type="checkbox" id="reduced-motion" onchange="app.toggleReducedMotion()" class="accent-green-500">
                                </label>
                                <label class="flex items-center justify-between p-2 hover:bg-[#1a1a1a] rounded cursor-pointer">
                                    <span class="text-xs">High Contrast</span>
                                    <input type="checkbox" id="high-contrast" onchange="app.toggleHighContrast()" class="accent-green-500">
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- EdgeScore Button -->
                    <button onclick="app.showEdgeScore()" class="btn-secondary px-3 py-2 text-xs tooltip">
                        <iconify-icon icon="solar:star-bold" width="16"></iconify-icon>
                        <span id="header-edge-score" class="ml-1 font-mono">0</span>
                        <span class="tooltiptext">Your EdgeScore‚Ñ¢</span>
                    </button>
                    
                    <!-- Achievements Button -->
                    <button onclick="app.showAchievements()" class="btn-secondary px-3 py-2 text-xs tooltip">
                        <iconify-icon icon="solar:cup-star-bold" width="16"></iconify-icon>
                        <span class="tooltiptext">View Achievements <span class="kbd">Ctrl+H</span></span>
                    </button>
                    
                    <span class="ai-badge">
                        <span class="ai-pulse"></span>
                        AI Ready
                    </span>
                    <div class="text-sm text-secondary font-mono" id="user-stats">Loading...</div>
                </div>
            </div>
        </div>
    </header>

    <!-- NEW: Data Warning Banner (shows once on first visit) -->
    <div id="data-warning-banner" class="bg-yellow-900/20 border-b border-yellow-700/30" style="display: none;">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <iconify-icon icon="solar:danger-triangle-bold" class="text-yellow-500" width="20"></iconify-icon>
                    <p class="text-sm text-yellow-200">
                        <strong>Data Storage Notice:</strong> Your journal is stored locally in your browser. 
                        <a href="#" onclick="app.exportData(); return false;" class="underline hover:text-yellow-100">Export regularly</a> to backup your data.
                    </p>
                </div>
                <button onclick="document.getElementById('data-warning-banner').style.display='none'; localStorage.setItem('edgemetrics-banner-dismissed', 'true');" class="text-yellow-500 hover:text-yellow-300">
                    <iconify-icon icon="solar:close-circle-bold" width="20"></iconify-icon>
                </button>
            </div>
        </div>
    </div>

    <!-- NEW: Advanced Toolbar with Search, Filters, and Quick Actions -->
    <div class="bg-[#0d0d0d] border-b border-[#222222]">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                <!-- Search Bar -->
                <div class="flex-1 max-w-md w-full">
                    <div class="relative">
                        <iconify-icon icon="solar:magnifer-linear" class="absolute left-3 top-1/2 -translate-y-1/2 text-muted" width="18"></iconify-icon>
                        <input 
                            type="text" 
                            id="search-input"
                            placeholder="Search sessions... (Ctrl+F)" 
                            class="input-field pl-10 pr-24 w-full"
                            oninput="app.searchSessions(this.value)"
                        >
                        <!-- NEW: Advanced Search Toggle -->
                        <button onclick="app.toggleAdvancedSearch()" class="absolute right-12 top-1/2 -translate-y-1/2 text-muted hover:text-primary transition-colors" title="Advanced Search">
                            <iconify-icon icon="solar:settings-linear" width="18"></iconify-icon>
                        </button>
                        <div id="search-results-count" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-muted hidden"></div>
                    </div>
                    
                    <!-- NEW: Advanced Search Panel -->
                    <div id="advanced-search" class="hidden absolute mt-2 p-4 bg-[#111] border border-[#222] rounded shadow-xl z-50" style="width: 100%; max-width: 400px;">
                        <div class="flex items-center justify-between mb-3">
                            <div class="font-semibold text-sm">üîç Advanced Search</div>
                            <button onclick="app.toggleAdvancedSearch()" class="text-muted hover:text-primary">
                                <iconify-icon icon="solar:close-circle-linear" width="20"></iconify-icon>
                            </button>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-secondary mb-1 block">Date Range</label>
                                <div class="flex gap-2">
                                    <input type="date" id="search-date-from" class="input-field text-xs py-1">
                                    <input type="date" id="search-date-to" class="input-field text-xs py-1">
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-xs text-secondary mb-1 block">P&L Range</label>
                                <div class="flex gap-2">
                                    <input type="number" id="search-pnl-min" placeholder="Min $" class="input-field text-xs py-1">
                                    <input type="number" id="search-pnl-max" placeholder="Max $" class="input-field text-xs py-1">
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-xs text-secondary mb-1 block">Mood</label>
                                <select id="search-mood" class="input-field text-xs py-1">
                                    <option value="">All Moods</option>
                                    <option value="focused">Focused</option>
                                    <option value="confident">Confident</option>
                                    <option value="anxious">Anxious</option>
                                    <option value="excited">Excited</option>
                                    <option value="tired">Tired</option>
                                    <option value="neutral">Neutral</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="text-xs text-secondary mb-1 block">Tags</label>
                                <input type="text" id="search-tags" placeholder="Search by tags" class="input-field text-xs py-1">
                            </div>
                            
                            <div class="flex gap-2 pt-2">
                                <button onclick="app.applyAdvancedSearch()" class="btn-primary flex-1 text-xs py-2">Apply Filters</button>
                                <button onclick="app.clearAdvancedSearch()" class="btn-secondary flex-1 text-xs py-2">Clear All</button>
                            </div>
                            
                            <div class="border-t border-[#222] pt-3">
                                <div class="flex items-center justify-between mb-2">
                                    <label class="text-xs text-secondary">üíæ Saved Filters</label>
                                    <button onclick="app.saveCurrentFilter()" class="text-xs text-green-500 hover:underline">+ Save</button>
                                </div>
                                <div id="saved-filters" class="space-y-1 max-h-32 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Filters & Actions -->
                <div class="flex flex-wrap gap-3 w-full lg:w-auto">
                    <!-- Outcome Filter -->
                    <select id="outcome-filter" class="input-field w-auto min-w-[140px]" onchange="app.filterByOutcome(this.value)">
                        <option value="all">All Outcomes</option>
                        <option value="win">‚úì Win</option>
                        <option value="loss">‚úó Loss</option>
                        <option value="breakeven">= Breakeven</option>
                        <option value="no-trade">‚óã No Trade</option>
                    </select>
                    
                    <!-- Instrument Filter -->
                    <select id="instrument-filter" class="input-field w-auto min-w-[140px]" onchange="app.filterByInstrument(this.value)">
                        <option value="all">All Instruments</option>
                    </select>
                    
                    <!-- Clear Filters -->
                    <button onclick="app.clearFilters()" class="btn-secondary px-3 tooltip">
                        <iconify-icon icon="solar:restart-bold" width="18"></iconify-icon>
                        <span class="tooltiptext">Clear all filters</span>
                    </button>
                    
                    <!-- Analytics -->
                    <button onclick="app.showAdvancedAnalytics()" class="btn-secondary text-xs px-3 tooltip">
                        <iconify-icon icon="solar:chart-2-bold" width="16" class="inline mr-1"></iconify-icon>
                        <span class="hidden sm:inline">Analytics</span>
                        <span class="tooltiptext">View advanced analytics</span>
                    </button>
                </div>
            </div>
            
            <!-- Active Filters Display -->
            <div id="active-filters" class="mt-3 flex flex-wrap gap-2" style="display: none;">
                <span class="text-xs text-muted">Active filters:</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="view-dashboard" class="max-w-7xl mx-auto px-6 py-8">
        <!-- Action Buttons -->
        <div class="grid grid-cols-3 gap-4 mb-8">
            <button onclick="app.startSession()" class="btn-primary tooltip">
                <iconify-icon icon="solar:play-bold" width="20" class="inline mr-2"></iconify-icon>
                Start Session
                <span class="tooltiptext">Start new trading session <span class="kbd">Ctrl+N</span></span>
            </button>
            <button onclick="app.showAnalytics()" class="btn-secondary tooltip">
                <iconify-icon icon="solar:chart-bold" width="20" class="inline mr-2"></iconify-icon>
                Analytics
                <span class="tooltiptext">View performance analytics <span class="kbd">Ctrl+A</span></span>
            </button>
            <button onclick="app.showLearning()" class="btn-secondary tooltip">
                <iconify-icon icon="solar:book-bold" width="20" class="inline mr-2"></iconify-icon>
                Learning
                <span class="tooltiptext">Access learning resources <span class="kbd">Ctrl+L</span></span>
            </button>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-4 gap-4 mb-8">
            <div class="stat-card tooltip">
                <div class="text-muted text-xs font-medium uppercase tracking-wider mb-2">Total Sessions</div>
                <div class="text-2xl font-semibold font-mono" id="total-sessions">0</div>
                <span class="tooltiptext">Total number of trading sessions logged</span>
            </div>
            <div class="stat-card tooltip">
                <div class="text-muted text-xs font-medium uppercase tracking-wider mb-2">Win Rate</div>
                <div class="text-2xl font-semibold font-mono" id="win-rate">0%</div>
                <span class="tooltiptext">Percentage of winning sessions</span>
            </div>
            <div class="stat-card tooltip">
                <div class="text-muted text-xs font-medium uppercase tracking-wider mb-2">Avg Duration</div>
                <div class="text-2xl font-semibold font-mono" id="avg-duration">0m</div>
                <span class="tooltiptext">Average session duration in minutes</span>
            </div>
            <div class="stat-card tooltip">
                <div class="text-muted text-xs font-medium uppercase tracking-wider mb-2">Rule Score</div>
                <div class="text-2xl font-semibold font-mono" id="rule-score">0%</div>
                <span class="tooltiptext">Percentage of sessions without rule violations</span>
            </div>
        </div>

        <!-- Pattern Alerts (AI Insights) -->
        <div id="pattern-alerts" class="mb-8"></div>
        
        <!-- P&L Tracking Card -->
        <div class="pnl-card mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Performance & P/L</h3>
                <div class="flex gap-2">
                    <button onclick="app.updatePnL(); app.showToast('P&L refreshed', 'info');" class="text-xs text-secondary hover:text-primary" title="Refresh P&L">
                        <iconify-icon icon="solar:refresh-bold" width="16"></iconify-icon>
                    </button>
                    <button onclick="app.showPnLDetails()" class="text-xs text-secondary hover:text-primary">
                        View Details ‚Üí
                    </button>
                </div>
            </div>
            <div class="pnl-summary">
                <div class="pnl-stat">
                    <div class="text-xs text-muted uppercase">Today</div>
                    <div class="pnl-value" id="pnl-today">$0</div>
                </div>
                <div class="pnl-stat">
                    <div class="text-xs text-muted uppercase">This Week</div>
                    <div class="pnl-value" id="pnl-week">$0</div>
                </div>
                <div class="pnl-stat">
                    <div class="text-xs text-muted uppercase">This Month</div>
                    <div class="pnl-value" id="pnl-month">$0</div>
                </div>
            </div>
            <div style="height: 200px; margin-top: 1rem;">
                <canvas id="pnl-chart"></canvas>
            </div>
        </div>
        
        <!-- Journal Prompt of the Day -->
        <div id="journal-prompt" class="journal-prompt">
            <iconify-icon icon="solar:lightbulb-bolt-bold"></iconify-icon>
            <div>
                <div class="font-semibold text-sm mb-1">Reflection Prompt</div>
                <div class="text-sm text-secondary" id="prompt-text">Loading...</div>
            </div>
        </div>
        
        <!-- NEW: Predictive AI Insights Section -->
        <div class="mb-8" id="predictive-insights-section">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">üîÆ AI Insights & Predictions</h2>
                <button onclick="app.refreshPredictiveInsights()" class="btn-secondary text-xs px-3 py-2">
                    <iconify-icon icon="solar:refresh-bold" width="14"></iconify-icon>
                    Refresh
                </button>
            </div>
            <div id="predictive-insights" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Insights will be populated here -->
            </div>
        </div>
        
        <!-- Recent Sessions -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">Recent Sessions</h2>
                <button onclick="app.showAllSessions()" class="btn-secondary text-xs px-3 py-2">View All</button>
            </div>
            <div class="space-y-3" id="recent-sessions">
                <!-- Empty state will be shown if no sessions -->
                <div id="empty-sessions-state" class="empty-state hidden">
                    <div class="empty-state-icon">
                        <iconify-icon icon="solar:chart-2-bold"></iconify-icon>
                    </div>
                    <h3 class="text-lg font-semibold mb-2">No Sessions Yet</h3>
                    <p class="text-secondary mb-4">Start your first trading session to begin tracking your performance</p>
                    <button onclick="app.startSession()" class="btn-primary">
                        <iconify-icon icon="solar:play-bold" width="16" class="inline mr-2"></iconify-icon>
                        Start Your First Session
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Wizard Overlay -->
    <div id="session-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="session-wizard-title">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-semibold" id="session-wizard-title">New Trading Session</h2>
                <button onclick="app.closeSession()" class="text-secondary hover:text-primary transition-colors" aria-label="Close session wizard">
                    <iconify-icon icon="solar:close-circle-bold" width="28"></iconify-icon>
                </button>
            </div>

            <!-- Step 1: Pre-Session Setup -->
            <div id="session-step-1">
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Trading Instrument</label>
                        <div class="flex items-center">
                            <select id="session-instrument" class="flex-1" onchange="app.onInstrumentSelected()">
                                <option value="">Select Instrument</option>
                                
                                <optgroup label="‚≠ê Favorites" id="favorites-optgroup" style="display: none;">
                                    <!-- Favorite instruments will be dynamically added here -->
                                </optgroup>
                                
                                <optgroup label="üìä Major Forex Pairs">
                                    <option value="EUR/USD">EUR/USD - Euro / US Dollar</option>
                                    <option value="GBP/USD">GBP/USD - British Pound / US Dollar</option>
                                    <option value="USD/JPY">USD/JPY - US Dollar / Japanese Yen</option>
                                    <option value="USD/CHF">USD/CHF - US Dollar / Swiss Franc</option>
                                    <option value="AUD/USD">AUD/USD - Australian Dollar / US Dollar</option>
                                <option value="USD/CAD">USD/CAD - US Dollar / Canadian Dollar</option>
                                <option value="NZD/USD">NZD/USD - New Zealand Dollar / US Dollar</option>
                            </optgroup>
                            
                            <optgroup label="üí± Minor Forex Pairs">
                                <option value="EUR/GBP">EUR/GBP - Euro / British Pound</option>
                                <option value="EUR/JPY">EUR/JPY - Euro / Japanese Yen</option>
                                <option value="EUR/CHF">EUR/CHF - Euro / Swiss Franc</option>
                                <option value="EUR/AUD">EUR/AUD - Euro / Australian Dollar</option>
                                <option value="EUR/CAD">EUR/CAD - Euro / Canadian Dollar</option>
                                <option value="GBP/JPY">GBP/JPY - British Pound / Japanese Yen</option>
                                <option value="GBP/CHF">GBP/CHF - British Pound / Swiss Franc</option>
                                <option value="GBP/AUD">GBP/AUD - British Pound / Australian Dollar</option>
                                <option value="GBP/CAD">GBP/CAD - British Pound / Canadian Dollar</option>
                                <option value="AUD/JPY">AUD/JPY - Australian Dollar / Japanese Yen</option>
                                <option value="AUD/CHF">AUD/CHF - Australian Dollar / Swiss Franc</option>
                                <option value="AUD/CAD">AUD/CAD - Australian Dollar / Canadian Dollar</option>
                                <option value="NZD/JPY">NZD/JPY - New Zealand Dollar / Japanese Yen</option>
                                <option value="CAD/JPY">CAD/JPY - Canadian Dollar / Japanese Yen</option>
                                <option value="CHF/JPY">CHF/JPY - Swiss Franc / Japanese Yen</option>
                            </optgroup>
                            
                            <optgroup label="üìà Major Stock Indices">
                                <option value="US30">US30 - Dow Jones Industrial Average</option>
                                <option value="SPX500">SPX500 - S&P 500</option>
                                <option value="NAS100">NAS100 - NASDAQ 100</option>
                                <option value="US2000">US2000 - Russell 2000</option>
                                <option value="GER40">GER40 - DAX (Germany)</option>
                                <option value="UK100">UK100 - FTSE 100 (UK)</option>
                                <option value="FRA40">FRA40 - CAC 40 (France)</option>
                                <option value="JPN225">JPN225 - Nikkei 225 (Japan)</option>
                                <option value="AUS200">AUS200 - ASX 200 (Australia)</option>
                                <option value="HK50">HK50 - Hang Seng (Hong Kong)</option>
                                <option value="CHINA50">CHINA50 - FTSE China A50</option>
                                <option value="EURO50">EURO50 - Euro Stoxx 50</option>
                            </optgroup>
                            
                            <optgroup label="‚Çø Major Cryptocurrencies">
                                <option value="BTC/USD">BTC/USD - Bitcoin</option>
                                <option value="ETH/USD">ETH/USD - Ethereum</option>
                                <option value="BNB/USD">BNB/USD - Binance Coin</option>
                                <option value="XRP/USD">XRP/USD - Ripple</option>
                                <option value="ADA/USD">ADA/USD - Cardano</option>
                                <option value="SOL/USD">SOL/USD - Solana</option>
                                <option value="DOGE/USD">DOGE/USD - Dogecoin</option>
                                <option value="DOT/USD">DOT/USD - Polkadot</option>
                                <option value="MATIC/USD">MATIC/USD - Polygon</option>
                                <option value="LTC/USD">LTC/USD - Litecoin</option>
                                <option value="AVAX/USD">AVAX/USD - Avalanche</option>
                                <option value="LINK/USD">LINK/USD - Chainlink</option>
                            </optgroup>
                            
                            <optgroup label="ü•á Precious Metals">
                                <option value="XAU/USD">XAU/USD - Gold</option>
                                <option value="XAG/USD">XAG/USD - Silver</option>
                                <option value="XPT/USD">XPT/USD - Platinum</option>
                                <option value="XPD/USD">XPD/USD - Palladium</option>
                            </optgroup>
                            
                            <optgroup label="üõ¢Ô∏è Commodities">
                                <option value="CL/USD">CL/USD - Crude Oil (WTI)</option>
                                <option value="BRENT/USD">BRENT/USD - Brent Crude Oil</option>
                                <option value="NG/USD">NG/USD - Natural Gas</option>
                                <option value="COPPER/USD">COPPER/USD - Copper</option>
                            </optgroup>
                        </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Session Type</label>
                        <select id="session-type">
                            <option value="scalping">Scalping</option>
                            <option value="day-trading">Day Trading</option>
                            <option value="swing">Swing Trading</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Max Risk (%)</label>
                        <input type="number" id="session-risk" step="0.1" min="0" max="10" value="2" class="input-field">
                    </div>

                    <!-- NEW: Tag System -->
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">
                            üè∑Ô∏è Tags (Optional)
                            <span class="text-xs text-muted ml-2">Organize your sessions</span>
                        </label>
                        <input type="text" id="session-tags" placeholder="e.g., breakout, news-event, high-conviction" class="input-field">
                        <div id="tag-suggestions" class="flex flex-wrap gap-2 mt-2"></div>
                    </div>

                    <!-- NEW: Trade Direction (Buy/Sell) -->
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">
                            üìà Trade Direction
                        </label>
                        <div class="grid grid-cols-2 gap-3">
                            <button type="button" onclick="app.selectDirection('buy')" id="direction-buy" class="stat-card text-center hover:border-success" style="padding: 12px;">
                                <iconify-icon icon="solar:arrow-up-bold" class="text-success mb-1" width="24"></iconify-icon>
                                <div class="text-sm font-semibold">BUY</div>
                            </button>
                            <button type="button" onclick="app.selectDirection('sell')" id="direction-sell" class="stat-card text-center hover:border-error" style="padding: 12px;">
                                <iconify-icon icon="solar:arrow-down-bold" class="text-error mb-1" width="24"></iconify-icon>
                                <div class="text-sm font-semibold">SELL</div>
                            </button>
                        </div>
                    </div>

                    <!-- NEW: Trade Quantity -->
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">
                            üìä Trade Quantity
                            <span class="text-xs text-muted ml-2">Lot size, contracts, or shares</span>
                        </label>
                        <input type="number" id="session-quantity" step="0.01" min="0" placeholder="e.g., 0.5" class="input-field">
                        <div class="text-xs text-muted mt-1">
                            Examples: 0.5 lots (forex), 1 contract (futures), 100 shares (stocks)
                        </div>
                    </div>

                    <!-- NEW: Live Chart Widget for Auto Price Capture -->
                    <div id="live-chart-container" class="hidden">
                        <label class="block text-sm font-medium text-secondary mb-2">
                            üìä Live Chart
                            <span class="text-xs text-muted ml-2">Auto-capture entry/exit with screenshots</span>
                        </label>
                        <div class="stat-card p-4">
                            <!-- TradingView Widget -->
                            <div id="tradingview-widget-step1" style="height: 350px; position: relative;">
                                <div class="flex items-center justify-center h-full text-secondary">
                                    <div class="text-center">
                                        <iconify-icon icon="solar:chart-2-bold" width="48" class="opacity-50 mb-2"></iconify-icon>
                                        <div class="text-sm">Loading chart...</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Current Price Display -->
                            <div class="flex items-center justify-between mt-3 p-3 bg-[#0a0a0a] rounded border border-[#222]">
                                <div class="text-sm text-secondary">Current Price:</div>
                                <div id="current-price-display" class="text-lg font-mono font-semibold text-primary">-</div>
                            </div>
                        </div>
                    </div>

                    <button onclick="app.nextStep(2)" class="btn-primary w-full">Continue</button>
                </div>
            </div>

            <!-- Step 2: Emotional State -->
            <div id="session-step-2" class="hidden">
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-3">Current Emotional State</label>
                        <div class="grid grid-cols-3 gap-3" id="mood-grid">
                            <div class="mood-option" data-mood="focused" onclick="app.selectMood('focused')">
                                <iconify-icon icon="solar:target-bold" width="32" class="text-secondary mb-2"></iconify-icon>
                                <div class="text-sm">Focused</div>
                            </div>
                            <div class="mood-option" data-mood="confident" onclick="app.selectMood('confident')">
                                <iconify-icon icon="solar:star-bold" width="32" class="text-secondary mb-2"></iconify-icon>
                                <div class="text-sm">Confident</div>
                            </div>
                            <div class="mood-option" data-mood="anxious" onclick="app.selectMood('anxious')">
                                <iconify-icon icon="solar:danger-bold" width="32" class="text-secondary mb-2"></iconify-icon>
                                <div class="text-sm">Anxious</div>
                            </div>
                            <div class="mood-option" data-mood="excited" onclick="app.selectMood('excited')">
                                <iconify-icon icon="solar:lightning-bold" width="32" class="text-secondary mb-2"></iconify-icon>
                                <div class="text-sm">Excited</div>
                            </div>
                            <div class="mood-option" data-mood="tired" onclick="app.selectMood('tired')">
                                <iconify-icon icon="solar:moon-bold" width="32" class="text-secondary mb-2"></iconify-icon>
                                <div class="text-sm">Tired</div>
                            </div>
                            <div class="mood-option" data-mood="neutral" onclick="app.selectMood('neutral')">
                                <iconify-icon icon="solar:minus-circle-bold" width="32" class="text-secondary mb-2"></iconify-icon>
                                <div class="text-sm">Neutral</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Confidence Level (1-10)</label>
                        <input type="range" id="session-confidence" min="1" max="10" value="7" class="w-full">
                        <div class="text-center text-2xl font-mono mt-2" id="confidence-display">7</div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Pre-Trade Notes (Optional)</label>
                        <textarea id="session-pre-notes" rows="3" placeholder="Mental state, market conditions, strategy notes..."></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="app.nextStep(1)" class="btn-secondary flex-1">Back</button>
                        <button onclick="app.startLiveSession()" class="btn-primary flex-1">Start Trading</button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Live Session -->
            <div id="session-step-3" class="hidden">
                <div class="space-y-5">
                    <div class="flex items-center gap-3 p-4 bg-[#111111] border border-[#222222] rounded">
                        <span class="live-indicator"></span>
                        <div class="flex-1">
                            <div class="font-semibold text-error">Live Session</div>
                            <div class="text-xs text-muted" id="session-start-time"></div>
                        </div>
                    </div>
                    
                    <!-- Session Timer -->
                    <div class="timer-display" id="session-timer">00:00:00</div>

                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center">
                            <div class="text-xs text-muted mb-1">Instrument</div>
                            <div class="text-lg font-medium" id="live-instrument"></div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-muted mb-1">Mood</div>
                            <div class="text-lg font-medium capitalize" id="live-mood"></div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-muted mb-1">Confidence</div>
                            <div class="text-lg font-medium" id="live-confidence"></div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-secondary mb-3">Trade Execution</label>
                        
                        <!-- Execute Trade Button (Captures Entry Price) -->
                        <div id="execute-trade-section">
                            <button onclick="app.executeTrade()" class="btn-primary w-full py-4 mb-3">
                                <iconify-icon icon="solar:play-circle-bold" width="24"></iconify-icon>
                                <span class="ml-2 text-lg font-semibold">Execute Trade</span>
                                <div class="text-xs opacity-75 mt-1">Click when you enter the trade</div>
                            </button>
                        </div>
                        
                        <!-- Active Trade Display (After Execute) -->
                        <div id="active-trade-display" class="hidden">
                            <div class="stat-card mb-3">
                                <div class="flex items-center gap-3 mb-3">
                                    <span class="live-indicator"></span>
                                    <div class="font-semibold text-success">Trade Active</div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3 mb-3">
                                    <div class="p-3 bg-[#0a0a0a] rounded border border-[#222]">
                                        <div class="text-xs text-muted mb-1">Entry Price</div>
                                        <div id="entry-price-display" class="text-lg font-mono font-semibold text-primary">-</div>
                                        <div id="entry-time-display" class="text-xs text-muted mt-1">-</div>
                                    </div>
                                    <div class="p-3 bg-[#0a0a0a] rounded border border-[#222]">
                                        <div class="text-xs text-muted mb-1">Current Price</div>
                                        <div id="live-current-price" class="text-lg font-mono font-semibold">-</div>
                                        <div id="live-pnl" class="text-xs mt-1">P&L: -</div>
                                    </div>
                                </div>
                                
                                <!-- Reflect/Exit Button -->
                                <button onclick="app.reflectTrade()" class="btn-secondary w-full py-3">
                                    <iconify-icon icon="solar:stop-circle-bold" width="20"></iconify-icon>
                                    <span class="ml-2">Reflect / Exit Trade</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Additional Actions (Skipped setups tracking) -->
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-secondary mb-2">Session Actions</label>
                            <button onclick="app.logAction('skip')" class="stat-card text-center hover:border-[#f59e0b] w-full">
                                <iconify-icon icon="solar:close-circle-bold" class="text-[#f59e0b] mb-2" width="32"></iconify-icon>
                                <div class="text-sm">Skipped Setup</div>
                            </button>
                            <div class="mt-2 text-xs text-muted text-center" id="action-log">No actions logged</div>
                        </div>
                    </div>

                    <button onclick="app.endSession()" class="btn-primary w-full">
                        End Session & Reflect
                    </button>
                </div>
            </div>

            <!-- Step 4: Session Reflection -->
            <div id="session-step-4" class="hidden">
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Overall Outcome</label>
                        <select id="session-outcome">
                            <option value="">Select Outcome</option>
                            <option value="win">Win</option>
                            <option value="loss">Loss</option>
                            <option value="breakeven">Breakeven</option>
                            <option value="no-trade">No Trade Taken</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">P&L (Optional)</label>
                        <input type="number" id="session-pnl" step="0.01" placeholder="Enter profit/loss amount" class="input-field">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-secondary mb-2">Post-Session Notes</label>
                        <textarea id="session-post-notes" rows="4" placeholder="What went well? What could improve? Key lessons..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-secondary mb-3">Mistakes Made (Select All)</label>
                        <div class="space-y-2">
                            <label class="flex items-center gap-3 p-3 bg-[#111111] border border-[#222222] rounded cursor-pointer hover:border-[#333333]">
                                <input type="checkbox" value="revenge-trading" class="mistake-checkbox">
                                <span class="text-sm">Revenge Trading</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 bg-[#111111] border border-[#222222] rounded cursor-pointer hover:border-[#333333]">
                                <input type="checkbox" value="fomo" class="mistake-checkbox">
                                <span class="text-sm">FOMO Trade</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 bg-[#111111] border border-[#222222] rounded cursor-pointer hover:border-[#333333]">
                                <input type="checkbox" value="position-too-large" class="mistake-checkbox">
                                <span class="text-sm">Position Too Large</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 bg-[#111111] border border-[#222222] rounded cursor-pointer hover:border-[#333333]">
                                <input type="checkbox" value="no-stop-loss" class="mistake-checkbox">
                                <span class="text-sm">No Stop Loss</span>
                            </label>
                        </div>
                    </div>

                    <button onclick="app.saveSession()" class="btn-primary w-full">
                        Save Session
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Overlay -->
    <div id="analytics-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="analytics-title">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="flex items-center justify-between mb-6">
                <h2 id="analytics-title" class="text-2xl font-semibold">Performance Analytics</h2>
                <button type="button" class="text-secondary hover:text-primary transition-colors" aria-label="Close analytics" style="cursor: pointer; background: none; border: none; padding: 8px;" onclick="document.getElementById('analytics-overlay').classList.remove('active');">
                    <iconify-icon icon="solar:close-circle-bold" width="28"></iconify-icon>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <div class="stat-card">
                    <h3 class="text-sm font-medium text-secondary mb-4 uppercase tracking-wider">Win Rate by Mood</h3>
                    <div style="height: 300px;">
                        <canvas id="mood-chart"></canvas>
                    </div>
                </div>
                <div class="stat-card">
                    <h3 class="text-sm font-medium text-secondary mb-4 uppercase tracking-wider">Performance Timeline</h3>
                    <div style="height: 300px;">
                        <canvas id="timeline-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Performance Calendar -->
            <div class="stat-card mt-6">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-xl font-semibold text-primary">Performance Calendar</h3>
                        <p class="text-sm text-muted mt-1">Daily trading activity</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="app.changeCalendarMonth(-1)" class="btn-secondary px-3 py-1 text-xs">
                            <iconify-icon icon="ph:caret-left" class="text-lg"></iconify-icon>
                        </button>
                        <span id="calendar-month-year" class="text-sm text-secondary px-4 py-1 flex items-center"></span>
                        <button onclick="app.changeCalendarMonth(1)" class="btn-secondary px-3 py-1 text-xs">
                            <iconify-icon icon="ph:caret-right" class="text-lg"></iconify-icon>
                        </button>
                    </div>
                </div>
                
                <div class="calendar-header">
                    <div class="calendar-header-day">Sun</div>
                    <div class="calendar-header-day">Mon</div>
                    <div class="calendar-header-day">Tue</div>
                    <div class="calendar-header-day">Wed</div>
                    <div class="calendar-header-day">Thu</div>
                    <div class="calendar-header-day">Fri</div>
                    <div class="calendar-header-day">Sat</div>
                </div>
                
                <div id="calendar-grid" class="calendar-grid"></div>
                
                <div class="flex items-center justify-center gap-6 mt-6 text-xs text-muted">
                    <div class="flex items-center gap-2">
                        <div style="width: 12px; height: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 2px;"></div>
                        <span>Win</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div style="width: 12px; height: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 2px;"></div>
                        <span>Loss</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div style="width: 12px; height: 12px; background: rgba(107, 114, 128, 0.1); border: 1px solid #6b7280; border-radius: 2px;"></div>
                        <span>Break-even</span>
                    </div>
                </div>
                
                <!-- Day History Panel -->
                <div id="day-history-panel" class="day-history-panel">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-semibold text-primary" id="day-history-title"></h3>
                            <p class="text-sm text-muted mt-1" id="day-history-subtitle"></p>
                        </div>
                        <button onclick="app.closeDayHistory()" class="text-secondary hover:text-primary transition-colors">
                            <iconify-icon icon="solar:close-circle-bold" width="28"></iconify-icon>
                        </button>
                    </div>
                    <div id="day-history-sessions" class="space-y-3">
                        <!-- Sessions for the selected day will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Learning Overlay -->
    <div id="learning-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="learning-title">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 id="learning-title" class="text-2xl font-semibold text-yellow-500">NEURAL LEARNING CENTER</h2>
                    <p class="text-sm text-secondary mt-1">MASTER THE EDGE ‚Ä¢ EVOLVE YOUR STRATEGY</p>
                </div>
                <button onclick="app.closeLearning()" class="text-secondary hover:text-primary transition-colors" aria-label="Close learning center">
                    <iconify-icon icon="solar:close-circle-bold" width="28"></iconify-icon>
                </button>
            </div>

            <!-- Overall Progress -->
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="stat-card text-center">
                    <div class="text-xs text-secondary uppercase tracking-wider mb-2">Overall Progress</div>
                    <div class="text-3xl font-bold text-yellow-500">3%</div>
                    <div class="progress-bar mt-3">
                        <div class="progress-fill" style="width: 3%; background: #eab308;"></div>
                    </div>
                </div>
                <div class="stat-card text-center">
                    <div class="text-xs text-secondary uppercase tracking-wider mb-2">Modules Completed</div>
                    <div class="text-3xl font-bold text-cyan-500">0/6</div>
                </div>
                <div class="stat-card text-center">
                    <div class="text-xs text-secondary uppercase tracking-wider mb-2">Learning Streak</div>
                    <div class="text-3xl font-bold">0 days</div>
                </div>
            </div>

            <!-- Learning Modules Grid -->
            <div class="grid grid-cols-2 gap-4">
                <!-- Trading Psychology -->
                <div class="stat-card hover:border-purple-500 cursor-pointer transition-all" onclick="app.openModule('psychology')">
                    <div class="flex items-start gap-4">
                        <div class="bg-purple-500/10 p-3 rounded">
                            <iconify-icon icon="solar:brain-bold" width="32" class="text-purple-500"></iconify-icon>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-semibold text-purple-400">TRADING PSYCHOLOGY</h3>
                                <span class="text-xs text-purple-500 bg-purple-500/10 px-2 py-1 rounded">0%</span>
                            </div>
                            <p class="text-sm text-muted mb-3">Master fear, greed, and mental discipline</p>
                            <div class="flex items-center gap-2 text-xs text-muted">
                                <iconify-icon icon="solar:book-bold" width="14"></iconify-icon>
                                <span>5 LESSONS ‚Ä¢ 20 MIN</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Management -->
                <div class="stat-card hover:border-green-500 cursor-pointer transition-all" onclick="app.openModule('risk')">
                    <div class="flex items-start gap-4">
                        <div class="bg-green-500/10 p-3 rounded">
                            <iconify-icon icon="solar:shield-check-bold" width="32" class="text-green-500"></iconify-icon>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-semibold text-green-400">RISK MANAGEMENT</h3>
                                <span class="text-xs text-green-500 bg-green-500/10 px-2 py-1 rounded">0%</span>
                            </div>
                            <p class="text-sm text-muted mb-3">Protect capital and manage your profitability</p>
                            <div class="flex items-center gap-2 text-xs text-muted">
                                <iconify-icon icon="solar:book-bold" width="14"></iconify-icon>
                                <span>5 LESSONS ‚Ä¢ 20 MIN</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Strategy Development -->
                <div class="stat-card hover:border-blue-500 cursor-pointer transition-all" onclick="app.openModule('strategy')">
                    <div class="flex items-start gap-4">
                        <div class="bg-blue-500/10 p-3 rounded">
                            <iconify-icon icon="solar:graph-up-bold" width="32" class="text-blue-500"></iconify-icon>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-semibold text-blue-400">STRATEGY DEVELOPMENT</h3>
                                <span class="text-xs text-blue-500 bg-blue-500/10 px-2 py-1 rounded">0%</span>
                            </div>
                            <p class="text-sm text-muted mb-3">Build and refine your trading methodology</p>
                            <div class="flex items-center gap-2 text-xs text-muted">
                                <iconify-icon icon="solar:book-bold" width="14"></iconify-icon>
                                <span>5 LESSONS ‚Ä¢ 25 MIN</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Technical Analysis -->
                <div class="stat-card hover:border-cyan-500 cursor-pointer transition-all" onclick="app.openModule('technical')">
                    <div class="flex items-start gap-4">
                        <div class="bg-cyan-500/10 p-3 rounded">
                            <iconify-icon icon="solar:chart-bold" width="32" class="text-cyan-500"></iconify-icon>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-semibold text-cyan-400">TECHNICAL ANALYSIS</h3>
                                <span class="text-xs text-cyan-500 bg-cyan-500/10 px-2 py-1 rounded">0%</span>
                            </div>
                            <p class="text-sm text-muted mb-3">Read price action and market structure</p>
                            <div class="flex items-center gap-2 text-xs text-muted">
                                <iconify-icon icon="solar:book-bold" width="14"></iconify-icon>
                                <span>5 LESSONS ‚Ä¢ 25 MIN</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Journaling Mastery -->
                <div class="stat-card hover:border-orange-500 cursor-pointer transition-all" onclick="app.openModule('journaling')">
                    <div class="flex items-start gap-4">
                        <div class="bg-orange-500/10 p-3 rounded">
                            <iconify-icon icon="solar:notebook-bold" width="32" class="text-orange-500"></iconify-icon>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-semibold text-orange-400">JOURNALING MASTERY</h3>
                                <span class="text-xs text-orange-500 bg-orange-500/10 px-2 py-1 rounded">20%</span>
                            </div>
                            <p class="text-sm text-muted mb-3">Track, analyze, and improve performance</p>
                            <div class="flex items-center gap-2 text-xs text-muted">
                                <iconify-icon icon="solar:book-bold" width="14"></iconify-icon>
                                <span>5 LESSONS ‚Ä¢ 25 MIN</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Winning Mindset -->
                <div class="stat-card hover:border-pink-500 cursor-pointer transition-all" onclick="app.openModule('mindset')">
                    <div class="flex items-start gap-4">
                        <div class="bg-pink-500/10 p-3 rounded">
                            <iconify-icon icon="solar:cup-star-bold" width="32" class="text-pink-500"></iconify-icon>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-semibold text-pink-400">WINNING MINDSET</h3>
                                <span class="text-xs text-pink-500 bg-pink-500/10 px-2 py-1 rounded">0%</span>
                            </div>
                            <p class="text-sm text-muted mb-3">Cultivate professional trader mentality</p>
                            <div class="flex items-center gap-2 text-xs text-muted">
                                <iconify-icon icon="solar:book-bold" width="14"></iconify-icon>
                                <span>5 LESSONS ‚Ä¢ 20 MIN</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Module Content Panel (Slide-in from right) -->
    <div id="module-panel" class="module-panel">
        <div class="module-panel-header">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-3">
                    <button onclick="app.closeModule()" class="text-secondary hover:text-primary transition-colors">
                        <iconify-icon icon="solar:arrow-left-bold" width="24"></iconify-icon>
                    </button>
                    <div>
                        <h3 id="module-title" class="text-xl font-semibold text-yellow-500"></h3>
                        <p id="module-subtitle" class="text-xs text-muted mt-1"></p>
                    </div>
                </div>
                <button onclick="app.closeModule()" class="text-secondary hover:text-primary transition-colors">
                    <iconify-icon icon="solar:close-circle-bold" width="24"></iconify-icon>
                </button>
            </div>
            <div class="flex items-center gap-4 mt-4">
                <div class="flex-1">
                    <div class="progress-bar">
                        <div id="module-progress-bar" class="progress-fill" style="background: #eab308; width: 0%;"></div>
                    </div>
                </div>
                <span id="module-progress-text" class="text-xs text-muted">0/5 completed</span>
            </div>
        </div>
        
        <div class="module-panel-content" id="module-lessons-container">
            <!-- Lessons will be dynamically inserted here -->
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="max-w-7xl mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
                <div>
                    <div class="logo-container mb-4">
                        <div class="logo-icon">E</div>
                        <div>
                            <h3 class="font-semibold">EdgeMetrics</h3>
                            <p class="text-xs text-muted">Trading Excellence</p>
                        </div>
                    </div>
                    <p class="text-sm text-secondary">
                        Professional trading journal for serious traders who demand data-driven improvement.
                    </p>
                </div>

                <div>
                    <h4 class="font-semibold mb-3 text-sm uppercase tracking-wider">Product</h4>
                    <ul class="space-y-2 text-sm text-secondary">
                        <li><a href="#" class="hover:text-primary">Features</a></li>
                        <li><a href="#" class="hover:text-primary">Pricing</a></li>
                        <li><a href="#" class="hover:text-primary">Updates</a></li>
                        <li><a href="#" class="hover:text-primary">Roadmap</a></li>
                    </ul>
                </div>

                <div>
                    <h4 class="font-semibold mb-3 text-sm uppercase tracking-wider">Resources</h4>
                    <ul class="space-y-2 text-sm text-secondary">
                        <li><a href="#" onclick="app.showLearning(); return false;" class="hover:text-primary">Learning Center</a></li>
                        <li><a href="#" class="hover:text-primary">Documentation</a></li>
                        <li><a href="#" class="hover:text-primary">Trading Guides</a></li>
                        <li><a href="#" class="hover:text-primary">Community</a></li>
                    </ul>
                </div>

                <div>
                    <h4 class="font-semibold mb-3 text-sm uppercase tracking-wider">Company</h4>
                    <ul class="space-y-2 text-sm text-secondary">
                        <li><a href="#" class="hover:text-primary">About Us</a></li>
                        <li><a href="#" class="hover:text-primary">Contact</a></li>
                        <li><a href="#" class="hover:text-primary">Privacy Policy</a></li>
                        <li><a href="#" class="hover:text-primary">Terms of Service</a></li>
                    </ul>
                </div>
            </div>

            <div class="border-t border-[#222222] pt-8">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="text-sm text-muted">
                        ¬© 2026 EdgeMetrics. Built with precision for professional traders.
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="feature-badge">
                            <iconify-icon icon="solar:shield-check-bold" width="14"></iconify-icon>
                            100% Private
                        </span>
                        <span class="feature-badge">
                            <iconify-icon icon="solar:cpu-bolt-bold" width="14"></iconify-icon>
                            AI Powered
                        </span>
                        <span class="feature-badge">
                            <iconify-icon icon="solar:monitor-bold" width="14"></iconify-icon>
                            Offline Ready
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script>
    const app = {
        state: {
            currentStep: 1,
            sessions: [],
            currentSession: null,
            selectedMood: null,
            actionLog: [],
            favoriteInstruments: [], // NEW: favorite instruments list
            calendarMonth: new Date().getMonth(),
            calendarYear: new Date().getFullYear()
        },

        init() {
            this.state.filteredSessions = null; // Initialize filtered sessions state
            this.loadSessions();
            this.loadFavorites(); // Load saved favorites
            this.loadTheme(); // Load saved theme
            this.renderDashboard();
            this.updateUserStats();
            this.updateQuickStats();
            this.setupKeyboardShortcuts();
            this.closeExportMenuOnClickOutside();
            
            // Initialize ultimate features
            this.checkFirstVisit();
            this.initializeAchievements();
            this.updateEdgeScore();
            this.updatePnL();
            this.showDailyPrompt();
            this.checkPatterns();
            this.populateQuickInstruments();
            this.setupQuickLogKeyboard();
            this.updateInstrumentDropdown(); // Initialize favorites dropdown
            
            // Confidence slider
            const confidenceSlider = document.getElementById('session-confidence');
            if (confidenceSlider) {
                confidenceSlider.addEventListener('input', (e) => {
                    const display = document.getElementById('confidence-display');
                    if (display) {
                        display.textContent = e.target.value;
                    }
                });
            }
            
            // Session timer interval
            this.timerInterval = null;
            
            // Achievement data
            this.achievements = {
                unlocked: JSON.parse(localStorage.getItem('edgemetrics_achievements') || '[]')
            };
        },
        
        // ===== NEW ENHANCEMENT METHODS =====
        
        // Toast Notification System
        showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const iconMap = {
                success: 'solar:check-circle-bold',
                error: 'solar:close-circle-bold',
                warning: 'solar:danger-triangle-bold',
                info: 'solar:info-circle-bold'
            };
            
            toast.innerHTML = `
                <iconify-icon icon="${iconMap[type]}" width="20" class="${type === 'success' ? 'text-success' : type === 'error' ? 'text-error' : type === 'warning' ? 'text-warning' : 'text-secondary'}"></iconify-icon>
                <span class="flex-1">${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        },
        
        // Theme Toggle
        toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            
            body.classList.toggle('light-theme');
            
            if (body.classList.contains('light-theme')) {
                icon.setAttribute('icon', 'solar:moon-bold');
                localStorage.setItem('edgemetrics_theme', 'light');
            } else {
                icon.setAttribute('icon', 'solar:sun-bold');
                localStorage.setItem('edgemetrics_theme', 'dark');
            }
        },
        
        loadTheme() {
            const savedTheme = localStorage.getItem('edgemetrics_theme');
            const icon = document.getElementById('theme-icon');
            
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
                if (icon) icon.setAttribute('icon', 'solar:moon-bold');
            }
        },
        
        // Loading Overlay
        showLoading() {
            document.getElementById('loading-overlay').classList.add('active');
        },
        
        hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        },
        
        // Keyboard Shortcuts
        setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+N: New Session
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    this.startSession();
                }
                // Ctrl+A: Analytics
                if (e.ctrlKey && e.key === 'a') {
                    e.preventDefault();
                    this.showAnalytics();
                }
                // Ctrl+L: Learning
                if (e.ctrlKey && e.key === 'l') {
                    e.preventDefault();
                    this.showLearning();
                }
                // Ctrl+E: Export Menu
                if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    this.toggleExportMenu();
                }
                // Escape: Close overlays
                if (e.key === 'Escape') {
                    this.closeAllOverlays();
                }
            });
        },
        
        closeAllOverlays() {
            document.getElementById('session-overlay').classList.remove('active');
            document.getElementById('analytics-overlay').classList.remove('active');
            document.getElementById('learning-overlay').classList.remove('active');
            document.getElementById('export-menu').classList.remove('active');
            
            // Close clear history modal if it exists
            const clearModal = document.getElementById('clear-history-modal');
            if (clearModal) {
                clearModal.classList.remove('active');
            }
        },
        
        // Quick Stats Update
        updateQuickStats() {
            const sessions = this.state.sessions;
            
            // Today's sessions
            const today = new Date().toDateString();
            const todaySessions = sessions.filter(s => 
                new Date(s.startTime).toDateString() === today
            ).length;
            document.getElementById('header-today-sessions').textContent = todaySessions;
            
            // Win Streak
            let streak = 0;
            for (let i = 0; i < sessions.length; i++) {
                if (sessions[i].outcome === 'win') {
                    streak++;
                } else {
                    break;
                }
            }
            document.getElementById('header-win-streak').textContent = streak;
        },
        
        // Session Timer
        startSessionTimer() {
            const startTime = new Date(this.state.currentSession.startTime);
            
            this.timerInterval = setInterval(() => {
                const now = new Date();
                const elapsed = Math.floor((now - startTime) / 1000);
                
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                
                const timerDisplay = document.getElementById('session-timer');
                if (timerDisplay) {
                    timerDisplay.textContent = 
                        `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
            }, 1000);
        },
        
        stopSessionTimer() {
            if (this.timerInterval) {
                clearInterval(this.timerInterval);
                this.timerInterval = null;
            }
        },
        
        // Export/Import Functions
        toggleExportMenu() {
            const menu = document.getElementById('export-menu');
            menu.classList.toggle('active');
        },
        
        closeExportMenuOnClickOutside() {
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('export-menu');
                const button = e.target.closest('button[onclick="app.toggleExportMenu()"]');
                if (!button && !menu.contains(e.target)) {
                    menu.classList.remove('active');
                }
            });
        },
        
        exportToJSON() {
            try {
                const data = {
                    sessions: this.state.sessions,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `edgemetrics-export-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showToast('Sessions exported successfully', 'success');
                this.toggleExportMenu();
            } catch (error) {
                this.showToast('Export failed: ' + error.message, 'error');
            }
        },
        
        exportToCSV() {
            try {
                const headers = ['Date', 'Instrument', 'Type', 'Mood', 'Confidence', 'Outcome', 'P&L', 'Duration (min)', 'Mistakes', 'Notes'];
                const rows = this.state.sessions.map(s => [
                    new Date(s.startTime).toLocaleString(),
                    s.instrument || '',
                    s.type || '',
                    s.mood || '',
                    s.confidence || '',
                    s.outcome || '',
                    s.pnl || '',
                    s.duration || '',
                    (s.mistakes || []).join('; '),
                    (s.postNotes || '').replace(/,/g, ';')
                ]);
                
                const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `edgemetrics-export-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showToast('Sessions exported as CSV', 'success');
                this.toggleExportMenu();
            } catch (error) {
                this.showToast('Export failed: ' + error.message, 'error');
            }
        },
        
        importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                this.showLoading('Importing data...');
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (!data.sessions || !Array.isArray(data.sessions)) {
                            throw new Error('Invalid file format - missing sessions array');
                        }
                        
                        // Validate session structure
                        if (data.sessions.length > 0) {
                            const sample = data.sessions[0];
                            if (!sample.id || !sample.startTime || !sample.instrument) {
                                throw new Error('Invalid session data structure');
                            }
                        }
                        
                        this.state.sessions = data.sessions;
                        this.saveSessions();
                        this.renderDashboard();
                        this.updateUserStats();
                        this.updateQuickStats();
                        this.updatePnL();
                        
                        this.hideLoading();
                        this.showToast(`Successfully imported ${data.sessions.length} sessions`, 'success');
                    } catch (error) {
                        this.hideLoading();
                        this.showToast(`Import failed: ${error.message}`, 'error');
                        console.error('Import error:', error);
                    }
                };
                reader.onerror = () => {
                    this.hideLoading();
                    this.showToast('Failed to read file', 'error');
                };
                reader.readAsText(file);
            };
            input.click();
            this.toggleExportMenu();
        },
        
        clearAllData() {
            // Show custom modal instead of browser confirm
            this.showClearHistoryModal();
            this.toggleExportMenu();
        },
        
        showClearHistoryModal() {
            // Remove existing modal if it exists
            const existingModal = document.getElementById('clear-history-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create fresh modal
            const modalHTML = `
                <div id="clear-history-modal" class="modal-overlay active">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="mb-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-12 h-12 rounded-full bg-red-500/10 flex items-center justify-center">
                                    <iconify-icon icon="solar:trash-bin-2-bold" width="24" class="text-red-500"></iconify-icon>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-primary">Clear All History?</h2>
                                    <p class="text-sm text-secondary">This action cannot be undone</p>
                                </div>
                            </div>
                            <div class="bg-red-500/5 border border-red-500/20 rounded p-4 mb-4">
                                <p class="text-sm text-primary mb-2">‚ö†Ô∏è This will permanently delete:</p>
                                <ul class="text-sm text-secondary space-y-1 ml-4">
                                    <li>‚Ä¢ All session history</li>
                                    <li>‚Ä¢ All favorite instruments</li>
                                    <li>‚Ä¢ All achievements and streaks</li>
                                    <li>‚Ä¢ All saved drafts</li>
                                </ul>
                            </div>
                            <p class="text-sm text-muted">Are you absolutely sure you want to delete all your trading data?</p>
                        </div>
                        <div class="flex gap-3">
                            <button id="clear-history-cancel-btn" class="btn-secondary flex-1">Cancel</button>
                            <button id="clear-history-confirm-btn" class="flex-1 px-6 py-3 text-white font-medium rounded transition-colors cursor-pointer" style="background-color: #ef4444; border: 1px solid #ef4444;">
                                Delete Everything
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Attach event listeners immediately
            setTimeout(() => {
                const cancelBtn = document.getElementById('clear-history-cancel-btn');
                const confirmBtn = document.getElementById('clear-history-confirm-btn');
                
                if (cancelBtn) {
                    cancelBtn.onclick = () => {
                        console.log('Cancel clicked');
                        this.closeClearHistoryModal();
                    };
                }
                
                if (confirmBtn) {
                    confirmBtn.onclick = () => {
                        console.log('Confirm delete clicked');
                        this.confirmClearAllData();
                    };
                }
            }, 50);
        },
        
        closeClearHistoryModal() {
            const modal = document.getElementById('clear-history-modal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            }
        },
        
        confirmClearAllData() {
            console.log('confirmClearAllData called - starting deletion');
            
            try {
                // Clear all sessions and related data IMMEDIATELY
                this.state.sessions = [];
                this.state.filteredSessions = null;
                this.state.favoriteInstruments = [];
                
                // Clear all localStorage items related to the app
                localStorage.removeItem('edgemetrics_sessions');
                localStorage.removeItem('edgemetrics_favorites');
                localStorage.removeItem('edgemetrics_session_draft');
                localStorage.removeItem('edgemetrics_achievements');
                
                // Also clear with empty array to be sure
                localStorage.setItem('edgemetrics_sessions', JSON.stringify([]));
                
                console.log('Data cleared from memory and localStorage');
                
                // Immediately clear the recent sessions container
                const recentContainer = document.getElementById('recent-sessions');
                const emptyState = document.getElementById('empty-sessions-state');
                if (recentContainer) {
                    recentContainer.innerHTML = '';
                }
                if (emptyState) {
                    emptyState.classList.remove('hidden');
                }
                
                // Close modal first
                this.closeClearHistoryModal();
                
                // Update all displays after a brief delay
                setTimeout(() => {
                    this.renderDashboard();
                    this.updateUserStats();
                    this.updateQuickStats();
                    this.updatePnL();
                    this.updateStreakDisplays();
                    
                    // Force another P&L update to ensure it's reset
                    setTimeout(() => {
                        this.updatePnL();
                    }, 100);
                    
                    this.showToast('All data has been permanently cleared', 'success');
                    console.log('Clear complete - dashboard updated');
                }, 100);
                
            } catch (error) {
                console.error('Error clearing data:', error);
                this.showToast('Error clearing data: ' + error.message, 'error');
            }
        },
        
        // Enhanced Error Handling for localStorage
        saveSessionsWithErrorHandling() {
            try {
                localStorage.setItem('edgemetrics_sessions', JSON.stringify(this.state.sessions));
                return true;
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    this.showToast('Storage full. Please export and clear old sessions.', 'error');
                } else {
                    this.showToast('Failed to save: ' + error.message, 'error');
                }
                return false;
            }
        },
        
        // ===== ULTIMATE FEATURE METHODS =====
        
        // Welcome Tour
        checkFirstVisit() {
            const visited = localStorage.getItem('edgemetrics_visited');
            if (!visited) {
                // Load sample sessions for new users
                if (this.state.sessions.length === 0) {
                    this.state.sessions = this.generateSampleSessions().slice(0, 5);
                    this.saveSessions();
                    this.renderDashboard();
                }
                setTimeout(() => {
                    document.getElementById('welcome-overlay').classList.add('active');
                }, 500);
            }
        },
        
        startTour() {
            document.getElementById('welcome-overlay').classList.remove('active');
            localStorage.setItem('edgemetrics_visited', 'true');
            this.showToast('Welcome! Explore the features at your own pace.', 'success', 5000);
            // Could add interactive tour steps here
        },
        
        skipTour() {
            document.getElementById('welcome-overlay').classList.remove('active');
            localStorage.setItem('edgemetrics_visited', 'true');
        },
        
        // Achievement System
        initializeAchievements() {
            this.ACHIEVEMENTS = {
                beginner: [
                    { id: 'first_session', name: 'First Steps', icon: 'üéØ', desc: 'Complete your first trading session', 
                      check: (s) => s.length >= 1 },
                    { id: 'detailed_notes', name: 'Detail Oriented', icon: 'üìù', desc: 'Write notes longer than 100 characters', 
                      check: (s) => s.some(sess => (sess.postNotes || '').length > 100) },
                    { id: 'week_streak', name: 'Consistent Trader', icon: 'üìÖ', desc: 'Log sessions for 7 days in a row', 
                      check: (s) => this.calculateCurrentStreak(s) >= 7 },
                ],
                intermediate: [
                    { id: 'no_mistakes_5', name: 'Disciplined', icon: 'üéñÔ∏è', desc: 'Complete 5 sessions with no mistakes', 
                      check: (s) => s.filter(sess => !sess.mistakes || sess.mistakes.length === 0).length >= 5 },
                    { id: 'fifty_sessions', name: 'Dedicated Trader', icon: '‚≠ê', desc: 'Log 50 trading sessions', 
                      check: (s) => s.length >= 50 },
                    { id: 'profitable_week', name: 'Green Week', icon: 'üí∞', desc: 'Finish a week with positive P&L', 
                      check: (s) => this.checkProfitableWeek(s) },
                ],
                professional: [
                    { id: 'hundred_sessions', name: 'Veteran Trader', icon: '‚ö°', desc: 'Log 100 trading sessions', 
                      check: (s) => s.length >= 100 },
                    { id: 'win_streak_10', name: 'Hot Hand', icon: 'üî•', desc: 'Win 10 sessions in a row', 
                      check: (s) => this.calculateCurrentStreak(s) >= 10 && s[0].outcome === 'win' },
                    { id: 'edge_score_90', name: 'Master Trader', icon: 'üíé', desc: 'Achieve EdgeScore of 90+', 
                      check: (s) => this.calculateEdgeScore(s) >= 90 },
                ]
            };
            
            this.checkAndUnlockAchievements();
        },
        
        calculateCurrentStreak(sessions) {
            if (sessions.length === 0) return 0;
            const sortedSessions = [...sessions].sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
            
            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let i = 0; i < sortedSessions.length; i++) {
                const sessionDate = new Date(sortedSessions[i].startTime);
                sessionDate.setHours(0, 0, 0, 0);
                
                const daysDiff = Math.floor((today - sessionDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff === i) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        },
        
        checkProfitableWeek(sessions) {
            const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const weekSessions = sessions.filter(s => new Date(s.startTime) >= oneWeekAgo);
            const totalPnL = weekSessions.reduce((sum, s) => sum + (s.pnl || 0), 0);
            return totalPnL > 0;
        },
        
        checkAndUnlockAchievements() {
            const sessions = this.state.sessions;
            const allAchievements = [...this.ACHIEVEMENTS.beginner, ...this.ACHIEVEMENTS.intermediate, ...this.ACHIEVEMENTS.professional];
            
            allAchievements.forEach(achievement => {
                if (!this.achievements.unlocked.includes(achievement.id) && achievement.check(sessions)) {
                    this.unlockAchievement(achievement);
                }
            });
        },
        
        unlockAchievement(achievement) {
            this.achievements.unlocked.push(achievement.id);
            localStorage.setItem('edgemetrics_achievements', JSON.stringify(this.achievements.unlocked));
            
            // Celebration!
            this.celebrateAchievement(achievement);
            this.showToast(`Achievement Unlocked: ${achievement.name}!`, 'success', 5000);
        },
        
        celebrateAchievement(achievement) {
            // Confetti effect
            this.launchConfetti();
            
            // Could add sound effect here
            // new Audio('/sounds/achievement.mp3').play();
        },
        
        launchConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const particles = [];
            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'];
            
            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    r: Math.random() * 6 + 2,
                    d: Math.random() * 100,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    tilt: Math.random() * 10 - 10,
                    tiltAngleIncremental: Math.random() * 0.07 + 0.05,
                    tiltAngle: 0
                });
            }
            
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                particles.forEach((p, i) => {
                    ctx.beginPath();
                    ctx.lineWidth = p.r / 2;
                    ctx.strokeStyle = p.color;
                    ctx.moveTo(p.x + p.tilt + p.r, p.y);
                    ctx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r);
                    ctx.stroke();
                    
                    p.tiltAngle += p.tiltAngleIncremental;
                    p.y += (Math.cos(p.d) + 3 + p.r / 2) / 2;
                    p.x += Math.sin(p.d);
                    p.tilt = Math.sin(p.tiltAngle - i / 3) * 15;
                    
                    if (p.y > canvas.height) particles.splice(i, 1);
                });
                
                if (particles.length > 0) requestAnimationFrame(draw);
            }
            
            draw();
            setTimeout(() => { ctx.clearRect(0, 0, canvas.width, canvas.height); }, 5000);
        },
        
        showAchievements() {
            const container = document.getElementById('achievements-container');
            const allAchievements = [
                { title: 'Beginner', achievements: this.ACHIEVEMENTS.beginner },
                { title: 'Intermediate', achievements: this.ACHIEVEMENTS.intermediate },
                { title: 'Professional', achievements: this.ACHIEVEMENTS.professional }
            ];
            
            let html = '';
            allAchievements.forEach(category => {
                html += `
                    <h3 class="text-lg font-semibold mb-3 text-secondary">${category.title}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                `;
                
                category.achievements.forEach(ach => {
                    const unlocked = this.achievements.unlocked.includes(ach.id);
                    const progress = this.getAchievementProgress(ach);
                    
                    html += `
                        <div class="achievement-card ${unlocked ? '' : 'achievement-locked'}">
                            <div class="achievement-icon">${ach.icon}</div>
                            <h4 class="font-semibold mb-1">${ach.name}</h4>
                            <p class="text-sm text-secondary mb-2">${ach.desc}</p>
                            ${unlocked ? 
                                '<div class="text-xs text-success">‚úì Unlocked</div>' : 
                                `<div class="achievement-progress">
                                    <div class="achievement-progress-fill" style="width: ${progress}%"></div>
                                 </div>
                                 <div class="text-xs text-muted mt-1">${progress}% Complete</div>`
                            }
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            container.innerHTML = html;
            document.getElementById('achievements-overlay').classList.add('active');
        },
        
        getAchievementProgress(achievement) {
            // Simplified progress calculation
            if (achievement.id === 'first_session') return this.state.sessions.length > 0 ? 100 : 0;
            if (achievement.id === 'fifty_sessions') return Math.min(100, (this.state.sessions.length / 50) * 100);
            if (achievement.id === 'hundred_sessions') return Math.min(100, (this.state.sessions.length / 100) * 100);
            if (achievement.id === 'week_streak') {
                const streak = this.calculateCurrentStreak(this.state.sessions);
                return Math.min(100, (streak / 7) * 100);
            }
            return 50; // Default progress
        },
        
        closeAchievements() {
            document.getElementById('achievements-overlay').classList.remove('active');
        },
        
        // EdgeScore System
        calculateEdgeScore(sessions) {
            if (sessions.length === 0) return 0;
            
            const consistency = this.calculateConsistencyScore(sessions);      // 0-25
            const discipline = this.calculateDisciplineScore(sessions);        // 0-25
            const performance = this.calculatePerformanceScore(sessions);      // 0-25
            const quality = this.calculateQualityScore(sessions);              // 0-25
            
            return Math.round(consistency + discipline + performance + quality);
        },
        
        calculateConsistencyScore(sessions) {
            const daysWithSessions = new Set();
            sessions.forEach(s => {
                const date = new Date(s.startTime).toDateString();
                daysWithSessions.add(date);
            });
            
            const daysSinceFirst = Math.max(1, Math.floor((new Date() - new Date(sessions[sessions.length - 1].startTime)) / (1000 * 60 * 60 * 24)));
            const frequency = daysWithSessions.size / daysSinceFirst;
            
            return Math.min(25, frequency * 50); // 50% frequency = 25 points
        },
        
        calculateDisciplineScore(sessions) {
            const mistakeRate = sessions.reduce((sum, s) => sum + (s.mistakes?.length || 0), 0) / sessions.length;
            return Math.max(0, 25 - (mistakeRate * 12.5)); // 0 mistakes = 25, 2 mistakes = 0
        },
        
        calculatePerformanceScore(sessions) {
            const wins = sessions.filter(s => s.outcome === 'win').length;
            const winRate = wins / sessions.length;
            return Math.min(25, winRate * 35.7); // 70% win rate = 25 points
        },
        
        calculateQualityScore(sessions) {
            const avgNoteLength = sessions.reduce((sum, s) => sum + ((s.postNotes || '').length + (s.preNotes || '').length), 0) / sessions.length;
            return Math.min(25, avgNoteLength / 10); // 250 chars = 25 points
        },
        
        updateEdgeScore() {
            const score = this.calculateEdgeScore(this.state.sessions);
            document.getElementById('header-edge-score').textContent = score;
        },
        
        showEdgeScore() {
            const sessions = this.state.sessions;
            const score = this.calculateEdgeScore(sessions);
            
            const consistency = this.calculateConsistencyScore(sessions);
            const discipline = this.calculateDisciplineScore(sessions);
            const performance = this.calculatePerformanceScore(sessions);
            const quality = this.calculateQualityScore(sessions);
            
            document.getElementById('edge-score-value').textContent = score;
            
            // Animate the ring
            const ring = document.getElementById('score-ring');
            const circumference = 534;
            const offset = circumference - (score / 100 * circumference);
            setTimeout(() => {
                ring.style.strokeDashoffset = offset;
            }, 100);
            
            // Score breakdown
            const breakdown = document.getElementById('score-breakdown');
            breakdown.innerHTML = `
                ${this.renderScoreItem('Consistency', consistency, 25)}
                ${this.renderScoreItem('Discipline', discipline, 25)}
                ${this.renderScoreItem('Performance', performance, 25)}
                ${this.renderScoreItem('Quality', quality, 25)}
            `;
            
            // Improvement tips
            const tips = [];
            if (consistency < 20) tips.push('Log sessions more frequently (aim for 3-5 per week)');
            if (discipline < 20) tips.push('Reduce rule violations - review your mistakes');
            if (performance < 20) tips.push('Focus on quality over quantity - skip more setups');
            if (quality < 20) tips.push('Write more detailed notes for better insights');
            
            document.getElementById('improvement-tips').innerHTML = tips.length > 0 
                ? tips.map(t => `<li>‚Ä¢ ${t}</li>`).join('')
                : '<li>‚Ä¢ Great job! Keep maintaining your high standards</li>';
            
            document.getElementById('edgescore-overlay').classList.add('active');
        },
        
        renderScoreItem(label, score, max) {
            const percentage = (score / max) * 100;
            return `
                <div class="score-item">
                    <span>${label}</span>
                    <div class="score-bar">
                        <div class="score-bar-fill" style="width: ${percentage}%"></div>
                    </div>
                    <span>${Math.round(score)}/${max}</span>
                </div>
            `;
        },
        
        closeEdgeScore() {
            document.getElementById('edgescore-overlay').classList.remove('active');
        },
        
        // P&L Tracking
        updatePnL() {
            const sessions = this.state.sessions;
            console.log('updatePnL called with sessions:', sessions.length);
            
            const today = new Date().toDateString();
            const todayPnL = sessions
                .filter(s => new Date(s.startTime).toDateString() === today)
                .reduce((sum, s) => sum + (s.pnl || 0), 0);
            
            const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const weekPnL = sessions
                .filter(s => new Date(s.startTime) >= oneWeekAgo)
                .reduce((sum, s) => sum + (s.pnl || 0), 0);
            
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const monthPnL = sessions
                .filter(s => {
                    const sessionDate = new Date(s.startTime);
                    return sessionDate.getMonth() === thisMonth && sessionDate.getFullYear() === thisYear;
                })
                .reduce((sum, s) => sum + (s.pnl || 0), 0);
            
            console.log('P&L values - Today:', todayPnL, 'Week:', weekPnL, 'Month:', monthPnL);
            
            this.displayPnL('pnl-today', todayPnL);
            this.displayPnL('pnl-week', weekPnL);
            this.displayPnL('pnl-month', monthPnL);
            
            this.renderPnLChart();
        },
        
        displayPnL(elementId, value) {
            console.log('displayPnL called:', elementId, value);
            const el = document.getElementById(elementId);
            if (!el) {
                console.error('Element not found:', elementId);
                return;
            }
            const formattedValue = Math.abs(value).toFixed(2);
            if (value === 0) {
                el.textContent = `$${formattedValue}`;
                el.className = 'pnl-value';
            } else if (value > 0) {
                el.textContent = `+$${formattedValue}`;
                el.className = 'pnl-value positive';
            } else {
                el.textContent = `-$${formattedValue}`;
                el.className = 'pnl-value negative';
            }
            console.log('displayPnL set element text to:', el.textContent);
        },
        
        renderPnLChart() {
            const ctx = document.getElementById('pnl-chart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (this.pnlChartInstance) {
                this.pnlChartInstance.destroy();
            }
            
            const sessions = [...this.state.sessions]
                .filter(s => s.pnl !== null && s.pnl !== undefined)
                .sort((a, b) => new Date(a.startTime) - new Date(b.startTime))
                .slice(-30); // Last 30 sessions with P&L
            
            if (sessions.length === 0) {
                // Show empty state in chart
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }
            
            const labels = sessions.map(s => new Date(s.startTime).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const data = sessions.map(s => s.pnl);
            
            // Cumulative P&L
            const cumulative = [];
            let sum = 0;
            data.forEach(val => {
                sum += val;
                cumulative.push(sum);
            });
            
            this.pnlChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Cumulative P&L',
                        data: cumulative,
                        borderColor: '#10b981',
                        backgroundColor: 'transparent',
                        tension: 0.3,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#111111',
                            titleColor: '#e5e5e5',
                            bodyColor: '#9ca3af',
                            borderColor: '#222222',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#6b7280' },
                            grid: { color: '#222222' },
                            border: { color: '#222222' }
                        },
                        x: {
                            ticks: { color: '#6b7280', maxRotation: 45 },
                            grid: { display: false },
                            border: { color: '#222222' }
                        }
                    }
                }
            });
        },
        
        showPnLDetails() {
            this.showAnalytics(); // Opens analytics which has detailed charts
        },
        
        // Quick Log (Ctrl+Q)
        populateQuickInstruments() {
            const instruments = new Set();
            this.state.sessions.forEach(s => {
                if (s.instrument) instruments.add(s.instrument);
            });
            
            const select = document.getElementById('quick-instrument');
            select.innerHTML = '<option value="">Select Instrument</option>';
            
            [...instruments].slice(0, 10).forEach(inst => {
                select.innerHTML += `<option value="${inst}">${inst}</option>`;
            });
            
            // Add common ones if not present
            const common = ['EUR/USD', 'GBP/USD', 'BTC/USD', 'ES', 'NQ'];
            common.forEach(inst => {
                if (!instruments.has(inst)) {
                    select.innerHTML += `<option value="${inst}">${inst}</option>`;
                }
            });
        },
        
        setupQuickLogKeyboard() {
            // Keyboard shortcuts in quick log modal
            document.addEventListener('keydown', (e) => {
                const modal = document.getElementById('quick-log-overlay');
                if (!modal.classList.contains('active')) return;
                
                if (e.key === 'w' || e.key === 'W') {
                    this.selectQuickOutcome('win');
                } else if (e.key === 'l' || e.key === 'L') {
                    this.selectQuickOutcome('loss');
                } else if (e.key === 'b' || e.key === 'B') {
                    this.selectQuickOutcome('breakeven');
                } else if (e.key === 'Enter' && this.quickOutcome) {
                    this.saveQuickLog();
                }
            });
        },
        
        openQuickLog() {
            this.populateQuickInstruments();
            document.getElementById('quick-log-overlay').classList.add('active');
            this.quickOutcome = null;
            
            // Reset form
            document.querySelectorAll('.quick-outcome-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('quick-instrument').value = '';
            document.getElementById('quick-pnl').value = '';
            document.getElementById('quick-note').value = '';
            document.getElementById('quick-save-btn').disabled = true;
        },
        
        selectQuickOutcome(outcome) {
            this.quickOutcome = outcome;
            
            document.querySelectorAll('.quick-outcome-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelector(`.quick-outcome-btn.${outcome}`).classList.add('selected');
            
            // Enable save if instrument is also selected
            const hasInstrument = document.getElementById('quick-instrument').value !== '';
            document.getElementById('quick-save-btn').disabled = !hasInstrument;
        },
        
        saveQuickLog() {
            if (!this.quickOutcome) {
                this.showToast('Please select an outcome', 'warning');
                return;
            }
            
            const instrument = document.getElementById('quick-instrument').value;
            if (!instrument) {
                this.showToast('Please select an instrument', 'warning');
                return;
            }
            
            const session = {
                id: `session-${Date.now()}`,
                startTime: new Date().toISOString(),
                instrument,
                outcome: this.quickOutcome,
                pnl: parseFloat(document.getElementById('quick-pnl').value) || null,
                postNotes: document.getElementById('quick-note').value,
                type: 'quick',
                mood: 'neutral',
                confidence: 7,
                duration: 60, // Estimated
                mistakes: []
            };
            
            this.state.sessions.unshift(session);
            
            if (this.saveSessionsWithErrorHandling()) {
                this.closeQuickLog();
                this.renderDashboard();
                this.updateUserStats();
                this.updateQuickStats();
                this.updateEdgeScore();
                this.updatePnL();
                this.checkAndUnlockAchievements();
                this.checkPatterns();
                this.showToast('Session logged successfully', 'success');
            }
        },
        
        closeQuickLog() {
            document.getElementById('quick-log-overlay').classList.remove('active');
            this.quickOutcome = null;
        },
        
        // Monthly Report
        showMonthlyReport() {
            const now = new Date();
            const month = now.getMonth();
            const year = now.getFullYear();
            
            const monthSessions = this.state.sessions.filter(s => {
                const d = new Date(s.startTime);
                return d.getMonth() === month && d.getFullYear() === year;
            });
            
            if (monthSessions.length === 0) {
                this.showToast('No sessions this month yet', 'info');
                return;
            }
            
            const monthName = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const wins = monthSessions.filter(s => s.outcome === 'win').length;
            const winRate = ((wins / monthSessions.length) * 100).toFixed(1);
            const totalPnL = monthSessions.reduce((sum, s) => sum + (s.pnl || 0), 0);
            const avgDuration = Math.round(monthSessions.reduce((sum, s) => sum + (s.duration || 0), 0) / monthSessions.length);
            
            const bestDay = monthSessions.reduce((best, s) => (s.pnl || 0) > (best.pnl || 0) ? s : best, monthSessions[0]);
            const longestStreak = this.calculateCurrentStreak(monthSessions);
            
            const report = `
                <div class="report-card">
                    <div class="report-header">
                        <h3 class="text-2xl font-bold">${monthName} Report Card</h3>
                        <p class="text-sm text-secondary mt-1">Generated ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <div class="report-stats-grid">
                        <div class="report-stat">
                            <div class="text-xs text-muted uppercase">Total Sessions</div>
                            <div class="report-stat-value">${monthSessions.length}</div>
                        </div>
                        <div class="report-stat">
                            <div class="text-xs text-muted uppercase">Win Rate</div>
                            <div class="report-stat-value">${winRate}%</div>
                        </div>
                        <div class="report-stat">
                            <div class="text-xs text-muted uppercase">Total P&L</div>
                            <div class="report-stat-value ${totalPnL >= 0 ? 'text-success' : 'text-error'}">
                                ${totalPnL >= 0 ? '+' : ''}$${totalPnL.toFixed(2)}
                            </div>
                        </div>
                        <div class="report-stat">
                            <div class="text-xs text-muted uppercase">Avg Duration</div>
                            <div class="report-stat-value">${avgDuration}m</div>
                        </div>
                        <div class="report-stat">
                            <div class="text-xs text-muted uppercase">Best Day</div>
                            <div class="report-stat-value text-success">+$${(bestDay.pnl || 0).toFixed(2)}</div>
                        </div>
                        <div class="report-stat">
                            <div class="text-xs text-muted uppercase">Longest Streak</div>
                            <div class="report-stat-value">${longestStreak}</div>
                        </div>
                    </div>
                    
                    <div class="report-insights">
                        <h4 class="font-semibold mb-2">üìä Key Insights</h4>
                        <ul class="text-sm space-y-1">
                            ${this.generateReportInsights(monthSessions).map(i => `<li>‚Ä¢ ${i}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="mt-4">
                        <h4 class="font-semibold mb-2">üéØ Goals for Next Month</h4>
                        <ul class="report-goals">
                            ${this.generateMonthlyGoals(monthSessions).map(g => `
                                <li><iconify-icon icon="solar:target-bold" class="text-secondary"></iconify-icon> ${g}</li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="app.closeReport()" class="btn-secondary flex-1">Close</button>
                        <button onclick="app.downloadReport()" class="btn-primary flex-1">
                            <iconify-icon icon="solar:download-bold" width="16" class="inline mr-2"></iconify-icon>
                            Download PDF
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('monthly-report-content').innerHTML = report;
            document.getElementById('report-overlay').classList.add('active');
        },
        
        generateReportInsights(sessions) {
            const insights = [];
            const wins = sessions.filter(s => s.outcome === 'win').length;
            const winRate = (wins / sessions.length) * 100;
            
            if (winRate >= 60) {
                insights.push(`Strong performance with ${winRate.toFixed(1)}% win rate`);
            } else if (winRate < 50) {
                insights.push(`Win rate at ${winRate.toFixed(1)}% - focus on quality setups`);
            }
            
            const totalPnL = sessions.reduce((sum, s) => sum + (s.pnl || 0), 0);
            if (totalPnL > 0) {
                insights.push(`Profitable month with +$${totalPnL.toFixed(2)} total P&L`);
            }
            
            const avgMistakes = sessions.reduce((sum, s) => sum + (s.mistakes?.length || 0), 0) / sessions.length;
            if (avgMistakes < 1) {
                insights.push('Excellent discipline - low mistake rate');
            }
            
            return insights.length > 0 ? insights : ['Keep building consistent trading habits'];
        },
        
        generateMonthlyGoals(sessions) {
            const goals = [];
            const winRate = (sessions.filter(s => s.outcome === 'win').length / sessions.length) * 100;
            
            if (winRate < 60) {
                goals.push('Improve win rate to 60%+');
            }
            
            const avgMistakes = sessions.reduce((sum, s) => sum + (s.mistakes?.length || 0), 0) / sessions.length;
            if (avgMistakes > 1) {
                goals.push('Reduce mistakes to less than 1 per session');
            }
            
            goals.push('Maintain consistent journaling (5+ sessions/week)');
            goals.push('Focus on high-confidence setups only');
            
            return goals;
        },
        
        downloadReport() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const now = new Date();
                const monthName = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                const month = now.getMonth();
                const year = now.getFullYear();
                
                const monthSessions = this.state.sessions.filter(s => {
                    const d = new Date(s.startTime);
                    return d.getMonth() === month && d.getFullYear() === year;
                });
                
                if (monthSessions.length === 0) {
                    this.showToast('No sessions this month to export', 'warning');
                    return;
                }
                
                // Title
                doc.setFontSize(20);
                doc.text('EdgeMetrics - Monthly Report', 20, 20);
                
                doc.setFontSize(14);
                doc.text(monthName, 20, 30);
                
                // Stats
                doc.setFontSize(10);
                const wins = monthSessions.filter(s => s.outcome === 'win').length;
                const winRate = ((wins / monthSessions.length) * 100).toFixed(1);
                const totalPnL = monthSessions.reduce((sum, s) => sum + (s.pnl || 0), 0);
                const avgDuration = Math.round(monthSessions.reduce((sum, s) => sum + (s.duration || 0), 0) / monthSessions.length);
                
                let yPos = 45;
                doc.text(`Total Sessions: ${monthSessions.length}`, 20, yPos);
                yPos += 7;
                doc.text(`Win Rate: ${winRate}%`, 20, yPos);
                yPos += 7;
                doc.text(`Total P&L: $${totalPnL.toFixed(2)}`, 20, yPos);
                yPos += 7;
                doc.text(`Avg Duration: ${avgDuration}m`, 20, yPos);
                yPos += 15;
                
                // Sessions list
                doc.setFontSize(12);
                doc.text('Session History', 20, yPos);
                yPos += 7;
                
                doc.setFontSize(8);
                monthSessions.slice(0, 20).forEach((session, i) => {
                    const date = new Date(session.startTime).toLocaleDateString();
                    const outcome = session.outcome.charAt(0).toUpperCase() + session.outcome.slice(1);
                    const text = `${date} - ${session.instrument} - ${outcome}`;
                    doc.text(text, 20, yPos);
                    yPos += 5;
                    
                    if (yPos > 280) { // New page if needed
                        doc.addPage();
                        yPos = 20;
                    }
                });
                
                // Save
                doc.save(`EdgeMetrics-Report-${monthName.replace(' ', '-')}.pdf`);
                this.showToast('PDF downloaded successfully', 'success');
            } catch (error) {
                console.error('PDF generation error:', error);
                this.showToast('Failed to generate PDF', 'error');
            }
        },
        
        closeReport() {
            document.getElementById('report-overlay').classList.remove('active');
        },
        
        // Pattern Detection & Alerts
        checkPatterns() {
            const container = document.getElementById('pattern-alerts');
            const sessions = this.state.sessions.slice(0, 10); // Recent 10
            const alerts = [];
            
            // Check for recent mistakes
            const recentMistakes = sessions.slice(0, 3).filter(s => s.mistakes && s.mistakes.length > 0).length;
            if (recentMistakes >= 2) {
                alerts.push({
                    type: 'warning',
                    icon: 'solar:danger-triangle-bold',
                    message: `Rule violations in ${recentMistakes} of last 3 sessions. Review your trading plan.`
                });
            }
            
            // Check for win streak
            let streak = 0;
            for (const s of sessions) {
                if (s.outcome === 'win') streak++;
                else break;
            }
            if (streak >= 5) {
                alerts.push({
                    type: 'success',
                    icon: 'solar:fire-bold',
                    message: `${streak} session win streak! Great momentum - stay disciplined.`
                });
            }
            
            // Check for loss streak
            let lossStreak = 0;
            for (const s of sessions) {
                if (s.outcome === 'loss') lossStreak++;
                else break;
            }
            if (lossStreak >= 3) {
                alerts.push({
                    type: 'warning',
                    icon: 'solar:shield-warning-bold',
                    message: `${lossStreak} consecutive losses. Consider taking a break to reset.`
                });
            }
            
            // Check for good discipline
            const noMistakes = sessions.filter(s => !s.mistakes || s.mistakes.length === 0).length;
            if (noMistakes === sessions.length && sessions.length >= 5) {
                alerts.push({
                    type: 'success',
                    icon: 'solar:medal-star-bold',
                    message: `Perfect discipline streak! ${sessions.length} sessions with no rule violations.`
                });
            }
            
            // Render alerts
            container.innerHTML = alerts.map(alert => `
                <div class="pattern-alert ${alert.type}">
                    <iconify-icon icon="${alert.icon}" width="24" class="text-${alert.type === 'success' ? 'success' : alert.type === 'warning' ? 'warning' : 'secondary'}"></iconify-icon>
                    <div class="flex-1">
                        <div class="font-semibold text-sm mb-1">${alert.type === 'success' ? '‚úì Great Job!' : '‚ö†Ô∏è Alert'}</div>
                        <div class="text-sm text-secondary">${alert.message}</div>
                    </div>
                </div>
            `).join('');
        },
        
        // Journal Prompts
        showDailyPrompt() {
            const prompts = [
                "What was your edge in this trade?",
                "How did you manage your risk today?",
                "What could you have done better?",
                "What did you learn from this session?",
                "How did your emotions affect your trading?",
                "Did you follow your rules? If not, why?",
                "What pattern were you trading?",
                "How confident were you (honestly)?",
                "Would you take this trade again?",
                "What was different about your best trade today?"
            ];
            
            const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
            const promptElement = document.getElementById('prompt-text');
            if (promptElement) {
                promptElement.textContent = randomPrompt;
            } else {
                // Retry after a short delay if element not found
                setTimeout(() => {
                    const retryElement = document.getElementById('prompt-text');
                    if (retryElement) {
                        retryElement.textContent = randomPrompt;
                    }
                }, 500);
            }
        },
        
        // Update keyboard shortcuts to include new features
        setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+N: New Session
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    this.startSession();
                }
                // Ctrl+Q: Quick Log
                if (e.ctrlKey && e.key === 'q') {
                    e.preventDefault();
                    this.openQuickLog();
                }
                // Ctrl+A: Analytics
                if (e.ctrlKey && e.key === 'a') {
                    e.preventDefault();
                    this.showAnalytics();
                }
                // Ctrl+L: Learning
                if (e.ctrlKey && e.key === 'l') {
                    e.preventDefault();
                    this.showLearning();
                }
                // Ctrl+E: Export Menu
                if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    this.toggleExportMenu();
                }
                // Ctrl+H: Achievements (H for honors/achievements)
                if (e.ctrlKey && e.key === 'h') {
                    e.preventDefault();
                    this.showAchievements();
                }
                // Escape: Close overlays
                if (e.key === 'Escape') {
                    this.closeAllOverlays();
                }
            });
        },
        
        closeAllOverlays() {
            document.getElementById('session-overlay').classList.remove('active');
            document.getElementById('analytics-overlay').classList.remove('active');
            document.getElementById('learning-overlay').classList.remove('active');
            document.getElementById('export-menu').classList.remove('active');
            document.getElementById('quick-log-overlay').classList.remove('active');
            document.getElementById('achievements-overlay').classList.remove('active');
            document.getElementById('edgescore-overlay').classList.remove('active');
            document.getElementById('report-overlay').classList.remove('active');
        },

        loadSessions() {
            const stored = localStorage.getItem('edgemetrics_sessions');
            this.state.sessions = stored ? JSON.parse(stored) : this.generateSampleSessions();
            
            // Check if existing sessions need P&L data added
            let needsUpdate = false;
            this.state.sessions = this.state.sessions.map(session => {
                if (session.pnl === undefined || session.pnl === null) {
                    needsUpdate = true;
                    // Add P&L based on outcome
                    let pnl = 0;
                    if (session.outcome === 'win') {
                        pnl = Math.random() * 500 + 50;
                    } else if (session.outcome === 'loss') {
                        pnl = -(Math.random() * 300 + 20);
                    }
                    return { ...session, pnl: pnl };
                }
                return session;
            });
            
            // Save back if we added P&L values
            if (needsUpdate) {
                console.log('Added P&L to existing sessions');
                this.saveSessions();
            }
            
            // Load favorite instruments
            const storedFavorites = localStorage.getItem('edgemetrics_favorites');
            this.state.favoriteInstruments = storedFavorites ? JSON.parse(storedFavorites) : [];
        },

        saveSessions() {
            localStorage.setItem('edgemetrics_sessions', JSON.stringify(this.state.sessions));
        },
        
        saveFavorites() {
            localStorage.setItem('edgemetrics_favorites', JSON.stringify(this.state.favoriteInstruments));
        },
        
        loadFavorites() {
            const storedFavorites = localStorage.getItem('edgemetrics_favorites');
            this.state.favoriteInstruments = storedFavorites ? JSON.parse(storedFavorites) : [];
        },

        generateSampleSessions() {
            const outcomes = ['win', 'loss', 'breakeven'];
            const moods = ['focused', 'confident', 'anxious', 'tired'];
            const instruments = ['EUR/USD', 'BTC/USD', 'ES', 'NQ'];
            
            const sessions = [];
            for (let i = 0; i < 15; i++) {
                const outcome = outcomes[Math.floor(Math.random() * outcomes.length)];
                let pnl = 0;
                if (outcome === 'win') {
                    pnl = Math.random() * 500 + 50; // Random between $50-$550
                } else if (outcome === 'loss') {
                    pnl = -(Math.random() * 300 + 20); // Random between -$20 to -$320
                }
                // breakeven stays 0
                
                sessions.push({
                    id: `session-${Date.now()}-${i}`,
                    startTime: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
                    instrument: instruments[Math.floor(Math.random() * instruments.length)],
                    mood: moods[Math.floor(Math.random() * moods.length)],
                    outcome: outcome,
                    pnl: pnl,
                    mistakes: [],
                    duration: Math.floor(Math.random() * 120) + 30
                });
            }
            return sessions.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
        },

        updateUserStats() {
            const sessions = this.state.sessions;
            if (sessions.length === 0) {
                document.getElementById('user-stats').textContent = "No sessions yet";
                return;
            }
            const wins = sessions.filter(s => s.outcome === 'win').length;
            const winRate = ((wins / sessions.length) * 100).toFixed(1);
            document.getElementById('user-stats').textContent = `Sessions: ${sessions.length} | Win Rate: ${winRate}%`;
        },

        renderDashboard() {
            console.log('renderDashboard called');
            // Use filtered sessions if filters are active, otherwise use all sessions
            const sessions = this.state.filteredSessions || this.state.sessions;
            const allSessions = this.state.sessions; // Always use all sessions for stats
            
            console.log('Sessions to display:', sessions.length, 'All sessions:', allSessions.length);
            
            // Update stats based on ALL sessions (not filtered)
            document.getElementById('total-sessions').textContent = allSessions.length;
            
            const wins = allSessions.filter(s => s.outcome === 'win').length;
            const winRate = allSessions.length > 0 ? ((wins / allSessions.length) * 100).toFixed(1) : 0;
            document.getElementById('win-rate').textContent = `${winRate}%`;
            
            const avgDuration = allSessions.length > 0 
                ? Math.round(allSessions.reduce((sum, s) => sum + (s.duration || 0), 0) / allSessions.length)
                : 0;
            document.getElementById('avg-duration').textContent = `${avgDuration}m`;
            
            const avgMistakes = allSessions.length > 0
                ? allSessions.reduce((sum, s) => sum + (s.mistakes?.length || 0), 0) / allSessions.length
                : 0;
            const ruleScore = Math.max(0, 100 - Math.round(avgMistakes * 25));
            document.getElementById('rule-score').textContent = `${ruleScore}%`;

            // Populate instrument filter dropdown
            const instrumentFilter = document.getElementById('instrument-filter');
            if (instrumentFilter) {
                const instruments = this.getUniqueInstruments();
                const currentValue = instrumentFilter.value;
                instrumentFilter.innerHTML = '<option value="all">All Instruments</option>' +
                    instruments.map(inst => `<option value="${inst}">${inst}</option>`).join('');
                instrumentFilter.value = currentValue;
            }

            const recentContainer = document.getElementById('recent-sessions');
            const emptyState = document.getElementById('empty-sessions-state');
            
            if (!recentContainer) {
                console.error('recent-sessions element not found');
                return;
            }
            
            if (sessions.length === 0) {
                // Show empty state
                if (emptyState) {
                    emptyState.classList.remove('hidden');
                }
                recentContainer.innerHTML = this.state.filteredSessions ? 
                    '<div class="text-center py-8 text-secondary">No sessions match your filters</div>' : '';
            } else {
                // Hide empty state and show sessions
                if (emptyState) {
                    emptyState.classList.add('hidden');
                }
                console.log('Rendering', sessions.length, 'sessions. First session:', sessions[0]);
                recentContainer.innerHTML = sessions.slice(0, 8).map((session, index) => {
                    const date = new Date(session.startTime);
                    const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const formattedTime = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    
                    return `
                        <div class="session-card outcome-${session.outcome} fade-in" data-session-id="${session.id}" style="animation-delay: ${index * 0.05}s;">
                            <div class="flex items-start justify-between">
                                <div class="flex-1" onclick="app.viewSessionDetails('${session.id}')" style="cursor: pointer;">
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="text-sm font-medium">${session.instrument}</span>
                                        <span class="text-xs text-muted">‚Ä¢</span>
                                        <span class="text-xs text-muted capitalize">${session.mood}</span>
                                        ${session.duration ? `
                                            <span class="text-xs text-muted">‚Ä¢</span>
                                            <span class="text-xs text-muted">${session.duration}m</span>
                                        ` : ''}
                                    </div>
                                    <div class="text-xs text-secondary">${formattedDate} ${formattedTime}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-medium ${session.outcome === 'win' ? 'text-success' : session.outcome === 'loss' ? 'text-error' : 'text-muted'}">
                                        ${session.outcome.charAt(0).toUpperCase() + session.outcome.slice(1)}
                                    </div>
                                    ${session.pnl !== undefined && session.pnl !== null ? `
                                        <div class="text-xs font-mono mt-1 ${session.pnl > 0 ? 'text-success' : session.pnl < 0 ? 'text-error' : 'text-muted'}">
                                            ${session.pnl > 0 ? '+' : ''}$${Math.abs(session.pnl).toFixed(2)}
                                        </div>
                                    ` : ''}
                                    ${session.mistakes?.length > 0 ? `
                                        <div class="text-xs text-muted mt-1">${session.mistakes.length} mistake${session.mistakes.length > 1 ? 's' : ''}</div>
                                    ` : ''}
                                    <button onclick="event.stopPropagation(); app.selectForComparison('${session.id}')" 
                                            class="text-xs text-blue-500 hover:text-blue-400 mt-2 hover:underline">
                                        üìä Compare
                                    </button>
                                </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Show/hide data warning banner on first visit
            const bannerDismissed = localStorage.getItem('edgemetrics-banner-dismissed');
            const banner = document.getElementById('data-warning-banner');
            if (banner && !bannerDismissed && allSessions.length > 0) {
                banner.style.display = 'block';
            }
            
            // Update all displays
            this.updateStreakDisplays();
            this.updateQuickStats();
            this.updatePnL();
        },

        startSession() {
            this.state.currentStep = 1;
            this.state.currentSession = {
                id: `session-${Date.now()}`,
                startTime: new Date().toISOString(),
                screenshots: [], // Initialize empty screenshots array
                tags: '', // Initialize empty tags
                entryPrice: null,
                exitPrice: null
            };
            this.state.actionLog = [];
            
            // Stop any existing price updates
            if (this.priceUpdateInterval) {
                clearInterval(this.priceUpdateInterval);
                this.priceUpdateInterval = null;
            }
            
            // Clear form inputs for new session
            setTimeout(() => {
                // Clear tags input
                const tagsInput = document.getElementById('session-tags');
                if (tagsInput) tagsInput.value = '';
                
                // Clear screenshots
                const screenshotInput = document.getElementById('session-screenshots');
                const screenshotPreview = document.getElementById('screenshot-preview');
                if (screenshotInput) screenshotInput.value = '';
                if (screenshotPreview) screenshotPreview.innerHTML = '';
                
                // Hide live chart
                const chartContainer = document.getElementById('live-chart-container');
                if (chartContainer) chartContainer.classList.add('hidden');
                
                // Reset trade execution UI
                const executeSection = document.getElementById('execute-trade-section');
                const activeTradeDisplay = document.getElementById('active-trade-display');
                if (executeSection) executeSection.classList.remove('hidden');
                if (activeTradeDisplay) activeTradeDisplay.classList.add('hidden');
                
                // Clear other form fields
                const preNotes = document.getElementById('session-pre-notes');
                if (preNotes) preNotes.value = '';
                
                const postNotes = document.getElementById('session-post-notes');
                if (postNotes) postNotes.value = '';
                
                const pnlInput = document.getElementById('session-pnl');
                if (pnlInput) pnlInput.value = '';
                
                // Reset checkboxes
                document.querySelectorAll('.mistake-checkbox').forEach(cb => cb.checked = false);
                
                // Reset mood selection
                document.querySelectorAll('.mood-option').forEach(el => el.classList.remove('selected'));
                this.state.selectedMood = null;
            }, 50);
            
            this.nextStep(1);
            document.getElementById('session-overlay').classList.add('active');
            
            // Update instrument dropdown to include favorites
            setTimeout(() => {
                this.updateInstrumentDropdown();
            }, 100);
            
            // Reinitialize tag suggestions
            setTimeout(() => {
                this.initializeTagSuggestions();
            }, 100);
            
            // Setup confidence slider after modal is visible
            setTimeout(() => {
                const confidenceSlider = document.getElementById('session-confidence');
                const confidenceDisplay = document.getElementById('confidence-display');
                if (confidenceSlider && confidenceDisplay) {
                    // Reset to default
                    confidenceSlider.value = 5;
                    confidenceDisplay.textContent = '5';
                    
                    // Remove any existing listener
                    confidenceSlider.replaceWith(confidenceSlider.cloneNode(true));
                    const newSlider = document.getElementById('session-confidence');
                    
                    newSlider.addEventListener('input', (e) => {
                        confidenceDisplay.textContent = e.target.value;
                    });
                }
            }, 100);
        },

        nextStep(step) {
            this.state.currentStep = step;
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`session-step-${i}`).classList.add('hidden');
            }
            document.getElementById(`session-step-${step}`).classList.remove('hidden');
        },

        selectMood(mood) {
            this.state.selectedMood = mood;
            document.querySelectorAll('.mood-option').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-mood="${mood}"]`).classList.add('selected');
        },

        startLiveSession() {
            const instrument = document.getElementById('session-instrument').value;
            const sessionType = document.getElementById('session-type').value;
            const risk = document.getElementById('session-risk').value;
            const confidence = document.getElementById('session-confidence').value;
            const preNotes = document.getElementById('session-pre-notes').value;
            const tags = document.getElementById('session-tags').value; // Capture tags
            const quantity = document.getElementById('session-quantity').value; // Capture quantity

            if (!instrument || !this.state.selectedMood) {
                this.showToast('Please select instrument and emotional state', 'warning');
                return;
            }

            Object.assign(this.state.currentSession, {
                instrument,
                sessionType,
                risk,
                mood: this.state.selectedMood,
                confidence,
                preNotes,
                tags: tags || '', // Save tags with session
                quantity: quantity ? parseFloat(quantity) : null // Save quantity
            });

            document.getElementById('live-instrument').textContent = instrument;
            document.getElementById('live-mood').textContent = this.state.selectedMood;
            document.getElementById('live-confidence').textContent = `${confidence}/10`;
            
            const startTime = new Date(this.state.currentSession.startTime);
            document.getElementById('session-start-time').textContent = startTime.toLocaleString();

            // Start the session timer
            this.startSessionTimer();
            this.showToast('Trading session started', 'success');
            
            this.nextStep(3);
        },

        logAction(action) {
            this.state.actionLog.push({
                type: action,
                time: new Date().toISOString()
            });
            
            const trades = this.state.actionLog.filter(a => a.type === 'trade').length;
            const skips = this.state.actionLog.filter(a => a.type === 'skip').length;
            
            document.getElementById('action-log').textContent = 
                `Trades: ${trades} | Skipped: ${skips}`;
        },

        // ===== NEW: BUY/SELL SELECTION =====
        
        selectDirection(direction) {
            this.state.selectedDirection = direction;
            
            // Update UI
            const buyBtn = document.getElementById('direction-buy');
            const sellBtn = document.getElementById('direction-sell');
            
            buyBtn.classList.remove('border-success');
            sellBtn.classList.remove('border-error');
            buyBtn.style.borderColor = '';
            sellBtn.style.borderColor = '';
            
            if (direction === 'buy') {
                buyBtn.style.borderColor = '#10b981';
                buyBtn.style.borderWidth = '2px';
            } else {
                sellBtn.style.borderColor = '#ef4444';
                sellBtn.style.borderWidth = '2px';
            }
        },

        // ===== NEW: AUTO PRICE CAPTURE FUNCTIONS =====
        
        onInstrumentSelected() {
            const instrument = document.getElementById('session-instrument').value;
            const chartContainer = document.getElementById('live-chart-container');
            
            if (instrument) {
                // Show the live chart
                chartContainer.classList.remove('hidden');
                
                // Load TradingView chart for the selected instrument
                setTimeout(() => {
                    this.loadLiveChart(instrument, 'tradingview-widget-step1');
                }, 100);
                
                // Also update favorite toggle
                this.addFavoriteToggleButton();
            } else {
                chartContainer.classList.add('hidden');
            }
        },
        
        loadLiveChart(instrument, containerId) {
            const symbol = this.convertToTradingViewSymbol(instrument);
            const container = document.getElementById(containerId);
            
            if (!container) {
                console.error('Chart container not found:', containerId);
                return;
            }
            
            // Load TradingView library if not loaded
            if (!window.TradingView) {
                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/tv.js';
                script.onload = () => {
                    this.createLiveChartWidget(symbol, containerId);
                };
                script.onerror = () => {
                    console.error('Failed to load TradingView library');
                    container.innerHTML = '<div class="text-center text-error p-4">Failed to load chart</div>';
                };
                document.head.appendChild(script);
            } else {
                this.createLiveChartWidget(symbol, containerId);
            }
        },
        
        createLiveChartWidget(symbol, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            try {
                container.innerHTML = '';
                
                // Store widget reference
                this.currentChartWidget = new window.TradingView.widget({
                    container_id: containerId,
                    width: '100%',
                    height: 350,
                    symbol: symbol,
                    interval: '5',
                    timezone: 'Etc/UTC',
                    theme: 'dark',
                    style: '1',
                    locale: 'en',
                    toolbar_bg: '#0a0a0a',
                    enable_publishing: false,
                    hide_side_toolbar: false,
                    allow_symbol_change: false,
                    save_image: true,
                    studies: [],
                    disabled_features: ['use_localstorage_for_settings'],
                    enabled_features: ['study_templates'],
                    loading_screen: { backgroundColor: '#0a0a0a' },
                    overrides: {
                        'paneProperties.background': '#0a0a0a',
                        'paneProperties.vertGridProperties.color': '#1a1a1a',
                        'paneProperties.horzGridProperties.color': '#1a1a1a',
                        'scalesProperties.textColor': '#999999',
                        'mainSeriesProperties.candleStyle.upColor': '#10b981',
                        'mainSeriesProperties.candleStyle.downColor': '#ef4444',
                        'mainSeriesProperties.candleStyle.borderUpColor': '#10b981',
                        'mainSeriesProperties.candleStyle.borderDownColor': '#ef4444',
                        'mainSeriesProperties.candleStyle.wickUpColor': '#10b981',
                        'mainSeriesProperties.candleStyle.wickDownColor': '#ef4444'
                    }
                });
                
                // Simulate price updates (in real scenario, use TradingView datafeed)
                this.startPriceSimulation(symbol);
                
            } catch (error) {
                console.error('Error creating chart:', error);
                container.innerHTML = '<div class="text-center text-error p-4">Error loading chart</div>';
            }
        },
        
        startPriceSimulation(symbol) {
            // Use realistic 2026 market prices
            const basePrices = {
                'FX:EURUSD': 1.0425,
                'FX:GBPUSD': 1.2415,
                'FX:USDJPY': 155.20,
                'FX:USDCHF': 0.9145,
                'FX:AUDUSD': 0.6235,
                'FX:USDCAD': 1.4325,
                'FX:NZDUSD': 0.5685,
                'TVC:GOLD': 2685.50,
                'FX:XAUUSD': 2685.50,
                'BINANCE:BTCUSDT': 67750.00,
                'BINANCE:ETHUSDT': 3420.00,
                'SP:SPX': 5980.00,
                'DJ:DJI': 44250.00,
                'NASDAQ:NDX': 21450.00
            };
            
            let basePrice = basePrices[symbol] || 1.0000;
            
            // Update current price display
            const updatePrice = () => {
                const variation = (Math.random() - 0.5) * (basePrice * 0.0002);
                const currentPrice = basePrice + variation;
                const priceDisplay = document.getElementById('current-price-display');
                
                if (priceDisplay) {
                    priceDisplay.textContent = currentPrice.toFixed(symbol.includes('JPY') ? 2 : 5);
                }
                
                // Update live P&L if trade is active
                if (this.state.currentSession && this.state.currentSession.entryPrice) {
                    const direction = this.state.currentSession.direction || 'buy';
                    let livePnL;
                    
                    if (direction === 'buy') {
                        livePnL = ((currentPrice - this.state.currentSession.entryPrice) / this.state.currentSession.entryPrice) * 100;
                    } else {
                        livePnL = ((this.state.currentSession.entryPrice - currentPrice) / this.state.currentSession.entryPrice) * 100;
                    }
                    
                    const livePnLDisplay = document.getElementById('live-pnl');
                    const liveCurrentPrice = document.getElementById('live-current-price');
                    
                    if (livePnLDisplay && liveCurrentPrice) {
                        liveCurrentPrice.textContent = currentPrice.toFixed(symbol.includes('JPY') ? 2 : 5);
                        livePnLDisplay.textContent = `P&L: ${livePnL > 0 ? '+' : ''}${livePnL.toFixed(2)}%`;
                        livePnLDisplay.className = livePnL >= 0 ? 'text-xs mt-1 text-success' : 'text-xs mt-1 text-error';
                    }
                }
            };
            
            // Update every 2 seconds
            this.priceUpdateInterval = setInterval(updatePrice, 2000);
            updatePrice(); // Initial update
        },
        
        executeTrade() {
            const instrument = document.getElementById('session-instrument').value;
            const currentPriceEl = document.getElementById('current-price-display');
            const direction = this.state.selectedDirection || 'buy';
            
            if (!instrument) {
                this.showToast('Please select an instrument first', 'warning');
                return;
            }
            
            if (!this.state.selectedDirection) {
                this.showToast('Please select BUY or SELL direction', 'warning');
                return;
            }
            
            const entryPrice = parseFloat(currentPriceEl.textContent);
            const entryTime = new Date();
            
            if (isNaN(entryPrice)) {
                this.showToast('Unable to capture price. Please wait for chart to load', 'warning');
                return;
            }
            
            // Save entry data to session
            this.state.currentSession.entryPrice = entryPrice;
            this.state.currentSession.entryTime = entryTime.toISOString();
            this.state.currentSession.direction = direction;
            
            // Update UI
            document.getElementById('entry-price-display').textContent = entryPrice.toFixed(5);
            document.getElementById('entry-time-display').textContent = entryTime.toLocaleTimeString();
            
            // Show active trade display, hide execute button
            document.getElementById('execute-trade-section').classList.add('hidden');
            document.getElementById('active-trade-display').classList.remove('hidden');
            
            // Log the trade action
            this.logAction('trade');
            
            this.showToast(`Trade executed at ${entryPrice.toFixed(5)}`, 'success');
        },
        
        reflectTrade() {
            const currentPriceEl = document.getElementById('live-current-price');
            const exitPrice = parseFloat(currentPriceEl.textContent);
            const exitTime = new Date();
            
            if (isNaN(exitPrice)) {
                this.showToast('Unable to capture exit price', 'warning');
                return;
            }
            
            // Save exit data to session
            this.state.currentSession.exitPrice = exitPrice;
            this.state.currentSession.exitTime = exitTime.toISOString();
            
            // Calculate P&L based on direction
            const entryPrice = this.state.currentSession.entryPrice;
            const direction = this.state.currentSession.direction || 'buy';
            const quantity = this.state.currentSession.quantity || 1;
            const instrument = this.state.currentSession.instrument;
            
            // Determine contract size based on instrument
            let contractSize = 100000; // Default: 1 lot forex = 100,000 units
            
            if (instrument.includes('XAU') || instrument.includes('Gold')) {
                contractSize = 100; // Gold: 1 lot = 100 oz
            } else if (instrument.includes('BTC') || instrument.includes('ETH')) {
                contractSize = 1; // Crypto: 1 contract = 1 coin
            } else if (instrument.includes('US') || instrument.includes('SPX') || instrument.includes('NAS')) {
                contractSize = 1; // Indices: 1 contract = 1 point
            }
            
            let pnlPercent;
            let pnlDollar;
            let priceDiff;
            
            if (direction === 'buy') {
                priceDiff = exitPrice - entryPrice;
                pnlPercent = (priceDiff / entryPrice) * 100;
            } else {
                // For SELL trades, profit when price goes down
                priceDiff = entryPrice - exitPrice;
                pnlPercent = (priceDiff / entryPrice) * 100;
            }
            
            // Calculate dollar P&L: Price Difference √ó Quantity √ó Contract Size
            pnlDollar = priceDiff * quantity * contractSize;
            
            this.state.currentSession.autoPnL = pnlPercent;
            this.state.currentSession.pnlDollar = pnlDollar;
            
            // Capture chart screenshot with entry/exit markers
            this.captureChartScreenshot();
            
            this.showToast(`Trade closed: ${pnlPercent > 0 ? '+' : ''}${pnlPercent.toFixed(2)}% (${pnlDollar > 0 ? '+' : ''}$${Math.abs(pnlDollar).toFixed(2)})`, pnlPercent >= 0 ? 'success' : 'error');
            
            // Move to end session
            setTimeout(() => {
                this.endSession();
            }, 1500);
        },
        
        async captureChartScreenshot() {
            try {
                // Create a canvas to draw the chart with entry/exit markers
                const chartContainer = document.getElementById('tradingview-widget-step1');
                if (!chartContainer) return;
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set canvas size - larger for better quality
                canvas.width = 1200;
                canvas.height = 600;
                
                // WHITE BACKGROUND like example
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Add "OPEN TRADE" watermark
                ctx.fillStyle = 'rgba(200, 200, 200, 0.3)';
                ctx.font = 'bold 80px Arial, sans-serif';
                ctx.fillText('OPEN TRADE', 50, 100);
                
                // Add instrument and timeframe info
                const instrument = this.state.currentSession.instrument;
                const direction = this.state.currentSession.direction.toUpperCase();
                
                ctx.fillStyle = '#333333';
                ctx.font = '14px Arial, sans-serif';
                ctx.fillText(`${instrument} M30`, 10, 20);
                
                // Draw simulated candlestick chart
                const chartY = 130;
                const chartHeight = 380;
                const chartX = 100;
                const chartWidth = 1000;
                
                // Calculate price range
                const entryPrice = this.state.currentSession.entryPrice;
                const exitPrice = this.state.currentSession.exitPrice;
                const priceRange = Math.abs(exitPrice - entryPrice) * 3 || entryPrice * 0.015;
                const minPrice = Math.min(entryPrice, exitPrice) - (priceRange * 0.4);
                const maxPrice = Math.max(entryPrice, exitPrice) + (priceRange * 0.4);
                
                // Helper function to convert price to Y coordinate
                const priceToY = (price) => {
                    const ratio = (price - minPrice) / (maxPrice - minPrice);
                    return chartY + chartHeight - (ratio * chartHeight);
                };
                
                // Draw grid lines (light gray)
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 5; i++) {
                    const y = chartY + (chartHeight / 5) * i;
                    ctx.beginPath();
                    ctx.moveTo(chartX, y);
                    ctx.lineTo(chartX + chartWidth, y);
                    ctx.stroke();
                    
                    // Price labels on right
                    const price = maxPrice - ((maxPrice - minPrice) / 5) * i;
                    ctx.fillStyle = '#666666';
                    ctx.font = '11px Arial, sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText(price.toFixed(5), chartX + chartWidth + 50, y + 4);
                    ctx.textAlign = 'left';
                }
                
                // Generate realistic candlesticks (20 candles)
                const numCandles = 20;
                const candleWidth = chartWidth / numCandles * 0.7;
                const candleSpacing = chartWidth / numCandles;
                
                let currentPrice = entryPrice;
                
                for (let i = 0; i < numCandles; i++) {
                    const x = chartX + (i * candleSpacing) + (candleSpacing * 0.15);
                    
                    // Simulate price movement
                    const volatility = entryPrice * 0.002;
                    const change = (Math.random() - 0.5) * volatility;
                    const open = currentPrice;
                    const close = currentPrice + change;
                    const high = Math.max(open, close) + (Math.random() * volatility * 0.5);
                    const low = Math.min(open, close) - (Math.random() * volatility * 0.5);
                    
                    currentPrice = close;
                    
                    const isGreen = close > open;
                    const color = isGreen ? '#2196F3' : '#FF5722'; // Blue/Orange like example
                    
                    // Draw wick
                    ctx.strokeStyle = '#666666';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(x + candleWidth / 2, priceToY(high));
                    ctx.lineTo(x + candleWidth / 2, priceToY(low));
                    ctx.stroke();
                    
                    // Draw body
                    const bodyTop = priceToY(Math.max(open, close));
                    const bodyBottom = priceToY(Math.min(open, close));
                    const bodyHeight = Math.max(bodyBottom - bodyTop, 2);
                    
                    ctx.fillStyle = color;
                    ctx.fillRect(x, bodyTop, candleWidth, bodyHeight);
                    ctx.strokeStyle = color;
                    ctx.strokeRect(x, bodyTop, candleWidth, bodyHeight);
                }
                
                // Draw ENTRY line with circle marker
                const entryY = priceToY(entryPrice);
                ctx.strokeStyle = '#2196F3';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(chartX, entryY);
                ctx.lineTo(chartX + chartWidth, entryY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Entry circle marker
                const entryX = chartX + (3 * candleSpacing);
                ctx.beginPath();
                ctx.arc(entryX, entryY, 6, 0, 2 * Math.PI);
                ctx.fillStyle = '#2196F3';
                ctx.fill();
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Entry label
                ctx.fillStyle = '#2196F3';
                ctx.font = 'bold 12px Arial, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(`#${entryPrice.toFixed(2)} buy 0.02`, chartX - 90, entryY + 4);
                
                // Draw EXIT line with marker
                const exitY = priceToY(exitPrice);
                const pnl = this.state.currentSession.autoPnL || 0;
                const isProfitable = pnl >= 0;
                
                ctx.strokeStyle = isProfitable ? '#4CAF50' : '#F44336';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(chartX, exitY);
                ctx.lineTo(chartX + chartWidth, exitY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Exit circle marker
                const exitX = chartX + (17 * candleSpacing);
                ctx.beginPath();
                ctx.arc(exitX, exitY, 6, 0, 2 * Math.PI);
                ctx.fillStyle = isProfitable ? '#4CAF50' : '#F44336';
                ctx.fill();
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Exit label
                ctx.fillStyle = '#333333';
                ctx.font = '11px Arial, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`#${exitPrice.toFixed(2)}`, chartX + chartWidth + 50, exitY + 25);
                
                // Draw trend line (dotted)
                ctx.strokeStyle = '#666666';
                ctx.lineWidth = 1;
                ctx.setLineDash([3, 3]);
                ctx.beginPath();
                ctx.moveTo(entryX, entryY);
                ctx.lineTo(exitX, exitY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Add "Buy -19p" label like example
                const pnlPips = Math.round((exitPrice - entryPrice) * 10000);
                ctx.fillStyle = '#F44336';
                ctx.font = 'bold 12px Arial, sans-serif';
                ctx.fillText(`${direction} ${pnlPips > 0 ? '+' : ''}${pnlPips}p`, entryX + 60, entryY - 60);
                
                // Reset line dash
                ctx.setLineDash([]);
                
                // Convert canvas to blob and save to IndexedDB
                canvas.toBlob(async (blob) => {
                    if (blob) {
                        const sessionId = this.state.currentSession.id;
                        const screenshotId = await this.saveScreenshotToDB(blob, sessionId, 0);
                        
                        // Save screenshot ID to session
                        if (!this.state.currentSession.screenshots) {
                            this.state.currentSession.screenshots = [];
                        }
                        this.state.currentSession.screenshots.push(screenshotId);
                        
                        console.log('Chart screenshot captured and saved');
                    }
                }, 'image/png');
                
            } catch (error) {
                console.error('Error capturing chart screenshot:', error);
            }
        },

        endSession() {
            const startTime = new Date(this.state.currentSession.startTime);
            const endTime = new Date();
            const duration = Math.round((endTime - startTime) / 1000 / 60);
            this.state.currentSession.duration = duration;
            this.state.currentSession.actions = this.state.actionLog;
            
            // Stop the session timer
            this.stopSessionTimer();
            
            this.nextStep(4);
        },

        saveSession() {
            const outcome = document.getElementById('session-outcome').value;
            const pnl = document.getElementById('session-pnl').value;
            const postNotes = document.getElementById('session-post-notes').value;
            const mistakes = Array.from(document.querySelectorAll('.mistake-checkbox:checked'))
                .map(cb => cb.value);

            if (!outcome) {
                this.showToast('Please select an outcome', 'warning');
                return;
            }

            Object.assign(this.state.currentSession, {
                outcome,
                pnl: pnl ? parseFloat(pnl) : null,
                postNotes,
                mistakes
            });

            console.log('Saving session:', this.state.currentSession);
            this.state.sessions.unshift(this.state.currentSession);
            console.log('Total sessions now:', this.state.sessions.length);
            
            // Use enhanced save with error handling
            if (this.saveSessionsWithErrorHandling()) {
                console.log('Session saved to localStorage successfully');
                
                // Reload sessions from localStorage to ensure sync
                const stored = localStorage.getItem('edgemetrics_sessions');
                if (stored) {
                    this.state.sessions = JSON.parse(stored);
                    console.log('Reloaded sessions from localStorage:', this.state.sessions.length);
                }
                
                this.showToast('Session saved successfully', 'success');
                this.closeSession();
                
                // Force immediate update
                console.log('Starting immediate render...');
                this.renderDashboard();
                this.updateUserStats();
                this.updateQuickStats();
                this.updatePnL();
                this.updateStreakDisplays();
                
                // Also update after modal close animation completes
                setTimeout(() => {
                    console.log('Starting delayed render...');
                    this.renderDashboard();
                    this.updateUserStats();
                    this.updateQuickStats();
                    this.updatePnL();
                    this.updateStreakDisplays();
                    
                    // Force another P&L update to ensure chart renders
                    setTimeout(() => {
                        this.updatePnL();
                        console.log('All updates complete');
                    }, 50);
                }, 100);
            } else {
                console.error('Failed to save session to localStorage');
            }
        },

        closeSession() {
            // Stop timer if running
            this.stopSessionTimer();
            
            document.getElementById('session-overlay').classList.remove('active');
            // Reset form
            document.getElementById('session-instrument').value = '';
            document.getElementById('session-type').value = 'scalping';
            document.getElementById('session-risk').value = '2';
            document.getElementById('session-confidence').value = '7';
            document.getElementById('confidence-display').textContent = '7';
            document.getElementById('session-pre-notes').value = '';
            document.getElementById('session-outcome').value = '';
            document.getElementById('session-pnl').value = '';
            document.getElementById('session-post-notes').value = '';
            document.querySelectorAll('.mistake-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.mood-option').forEach(el => el.classList.remove('selected'));
            this.state.selectedMood = null;
        },

        showAnalytics() {
            document.getElementById('analytics-overlay').classList.add('active');
            setTimeout(() => {
                this.renderMoodChart();
                this.renderTimelineChart();
                this.renderCalendar();
            }, 100);
        },

        closeAnalytics() {
            const overlay = document.getElementById('analytics-overlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
        },

        showLearning() {
            document.getElementById('learning-overlay').classList.add('active');
        },

        closeLearning() {
            document.getElementById('learning-overlay').classList.remove('active');
        },

        renderMoodChart() {
            const ctx = document.getElementById('mood-chart');
            if (!ctx) return;

            const sessions = this.state.sessions;
            const moodData = {};
            sessions.forEach(s => {
                if (!moodData[s.mood]) {
                    moodData[s.mood] = { total: 0, wins: 0 };
                }
                moodData[s.mood].total++;
                if (s.outcome === 'win') moodData[s.mood].wins++;
            });

            const labels = Object.keys(moodData);
            const winRates = labels.map(mood => 
                ((moodData[mood].wins / moodData[mood].total) * 100).toFixed(1)
            );

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                    datasets: [{
                        label: 'Win Rate (%)',
                        data: winRates,
                        backgroundColor: '#1a1a1a',
                        borderColor: '#4b5563',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#6b7280' },
                            grid: { color: '#222222' },
                            border: { color: '#222222' }
                        },
                        x: {
                            ticks: { color: '#6b7280' },
                            grid: { display: false },
                            border: { color: '#222222' }
                        }
                    }
                }
            });
        },

        renderTimelineChart() {
            const ctx = document.getElementById('timeline-chart');
            if (!ctx) return;

            const sessions = this.state.sessions;
            const dailyData = {};
            sessions.forEach(s => {
                const date = new Date(s.startTime).toLocaleDateString();
                if (!dailyData[date]) {
                    dailyData[date] = { total: 0, wins: 0 };
                }
                dailyData[date].total++;
                if (s.outcome === 'win') dailyData[date].wins++;
            });

            const dates = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b)).slice(-10);
            const winRates = dates.map(date => 
                ((dailyData[date].wins / dailyData[date].total) * 100).toFixed(1)
            );

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Win Rate (%)',
                        data: winRates,
                        borderColor: '#4b5563',
                        backgroundColor: 'transparent',
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 3,
                        pointBackgroundColor: '#4b5563'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#6b7280' },
                            grid: { color: '#222222' },
                            border: { color: '#222222' }
                        },
                        x: {
                            ticks: { color: '#6b7280' },
                            grid: { display: false },
                            border: { color: '#222222' }
                        }
                    }
                }
            });
        },

        renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthYear = document.getElementById('calendar-month-year');
            
            const year = this.state.calendarYear;
            const month = this.state.calendarMonth;
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            monthYear.textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and days in month
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Get sessions for this month
            const sessions = this.state.sessions;
            const sessionsByDate = {};
            
            sessions.forEach(s => {
                const sessionDate = new Date(s.startTime);
                if (sessionDate.getMonth() === month && sessionDate.getFullYear() === year) {
                    const day = sessionDate.getDate();
                    if (!sessionsByDate[day]) {
                        sessionsByDate[day] = [];
                    }
                    sessionsByDate[day].push(s);
                }
            });
            
            // Clear grid
            grid.innerHTML = '';
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                emptyDay.style.opacity = '0.3';
                grid.appendChild(emptyDay);
            }
            
            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                
                const daySessions = sessionsByDate[day] || [];
                
                if (daySessions.length > 0) {
                    dayCell.classList.add('has-session');
                    
                    // Determine majority outcome
                    const wins = daySessions.filter(s => s.outcome === 'win').length;
                    const losses = daySessions.filter(s => s.outcome === 'loss').length;
                    const breakevens = daySessions.filter(s => s.outcome === 'breakeven' || s.outcome === 'no-trade').length;
                    
                    if (wins > losses && wins > breakevens) {
                        dayCell.classList.add('has-win');
                    } else if (losses > wins && losses > breakevens) {
                        dayCell.classList.add('has-loss');
                    } else {
                        dayCell.classList.add('has-breakeven');
                    }
                    
                    dayCell.onclick = () => {
                        this.showDayHistory(year, month, day, daySessions);
                    };
                }
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'calendar-day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);
                
                if (daySessions.length > 0) {
                    const indicator = document.createElement('div');
                    indicator.className = 'calendar-day-indicator';
                    indicator.textContent = `${daySessions.length} session${daySessions.length > 1 ? 's' : ''}`;
                    dayCell.appendChild(indicator);
                }
                
                // Highlight today
                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayCell.style.borderColor = '#eab308';
                }
                
                grid.appendChild(dayCell);
            }
        },

        changeCalendarMonth(delta) {
            this.state.calendarMonth += delta;
            
            if (this.state.calendarMonth < 0) {
                this.state.calendarMonth = 11;
                this.state.calendarYear--;
            } else if (this.state.calendarMonth > 11) {
                this.state.calendarMonth = 0;
                this.state.calendarYear++;
            }
            
            this.renderCalendar();
        },

        openModule(moduleName) {
            const moduleContent = {
                psychology: {
                    title: 'TRADING PSYCHOLOGY',
                    subtitle: 'Master fear, greed, and mental discipline',
                    color: '#a855f7',
                    lessons: [
                        {
                            title: 'Understanding Fear and Greed',
                            content: 'Fear and greed are the two dominant emotions in trading. Fear causes traders to exit positions too early or avoid taking trades altogether. Greed leads to overtrading and holding positions too long. Recognition is the first step to control.'
                        },
                        {
                            title: 'Developing Emotional Awareness',
                            content: 'Keep a mood journal before each session. Rate your emotional state 1-10. Notice patterns between your mood and trading outcomes. This awareness helps you recognize when to trade and when to step back.'
                        },
                        {
                            title: 'The Power of Detachment',
                            content: 'View each trade as one of thousands in your career. No single trade defines you. This perspective reduces emotional attachment to outcomes and allows for objective decision-making.'
                        },
                        {
                            title: 'Building Mental Resilience',
                            content: 'Losses are inevitable. How you respond defines your success. After a loss, review objectively: Did you follow your plan? If yes, the loss is just business. If no, what triggered the deviation?'
                        },
                        {
                            title: 'Pre-Session Rituals',
                            content: 'Create a consistent routine before trading. Review your rules, check your emotional state, set daily goals. This ritual signals your brain it\'s time to focus and creates psychological consistency.'
                        }
                    ]
                },
                risk: {
                    title: 'RISK MANAGEMENT',
                    subtitle: 'Protect capital and manage your profitability',
                    color: '#10b981',
                    lessons: [
                        {
                            title: 'The 1% Rule',
                            content: 'Never risk more than 1-2% of your account on a single trade. This ensures you can withstand a series of losses without destroying your account. With 1% risk, you can lose 20 trades in a row and still have 80% of your capital.'
                        },
                        {
                            title: 'Position Sizing Mastery',
                            content: 'Calculate position size based on your stop loss and risk percentage. Formula: (Account Size √ó Risk%) √∑ Stop Loss Distance = Position Size. This keeps risk consistent regardless of stop placement.'
                        },
                        {
                            title: 'Risk-Reward Ratios',
                            content: 'Aim for minimum 1:2 risk-reward. If you risk $100, target $200 profit. This means you can be wrong 40% of the time and still profit. Higher ratios provide more cushion for losses.'
                        },
                        {
                            title: 'Daily Loss Limits',
                            content: 'Set a maximum daily loss (e.g., 3%). If hit, stop trading for the day. This prevents revenge trading and emotional spirals. Protect yourself from yourself on bad days.'
                        },
                        {
                            title: 'Scaling Strategies',
                            content: 'Start small while learning. As you prove consistency, gradually increase size. Many traders stay small until they achieve 3+ months of profitability. Size is earned, not given.'
                        }
                    ]
                },
                strategy: {
                    title: 'STRATEGY DEVELOPMENT',
                    subtitle: 'Build and refine your trading methodology',
                    color: '#3b82f6',
                    lessons: [
                        {
                            title: 'Finding Your Edge',
                            content: 'An edge is a repeatable advantage in the market. It could be technical patterns, volume analysis, or order flow. Your edge must be: specific, testable, and statistically proven over 100+ trades.'
                        },
                        {
                            title: 'Backtest Before Live',
                            content: 'Test your strategy on historical data. Track win rate, average win/loss, maximum drawdown, profit factor. Minimum 100 trades needed for statistical relevance. If it doesn\'t work historically, it won\'t work live.'
                        },
                        {
                            title: 'The Trading Plan',
                            content: 'Document everything: entry criteria, exit rules, risk parameters, session times, instruments traded. Your plan removes decisions from the heat of the moment. Trade the plan, not your feelings.'
                        },
                        {
                            title: 'Adaptation vs Optimization',
                            content: 'Markets change. Your strategy needs regular review (monthly). But avoid over-optimization - fitting strategy to recent data. Focus on robust principles that work across different market conditions.'
                        },
                        {
                            title: 'Specialization Benefits',
                            content: 'Master one setup before adding more. Trade one instrument before diversifying. Depth beats breadth. Expertise in one area beats mediocrity in many.'
                        }
                    ]
                },
                technical: {
                    title: 'TECHNICAL ANALYSIS',
                    subtitle: 'Read price action and market structure',
                    color: '#06b6d4',
                    lessons: [
                        {
                            title: 'Support and Resistance Basics',
                            content: 'S/R levels are where price has historically reversed or consolidated. Horizontal levels work because traders remember these prices. The more times tested, the stronger the level. Break and retest confirms new levels.'
                        },
                        {
                            title: 'Trend Identification',
                            content: 'Uptrend: Higher highs and higher lows. Downtrend: Lower highs and lower lows. Trade with the trend for higher probability. Trend is your friend until it bends (breaks structure).'
                        },
                        {
                            title: 'Volume Analysis',
                            content: 'Volume confirms price moves. Rising price + rising volume = strong move. Rising price + falling volume = weak move likely to reverse. Volume precedes price - watch for divergences.'
                        },
                        {
                            title: 'Candlestick Patterns',
                            content: 'Candlesticks show psychology. Doji = indecision. Hammer/Shooting Star = potential reversal. Engulfing = momentum shift. But patterns alone aren\'t enough - context (S/R, trend) matters most.'
                        },
                        {
                            title: 'Indicator Intelligence',
                            content: 'Indicators lag price - they use historical data. Use them for confirmation, not signals. Moving averages show trend. RSI shows momentum. MACD shows trend changes. Keep charts clean - less is more.'
                        }
                    ]
                },
                journaling: {
                    title: 'JOURNALING MASTERY',
                    subtitle: 'Track, analyze, and improve performance',
                    color: '#f97316',
                    lessons: [
                        {
                            title: 'Why Journal?',
                            content: 'Trading without a journal is like sailing without a compass. Your journal reveals patterns invisible in the moment: time-of-day performance, mood correlations, setup win rates, common mistakes. Data-driven improvement beats guessing.'
                        },
                        {
                            title: 'What to Track',
                            content: 'Essential data: Entry/exit times, setup type, mood, confidence, P&L, screenshots. Optional: market context, mistakes made, lessons learned. The more detail, the more insights you can extract.'
                        },
                        {
                            title: 'Weekly Reviews',
                            content: 'Every weekend, review your trades. Calculate win rate, average R, best/worst days. Look for patterns: Were you better in mornings? Did certain moods correlate with losses? Adjust based on evidence.'
                        },
                        {
                            title: 'The Mistake Log',
                            content: 'Separate log for errors: breaking rules, emotional trades, FOMO entries. Rate severity 1-10. Track frequency. Most traders repeat 3-4 core mistakes. Awareness is the cure.'
                        },
                        {
                            title: 'Progress Metrics',
                            content: 'Track beyond P&L: Rules followed (%), quality trades (%), emotional control rating. These process metrics predict results. Good process + time = good results. Win the process, results follow.'
                        }
                    ]
                },
                mindset: {
                    title: 'WINNING MINDSET',
                    subtitle: 'Cultivate professional trader mentality',
                    color: '#ec4899',
                    lessons: [
                        {
                            title: 'Think in Probabilities',
                            content: 'No single trade matters. You\'re playing a probability game over hundreds of trades. A loss doesn\'t mean you\'re bad. A win doesn\'t mean you\'re good. Results mean nothing without sample size.'
                        },
                        {
                            title: 'Process Over Outcome',
                            content: 'Control what you can control: following rules, managing risk, emotional state. You can\'t control if a trade wins. Focus on perfect execution. Win the process, results follow.'
                        },
                        {
                            title: 'Patience as Strategy',
                            content: 'The best traders wait. They pass on marginal setups. They accept doing nothing is doing something. Quality > quantity. One A+ setup beats five B- setups.'
                        },
                        {
                            title: 'Continuous Learning',
                            content: 'Markets evolve. Your skills must too. Read books, review trades, study charts, learn from losses. Dedicate 1 hour daily to improvement. Compound learning creates lasting edge.'
                        },
                        {
                            title: 'Long-Term Vision',
                            content: 'This is a marathon, not a sprint. Focus on monthly/yearly results, not daily swings. Build systems that last years. Consistency compounds. Today\'s discipline is tomorrow\'s freedom.'
                        }
                    ]
                }
            };

            const module = moduleContent[moduleName];
            if (!module) return;

            // Update panel header
            document.getElementById('module-title').textContent = module.title;
            document.getElementById('module-subtitle').textContent = module.subtitle;
            document.getElementById('module-title').style.color = module.color;

            // Generate lessons HTML
            const lessonsHTML = module.lessons.map((lesson, index) => `
                <div class="lesson-item" onclick="app.expandLesson(this, ${index})">
                    <div class="flex items-start gap-3">
                        <div class="bg-[#222222] text-muted rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold flex-shrink-0" style="border: 2px solid ${module.color}20;">
                            ${index + 1}
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-semibold text-primary mb-1">${lesson.title}</h4>
                            <div class="lesson-content hidden">
                                <p class="text-sm text-secondary leading-relaxed mt-3">${lesson.content}</p>
                                <div class="mt-4 flex gap-2">
                                    <button onclick="app.markLessonComplete(event, ${index})" class="btn-primary text-xs px-4 py-2">
                                        <iconify-icon icon="solar:check-circle-bold" class="inline mr-1"></iconify-icon>
                                        Mark Complete
                                    </button>
                                </div>
                            </div>
                            <div class="text-xs text-muted mt-1 lesson-preview">${lesson.content.substring(0, 60)}...</div>
                        </div>
                        <iconify-icon icon="solar:alt-arrow-down-bold" class="text-muted lesson-arrow" width="20"></iconify-icon>
                    </div>
                </div>
            `).join('');

            document.getElementById('module-lessons-container').innerHTML = lessonsHTML;

            // Show panel and mark learning overlay as having module open
            document.getElementById('module-panel').classList.add('active');
            document.getElementById('learning-overlay').classList.add('module-open');
        },

        closeModule() {
            document.getElementById('module-panel').classList.remove('active');
            document.getElementById('learning-overlay').classList.remove('module-open');
        },

        expandLesson(element, index) {
            const content = element.querySelector('.lesson-content');
            const preview = element.querySelector('.lesson-preview');
            const arrow = element.querySelector('.lesson-arrow');
            
            const isExpanded = !content.classList.contains('hidden');
            
            // Close all lessons first
            document.querySelectorAll('.lesson-item').forEach(item => {
                item.classList.remove('active');
                item.querySelector('.lesson-content')?.classList.add('hidden');
                item.querySelector('.lesson-preview')?.classList.remove('hidden');
                const itemArrow = item.querySelector('.lesson-arrow');
                if (itemArrow) itemArrow.style.transform = 'rotate(0deg)';
            });
            
            // If wasn't expanded, expand this one
            if (!isExpanded) {
                element.classList.add('active');
                content.classList.remove('hidden');
                preview.classList.add('hidden');
                arrow.style.transform = 'rotate(180deg)';
            }
        },

        markLessonComplete(event, index) {
            event.stopPropagation();
            // Here you would save progress to localStorage or backend
            alert('Lesson marked as complete! (Progress tracking coming soon)');
        },

        showDayHistory(year, month, day, sessions) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            const panel = document.getElementById('day-history-panel');
            const title = document.getElementById('day-history-title');
            const subtitle = document.getElementById('day-history-subtitle');
            const container = document.getElementById('day-history-sessions');
            
            title.textContent = `${monthNames[month]} ${day}, ${year}`;
            
            const wins = sessions.filter(s => s.outcome === 'win').length;
            const losses = sessions.filter(s => s.outcome === 'loss').length;
            const breakevens = sessions.filter(s => s.outcome === 'breakeven' || s.outcome === 'no-trade').length;
            
            subtitle.textContent = `${sessions.length} session${sessions.length > 1 ? 's' : ''} ‚Ä¢ ${wins}W / ${losses}L / ${breakevens}BE`;
            
            container.innerHTML = sessions.map(session => {
                const date = new Date(session.startTime);
                const formattedTime = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <div class="session-detail-card">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-sm font-medium text-primary">${session.instrument}</span>
                                    <span class="text-xs text-muted">‚Ä¢</span>
                                    <span class="text-xs text-muted">${formattedTime}</span>
                                    ${session.duration ? `
                                        <span class="text-xs text-muted">‚Ä¢</span>
                                        <span class="text-xs text-muted">${session.duration}m</span>
                                    ` : ''}
                                </div>
                                <div class="text-xs text-secondary capitalize">Mood: ${session.mood}</div>
                            </div>
                            <div class="text-sm font-medium ${session.outcome === 'win' ? 'text-success' : session.outcome === 'loss' ? 'text-error' : 'text-muted'}">
                                ${session.outcome.charAt(0).toUpperCase() + session.outcome.slice(1)}
                            </div>
                        </div>
                        
                        ${session.preNotes ? `
                            <div class="mb-3">
                                <div class="text-xs text-muted uppercase tracking-wide mb-1">Pre-Session Notes</div>
                                <div class="text-sm text-secondary">${session.preNotes}</div>
                            </div>
                        ` : ''}
                        
                        ${session.postNotes ? `
                            <div class="mb-3">
                                <div class="text-xs text-muted uppercase tracking-wide mb-1">Post-Session Notes</div>
                                <div class="text-sm text-secondary">${session.postNotes}</div>
                            </div>
                        ` : ''}
                        
                        ${session.confidence ? `
                            <div class="mb-3">
                                <div class="text-xs text-muted uppercase tracking-wide mb-1">Confidence Level</div>
                                <div class="text-sm text-primary">${session.confidence}/10</div>
                            </div>
                        ` : ''}
                        
                        ${session.mistakes && session.mistakes.length > 0 ? `
                            <div class="mb-3">
                                <div class="text-xs text-muted uppercase tracking-wide mb-1">Mistakes</div>
                                <div class="text-sm text-warning">${session.mistakes.join(', ')}</div>
                            </div>
                        ` : ''}
                        
                        <div class="flex items-center justify-between mt-4 pt-3 border-t border-[#222222]">
                            <div class="text-xs text-muted">Session ID: ${session.id.substring(session.id.length - 8)}</div>
                            <button onclick="app.viewSessionDetails('${session.id}')" class="text-xs text-secondary hover:text-primary">
                                View Full Details ‚Üí
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            panel.classList.add('active');
            panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        },
        
        closeDayHistory() {
            document.getElementById('day-history-panel').classList.remove('active');
        },
        
        viewSessionDetails(sessionId) {
            const session = this.state.sessions.find(s => s.id === sessionId);
            if (!session) {
                this.showToast('Session not found', 'error');
                return;
            }
            
            const modal = document.getElementById('session-detail-modal');
            const body = document.getElementById('session-detail-body');
            
            const date = new Date(session.startTime);
            const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const formattedTime = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            body.innerHTML = `
                <div class="space-y-6">
                    <!-- Session Overview -->
                    <div class="stat-card">
                        <h3 class="text-sm font-semibold text-primary mb-4 uppercase tracking-wide">Session Overview</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <div class="text-xs text-muted uppercase tracking-wide mb-1">Date</div>
                                <div class="text-sm text-primary">${formattedDate}</div>
                            </div>
                            <div>
                                <div class="text-xs text-muted uppercase tracking-wide mb-1">Time</div>
                                <div class="text-sm text-primary">${formattedTime}</div>
                            </div>
                            <div>
                                <div class="text-xs text-muted uppercase tracking-wide mb-1">Instrument</div>
                                <div class="text-sm text-primary">${session.instrument}</div>
                            </div>
                            <div>
                                <div class="text-xs text-muted uppercase tracking-wide mb-1">Duration</div>
                                <div class="text-sm text-primary">${session.duration || 0}m</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Outcome -->
                    <div class="stat-card">
                        <h3 class="text-sm font-semibold text-primary mb-4 uppercase tracking-wide">Outcome</h3>
                        <div class="text-2xl font-bold ${session.outcome === 'win' ? 'text-success' : session.outcome === 'loss' ? 'text-error' : 'text-muted'}">
                            ${session.outcome.charAt(0).toUpperCase() + session.outcome.slice(1)}
                        </div>
                    </div>
                    
                    <!-- Trade Details (Entry/Exit) -->
                    ${session.entryPrice || session.exitPrice || session.quantity ? `
                        <div class="stat-card">
                            <h3 class="text-sm font-semibold text-primary mb-4 uppercase tracking-wide">üìä Trade Details</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                ${session.direction ? `
                                    <div class="p-3 bg-[#0a0a0a] rounded border border-[#222]">
                                        <div class="text-xs text-muted uppercase tracking-wide mb-1">Direction</div>
                                        <div class="text-lg font-semibold ${session.direction === 'buy' ? 'text-success' : 'text-error'}">
                                            ${session.direction === 'buy' ? '‚Üë BUY' : '‚Üì SELL'}
                                        </div>
                                        <div class="text-xs text-muted mt-1">${session.direction === 'buy' ? 'Long' : 'Short'} Position</div>
                                    </div>
                                ` : ''}
                                ${session.quantity ? `
                                    <div class="p-3 bg-[#0a0a0a] rounded border border-[#222]">
                                        <div class="text-xs text-muted uppercase tracking-wide mb-1">Quantity</div>
                                        <div class="text-lg font-mono font-semibold text-primary">${session.quantity}</div>
                                        <div class="text-xs text-muted mt-1">Lots/Contracts</div>
                                    </div>
                                ` : ''}
                                ${session.entryPrice ? `
                                    <div class="p-3 bg-[#0a0a0a] rounded border border-[#222]">
                                        <div class="text-xs text-muted uppercase tracking-wide mb-1">Entry Price</div>
                                        <div class="text-lg font-mono font-semibold text-[#3b82f6]">${session.entryPrice.toFixed(2)}</div>
                                        ${session.entryTime ? `<div class="text-xs text-muted mt-1">${new Date(session.entryTime).toLocaleTimeString()}</div>` : ''}
                                    </div>
                                ` : ''}
                                ${session.exitPrice ? `
                                    <div class="p-3 bg-[#0a0a0a] rounded border border-[#222]">
                                        <div class="text-xs text-muted uppercase tracking-wide mb-1">Exit Price</div>
                                        <div class="text-lg font-mono font-semibold ${session.autoPnL >= 0 ? 'text-success' : 'text-error'}">${session.exitPrice.toFixed(2)}</div>
                                        ${session.exitTime ? `<div class="text-xs text-muted mt-1">${new Date(session.exitTime).toLocaleTimeString()}</div>` : ''}
                                    </div>
                                ` : ''}
                                ${session.pnlDollar !== undefined && session.pnlDollar !== null ? `
                                    <div class="p-3 bg-[#0a0a0a] rounded border border-[#222]">
                                        <div class="text-xs text-muted uppercase tracking-wide mb-1">Dollar P&L</div>
                                        <div class="text-xl font-mono font-bold ${session.pnlDollar >= 0 ? 'text-success' : 'text-error'}">
                                            ${session.pnlDollar > 0 ? '+' : ''}$${Math.abs(session.pnlDollar).toFixed(2)}
                                        </div>
                                        <div class="text-xs text-muted mt-1">Net Profit/Loss</div>
                                    </div>
                                ` : ''}
                                ${session.autoPnL !== undefined && session.autoPnL !== null ? `
                                    <div class="p-3 bg-[#0a0a0a] rounded border border-[#222]">
                                        <div class="text-xs text-muted uppercase tracking-wide mb-1">Percentage P&L</div>
                                        <div class="text-lg font-mono font-semibold ${session.autoPnL >= 0 ? 'text-success' : 'text-error'}">
                                            ${session.autoPnL > 0 ? '+' : ''}${session.autoPnL.toFixed(2)}%
                                        </div>
                                        <div class="text-xs text-muted mt-1">Auto-calculated</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Chart Screenshot -->
                    ${session.screenshots && session.screenshots.length > 0 ? `
                        <div class="stat-card">
                            <h3 class="text-sm font-semibold text-primary mb-4 uppercase tracking-wide">üì∏ Trade Chart</h3>
                            <div id="detail-screenshots-grid" class="grid grid-cols-1 gap-3">
                                <!-- Chart screenshot with entry/exit markers will be loaded here -->
                            </div>
                            <div class="text-xs text-muted mt-2">
                                üí° Chart auto-captured with entry (blue) and exit (green/red) markers
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Pre-Session -->
                    <div class="stat-card">
                        <h3 class="text-sm font-semibold text-primary mb-4 uppercase tracking-wide">Pre-Session Analysis</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <div class="text-xs text-muted uppercase tracking-wide mb-1">Mood</div>
                                <div class="text-sm text-primary capitalize">${session.mood}</div>
                            </div>
                            ${session.confidence ? `
                                <div>
                                    <div class="text-xs text-muted uppercase tracking-wide mb-1">Confidence</div>
                                    <div class="text-sm text-primary">${session.confidence}/10</div>
                                </div>
                            ` : ''}
                        </div>
                        ${session.preNotes ? `
                            <div>
                                <div class="text-xs text-muted uppercase tracking-wide mb-2">Notes</div>
                                <div class="text-sm text-secondary bg-[#0a0a0a] border border-[#222222] rounded p-3">
                                    ${session.preNotes}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Post-Session -->
                    ${session.postNotes ? `
                        <div class="stat-card">
                            <h3 class="text-sm font-semibold text-primary mb-4 uppercase tracking-wide">Post-Session Review</h3>
                            <div class="text-sm text-secondary bg-[#0a0a0a] border border-[#222222] rounded p-3">
                                ${session.postNotes}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Mistakes -->
                    ${session.mistakes && session.mistakes.length > 0 ? `
                        <div class="stat-card">
                            <h3 class="text-sm font-semibold text-primary mb-4 uppercase tracking-wide">Mistakes</h3>
                            <div class="space-y-2">
                                ${session.mistakes.map(mistake => `
                                    <div class="text-sm text-warning bg-[#f59e0b]/10 border border-[#f59e0b]/20 rounded p-2">
                                        ${mistake}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Actions -->
                    <div class="flex gap-3">
                        <button onclick="app.editSession('${session.id}')" class="btn-secondary flex-1">
                            <iconify-icon icon="solar:pen-bold" width="16" class="inline mr-1"></iconify-icon>
                            Edit
                        </button>
                        <button onclick="app.deleteSession('${session.id}')" class="btn-secondary flex-1 text-error border-error/30 hover:border-error">
                            <iconify-icon icon="solar:trash-bin-2-bold" width="16" class="inline mr-1"></iconify-icon>
                            Delete
                        </button>
                        <button onclick="app.closeSessionDetail()" class="btn-primary flex-1">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            // Load screenshots from IndexedDB
            if (session.screenshots && session.screenshots.length > 0) {
                this.loadSessionScreenshots(session.screenshots);
            }
            
            modal.classList.add('active');
        },
        
        async loadSessionScreenshots(screenshotIds) {
            const grid = document.getElementById('detail-screenshots-grid');
            if (!grid) return;
            
            grid.innerHTML = '<div class="col-span-full text-xs text-secondary text-center">Loading screenshots...</div>';
            
            setTimeout(async () => {
                grid.innerHTML = '';
                
                for (const screenshotId of screenshotIds) {
                    try {
                        const imgUrl = await this.loadScreenshotFromDB(screenshotId);
                        
                        if (imgUrl) {
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'relative cursor-pointer hover:opacity-80 transition-opacity';
                            
                            const img = document.createElement('img');
                            img.src = imgUrl;
                            // Larger display for chart screenshots (full width, auto height)
                            img.className = 'w-full h-auto rounded border border-[#222] hover:border-[#333]';
                            img.onclick = () => this.viewFullScreenshot(imgUrl);
                            
                            imgContainer.appendChild(img);
                            grid.appendChild(imgContainer);
                        }
                    } catch (error) {
                        console.error('Error loading screenshot:', error);
                    }
                }
                
                if (grid.children.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-xs text-secondary text-center">Chart screenshot not available</div>';
                }
            }, 100);
        },
        
        viewFullScreenshot(imgUrl) {
            // Create fullscreen modal for screenshot
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4';
            overlay.onclick = () => overlay.remove();
            
            const img = document.createElement('img');
            img.src = imgUrl;
            img.className = 'max-w-full max-h-full object-contain';
            img.onclick = (e) => e.stopPropagation();
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'absolute top-4 right-4 text-white bg-black/50 hover:bg-black/70 rounded-full w-10 h-10 flex items-center justify-center';
            closeBtn.innerHTML = '√ó';
            closeBtn.style.fontSize = '24px';
            closeBtn.onclick = () => overlay.remove();
            
            overlay.appendChild(img);
            overlay.appendChild(closeBtn);
            document.body.appendChild(overlay);
        },
        
        // ============================================
        // TRADINGVIEW CHART INTEGRATION
        // ============================================
        
        initTradingViewChart(session) {
            // Load TradingView library if not already loaded
            if (!window.TradingView) {
                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/tv.js';
                script.onload = () => {
                    console.log('TradingView library loaded');
                    this.createChart(session);
                };
                script.onerror = () => {
                    console.error('Failed to load TradingView library');
                    this.showChartError(session.id, 'Failed to load chart library');
                };
                document.head.appendChild(script);
            } else {
                this.createChart(session);
            }
        },
        
        createChart(session) {
            const containerId = `tradingview-chart-${session.id}`;
            const container = document.getElementById(containerId);
            
            if (!container) {
                console.error('Chart container not found');
                return;
            }
            
            // Convert instrument to TradingView symbol format
            const symbol = this.convertToTradingViewSymbol(session.instrument);
            
            try {
                // Clear container
                container.innerHTML = '';
                
                // Create TradingView widget
                new window.TradingView.widget({
                    container_id: containerId,
                    width: '100%',
                    height: 400,
                    symbol: symbol,
                    interval: '5', // 5 minute default
                    timezone: 'Etc/UTC',
                    theme: 'dark',
                    style: '1', // Candles
                    locale: 'en',
                    toolbar_bg: '#0a0a0a',
                    enable_publishing: false,
                    hide_side_toolbar: false,
                    allow_symbol_change: true,
                    save_image: true,
                    studies: [],
                    disabled_features: ['use_localstorage_for_settings'],
                    enabled_features: ['study_templates'],
                    loading_screen: { backgroundColor: '#0a0a0a' },
                    overrides: {
                        'paneProperties.background': '#0a0a0a',
                        'paneProperties.backgroundType': 'solid',
                        'paneProperties.vertGridProperties.color': '#1a1a1a',
                        'paneProperties.horzGridProperties.color': '#1a1a1a',
                        'scalesProperties.textColor': '#999999',
                        'mainSeriesProperties.candleStyle.upColor': '#10b981',
                        'mainSeriesProperties.candleStyle.downColor': '#ef4444',
                        'mainSeriesProperties.candleStyle.borderUpColor': '#10b981',
                        'mainSeriesProperties.candleStyle.borderDownColor': '#ef4444',
                        'mainSeriesProperties.candleStyle.wickUpColor': '#10b981',
                        'mainSeriesProperties.candleStyle.wickDownColor': '#ef4444'
                    }
                });
                
                console.log(`Chart created for ${session.instrument} (${symbol})`);
            } catch (error) {
                console.error('Error creating chart:', error);
                this.showChartError(session.id, 'Error loading chart. Please try again.');
            }
        },
        
        convertToTradingViewSymbol(instrument) {
            // Map common instruments to TradingView symbols
            const symbolMap = {
                // Forex - Major Pairs
                'EUR/USD': 'FX:EURUSD',
                'GBP/USD': 'FX:GBPUSD',
                'USD/JPY': 'FX:USDJPY',
                'USD/CHF': 'FX:USDCHF',
                'AUD/USD': 'FX:AUDUSD',
                'USD/CAD': 'FX:USDCAD',
                'NZD/USD': 'FX:NZDUSD',
                
                // Forex - Minor Pairs
                'EUR/GBP': 'FX:EURGBP',
                'EUR/JPY': 'FX:EURJPY',
                'GBP/JPY': 'FX:GBPJPY',
                'EUR/AUD': 'FX:EURAUD',
                'EUR/CAD': 'FX:EURCAD',
                'EUR/CHF': 'FX:EURCHF',
                'GBP/AUD': 'FX:GBPAUD',
                'GBP/CAD': 'FX:GBPCAD',
                'GBP/CHF': 'FX:GBPCHF',
                'AUD/JPY': 'FX:AUDJPY',
                'AUD/CAD': 'FX:AUDCAD',
                'AUD/CHF': 'FX:AUDCHF',
                'AUD/NZD': 'FX:AUDNZD',
                'CAD/JPY': 'FX:CADJPY',
                'CAD/CHF': 'FX:CADCHF',
                'CHF/JPY': 'FX:CHFJPY',
                'NZD/JPY': 'FX:NZDJPY',
                'NZD/CAD': 'FX:NZDCAD',
                'NZD/CHF': 'FX:NZDCHF',
                
                // Forex - Exotic Pairs
                'USD/TRY': 'FX:USDTRY',
                'USD/ZAR': 'FX:USDZAR',
                'USD/MXN': 'FX:USDMXN',
                'USD/CNH': 'FX:USDCNH',
                'USD/SGD': 'FX:USDSGD',
                'USD/HKD': 'FX:USDHKD',
                
                // Indices
                'US30': 'DJ:DJI',
                'US500': 'SP:SPX',
                'NAS100': 'NASDAQ:NDX',
                'UK100': 'FTSE:UKX',
                'GER30': 'XETR:DAX',
                'FRA40': 'EURONEXT:PX1',
                'AUS200': 'ASX:XJO',
                'JPN225': 'TVC:NI225',
                
                // Commodities
                'XAU/USD': 'TVC:GOLD',
                'Gold': 'TVC:GOLD',
                'XAG/USD': 'TVC:SILVER',
                'Silver': 'TVC:SILVER',
                'CL/USD': 'NYMEX:CL1!',
                'Oil': 'NYMEX:CL1!',
                'BRENT/USD': 'NYMEX:BZ1!',
                'NG/USD': 'NYMEX:NG1!',
                
                // Crypto
                'BTC/USD': 'BINANCE:BTCUSDT',
                'ETH/USD': 'BINANCE:ETHUSDT',
                'XRP/USD': 'BINANCE:XRPUSDT',
                'BNB/USD': 'BINANCE:BNBUSDT',
                'ADA/USD': 'BINANCE:ADAUSDT',
                'SOL/USD': 'BINANCE:SOLUSDT',
                'DOGE/USD': 'BINANCE:DOGEUSDT'
            };
            
            // Check if exact match exists
            if (symbolMap[instrument]) {
                return symbolMap[instrument];
            }
            
            // Try to auto-detect format
            if (instrument.includes('/')) {
                // Forex format detected
                const pair = instrument.replace('/', '');
                return `FX:${pair}`;
            }
            
            // Try as stock ticker
            if (instrument.length <= 5 && /^[A-Z]+$/.test(instrument)) {
                return `NASDAQ:${instrument}`;
            }
            
            // Default fallback
            return `FX:EURUSD`;
        },
        
        changeChartTimeframe(sessionId, timeframe) {
            // Note: Changing timeframe requires recreating the widget
            // For now, we'll show a message
            this.showToast(`Chart timeframe changed to ${timeframe}. Reload to apply.`, 'info');
            
            // Find the session and recreate chart
            const session = this.state.sessions.find(s => s.id === sessionId);
            if (session) {
                setTimeout(() => {
                    this.createChart(session);
                }, 100);
            }
        },
        
        showChartError(sessionId, message) {
            const containerId = `tradingview-chart-${sessionId}`;
            const container = document.getElementById(containerId);
            
            if (container) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center text-secondary">
                            <iconify-icon icon="solar:danger-triangle-bold" width="48" class="opacity-50 mb-2 text-warning"></iconify-icon>
                            <div class="text-sm">${message}</div>
                            <div class="text-xs mt-2">Try refreshing the page</div>
                        </div>
                    </div>
                `;
            }
        },
        
        closeSessionDetail() {
            document.getElementById('session-detail-modal').classList.remove('active');
        },

        showAllSessions() {
            const modal = document.getElementById('all-sessions-modal');
            if (!modal) {
                // Create modal if it doesn't exist
                this.createAllSessionsModal();
                return this.showAllSessions();
            }
            
            const body = document.getElementById('all-sessions-body');
            const sessions = this.state.sessions;
            
            if (sessions.length === 0) {
                body.innerHTML = '<div class="text-center py-12 text-secondary">No sessions to display</div>';
            } else {
                body.innerHTML = `
                    <div class="space-y-3">
                        ${sessions.map((session, index) => {
                            const date = new Date(session.startTime);
                            const formattedDate = date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                            const formattedTime = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                            
                            return `
                                <div class="session-card outcome-${session.outcome}" style="cursor: pointer;" onclick="app.viewSessionDetails('${session.id}'); app.closeAllSessions();">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-2">
                                                <span class="text-sm font-medium text-primary">${session.instrument}</span>
                                                <span class="text-xs text-muted">‚Ä¢</span>
                                                <span class="text-xs text-muted">${formattedDate} ${formattedTime}</span>
                                            </div>
                                            <div class="flex items-center gap-3 text-xs">
                                                <span class="text-secondary capitalize">Mood: ${session.mood}</span>
                                                ${session.duration ? `
                                                    <span class="text-muted">‚Ä¢</span>
                                                    <span class="text-muted">${session.duration}m</span>
                                                ` : ''}
                                                ${session.confidence ? `
                                                    <span class="text-muted">‚Ä¢</span>
                                                    <span class="text-muted">Confidence: ${session.confidence}/10</span>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm font-medium ${session.outcome === 'win' ? 'text-success' : session.outcome === 'loss' ? 'text-error' : 'text-muted'}">
                                                ${session.outcome.charAt(0).toUpperCase() + session.outcome.slice(1)}
                                            </div>
                                            ${session.mistakes?.length > 0 ? `
                                                <div class="text-xs text-warning mt-1">${session.mistakes.length} mistake${session.mistakes.length > 1 ? 's' : ''}</div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            modal.classList.add('active');
        },
        
        closeAllSessions() {
            const modal = document.getElementById('all-sessions-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        },
        
        createAllSessionsModal() {
            const modalHTML = `
                <div id="all-sessions-modal" class="modal-overlay">
                    <div class="modal-content" style="max-width: 1000px; max-height: 80vh; overflow-y: auto;">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-primary">All Sessions</h2>
                                <p class="text-sm text-secondary mt-1">Complete trading history</p>
                            </div>
                            <button onclick="app.closeAllSessions()" class="text-secondary hover:text-primary transition-colors">
                                <iconify-icon icon="solar:close-circle-bold" width="28"></iconify-icon>
                            </button>
                        </div>
                        <div id="all-sessions-body">
                            <!-- Sessions will be loaded here -->
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        },

        // ========== NEW FEATURES ADDED ==========
        
        // Export/Import functionality
        exportData() {
            const data = {
                sessions: this.state.sessions,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `edgemetrics-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            this.showToast('Data exported successfully', 'success');
        },
        
        exportCSV() {
            if (this.state.sessions.length === 0) {
                this.showToast('No sessions to export', 'error');
                return;
            }
            
            const headers = ['Date', 'Time', 'Instrument', 'Duration (min)', 'Mood', 'Confidence', 'Outcome', 'Pre-Session Notes', 'Post-Session Notes', 'Mistakes'];
            const rows = this.state.sessions.map(session => {
                const date = new Date(session.startTime);
                return [
                    date.toLocaleDateString(),
                    date.toLocaleTimeString(),
                    session.instrument,
                    session.duration || '',
                    session.mood,
                    session.confidence || '',
                    session.outcome,
                    (session.preNotes || '').replace(/"/g, '""'),
                    (session.postNotes || '').replace(/"/g, '""'),
                    (session.mistakes || []).join('; ')
                ];
            });
            
            const csv = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `edgemetrics-sessions-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            this.showToast('CSV exported successfully', 'success');
        },
        
        importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (!data.sessions || !Array.isArray(data.sessions)) {
                            throw new Error('Invalid backup file format');
                        }
                        
                        const confirmMsg = `This will import ${data.sessions.length} sessions. Current sessions will be merged. Continue?`;
                        if (!confirm(confirmMsg)) return;
                        
                        // Merge sessions (avoid duplicates by ID)
                        const existingIds = new Set(this.state.sessions.map(s => s.id));
                        const newSessions = data.sessions.filter(s => !existingIds.has(s.id));
                        
                        this.state.sessions = [...this.state.sessions, ...newSessions];
                        this.saveState();
                        this.renderDashboard();
                        
                        this.showToast(`Imported ${newSessions.length} new sessions`, 'success');
                    } catch (err) {
                        this.showToast('Failed to import data: ' + err.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        },
        
        // Search and Filter
        searchSessions(query) {
            const resultsCount = document.getElementById('search-results-count');
            
            if (!query) {
                query = '';
            }
            
            query = query.toLowerCase().trim();
            
            if (!query) {
                this.state.filteredSessions = null;
                if (resultsCount) {
                    resultsCount.classList.add('hidden');
                }
                this.renderDashboard();
                return;
            }
            
            this.state.filteredSessions = this.state.sessions.filter(session => {
                try {
                    return (session.instrument && session.instrument.toLowerCase().includes(query)) ||
                           (session.preNotes && session.preNotes.toLowerCase().includes(query)) ||
                           (session.postNotes && session.postNotes.toLowerCase().includes(query)) ||
                           (session.outcome && session.outcome.toLowerCase().includes(query)) ||
                           (session.mood && session.mood.toLowerCase().includes(query)) ||
                           (session.mistakes && session.mistakes.some(m => m && m.toLowerCase().includes(query)));
                } catch (e) {
                    console.error('Search error for session:', session, e);
                    return false;
                }
            });
            
            this.renderDashboard();
            
            // Show results count
            if (resultsCount) {
                resultsCount.textContent = `${this.state.filteredSessions.length} found`;
                resultsCount.classList.remove('hidden');
            }
            
            // Show feedback only when no results
            if (this.state.filteredSessions.length === 0) {
                this.showToast('No sessions found matching your search', 'info');
            }
        },
        
        filterByOutcome(outcome) {
            if (!outcome || outcome === 'all') {
                this.state.filteredSessions = null;
            } else {
                this.state.filteredSessions = this.state.sessions.filter(s => s.outcome === outcome);
            }
            this.renderDashboard();
        },
        
        filterByInstrument(instrument) {
            if (!instrument || instrument === 'all') {
                this.state.filteredSessions = null;
            } else {
                this.state.filteredSessions = this.state.sessions.filter(s => s.instrument === instrument);
            }
            this.renderDashboard();
        },
        
        filterByDateRange(startDate, endDate) {
            if (!startDate && !endDate) {
                this.state.filteredSessions = null;
                this.renderDashboard();
                return;
            }
            
            this.state.filteredSessions = this.state.sessions.filter(session => {
                const sessionDate = new Date(session.startTime);
                const start = startDate ? new Date(startDate) : new Date('2000-01-01');
                const end = endDate ? new Date(endDate) : new Date('2100-12-31');
                return sessionDate >= start && sessionDate <= end;
            });
            
            this.renderDashboard();
        },
        
        clearFilters() {
            this.state.filteredSessions = null;
            const searchInput = document.getElementById('search-input');
            const outcomeFilter = document.getElementById('outcome-filter');
            const instrumentFilter = document.getElementById('instrument-filter');
            const resultsCount = document.getElementById('search-results-count');
            
            if (searchInput) searchInput.value = '';
            if (outcomeFilter) outcomeFilter.value = 'all';
            if (instrumentFilter) instrumentFilter.value = 'all';
            if (resultsCount) resultsCount.classList.add('hidden');
            
            this.renderDashboard();
            this.showToast('Filters cleared', 'success');
        },
        
        // Edit Session
        editSession(sessionId) {
            const session = this.state.sessions.find(s => s.id === sessionId);
            if (!session) {
                this.showToast('Session not found', 'error');
                return;
            }
            
            // Populate form with existing data
            document.getElementById('instrument').value = session.instrument;
            document.getElementById('mood').value = session.mood;
            document.getElementById('outcome').value = session.outcome;
            document.getElementById('pre-notes').value = session.preNotes || '';
            document.getElementById('post-notes').value = session.postNotes || '';
            document.getElementById('duration').value = session.duration || '';
            document.getElementById('confidence').value = session.confidence || '';
            
            // Store editing session ID
            this.state.editingSessionId = sessionId;
            
            // Update form title and button
            const formTitle = document.querySelector('.text-2xl.font-bold');
            if (formTitle) formTitle.textContent = 'Edit Session';
            
            const submitBtn = document.querySelector('button[onclick="app.submitSession()"]');
            if (submitBtn) {
                submitBtn.textContent = 'Update Session';
                submitBtn.onclick = () => this.updateSession();
            }
            
            // Close any open modals
            this.closeSessionDetail();
            
            // Scroll to form
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            this.showToast('Editing session - update and save when ready', 'success');
        },
        
        updateSession() {
            if (!this.state.editingSessionId) {
                this.showToast('No session being edited', 'error');
                return;
            }
            
            const sessionIndex = this.state.sessions.findIndex(s => s.id === this.state.editingSessionId);
            if (sessionIndex === -1) {
                this.showToast('Session not found', 'error');
                return;
            }
            
            // Get updated values
            const instrument = document.getElementById('instrument').value;
            const mood = document.getElementById('mood').value;
            const outcome = document.getElementById('outcome').value;
            const preNotes = document.getElementById('pre-notes').value;
            const postNotes = document.getElementById('post-notes').value;
            const duration = parseInt(document.getElementById('duration').value) || null;
            const confidence = parseInt(document.getElementById('confidence').value) || null;
            
            if (!instrument || !mood || !outcome) {
                this.showToast('Please fill in required fields', 'error');
                return;
            }
            
            // Update session
            this.state.sessions[sessionIndex] = {
                ...this.state.sessions[sessionIndex],
                instrument,
                mood,
                outcome,
                preNotes,
                postNotes,
                duration,
                confidence
            };
            
            this.saveState();
            this.renderDashboard();
            this.cancelEdit();
            this.showToast('Session updated successfully', 'success');
        },
        
        cancelEdit() {
            this.state.editingSessionId = null;
            
            // Reset form
            document.getElementById('session-form').reset();
            
            // Reset form title and button
            const formTitle = document.querySelector('.text-2xl.font-bold');
            if (formTitle) formTitle.textContent = 'New Session';
            
            const submitBtn = document.querySelector('button[onclick="app.updateSession()"]');
            if (submitBtn) {
                submitBtn.textContent = 'Log Session';
                submitBtn.onclick = () => this.submitSession();
            }
        },
        
        // Delete Session
        deleteSession(sessionId) {
            const session = this.state.sessions.find(s => s.id === sessionId);
            if (!session) {
                this.showToast('Session not found', 'error');
                return;
            }
            
            const date = new Date(session.startTime).toLocaleString();
            const confirmMsg = `Delete session from ${date} (${session.instrument} - ${session.outcome})?\n\nThis cannot be undone.`;
            
            if (!confirm(confirmMsg)) return;
            
            this.state.sessions = this.state.sessions.filter(s => s.id !== sessionId);
            this.saveState();
            this.renderDashboard();
            this.closeSessionDetail();
            
            this.showToast('Session deleted', 'success');
        },
        
        // Keyboard shortcuts
        initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + N: New session (focus instrument field)
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    document.getElementById('instrument')?.focus();
                }
                
                // Ctrl/Cmd + E: Export
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    this.exportData();
                }
                
                // Ctrl/Cmd + F: Focus search
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('search-input')?.focus();
                }
                
                // ?: Show keyboard shortcuts
                if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    this.showKeyboardShortcuts();
                }
                
                // Escape: Close modals
                if (e.key === 'Escape') {
                    this.closeSessionDetail();
                    this.closeDayHistory();
                    this.closeKeyboardShortcuts();
                    this.closeAllSessions();
                    this.closeAnalytics();
                }
            });
        },
        
        // Show data persistence warning
        showDataWarning() {
            const warningShown = localStorage.getItem('edgemetrics-warning-shown');
            if (warningShown) return;
            
            setTimeout(() => {
                const showWarning = confirm(
                    '‚ö†Ô∏è DATA STORAGE NOTICE\n\n' +
                    'Your trading journal data is stored locally in your browser.\n\n' +
                    '‚Ä¢ Data will be lost if you clear browser data\n' +
                    '‚Ä¢ Data is not synced across devices\n' +
                    '‚Ä¢ Regular backups are recommended\n\n' +
                    'Use "Export Data" to create backups regularly.\n\n' +
                    'Click OK to acknowledge and don\'t show again.'
                );
                
                if (showWarning) {
                    localStorage.setItem('edgemetrics-warning-shown', 'true');
                }
            }, 2000);
        },
        
        // Get unique instruments for filter
        getUniqueInstruments() {
            const instruments = new Set();
            this.state.sessions.forEach(s => instruments.add(s.instrument));
            return Array.from(instruments).sort();
        },
        
        // Advanced Analytics
        getAnalyticsByInstrument() {
            const analytics = {};
            
            this.state.sessions.forEach(session => {
                if (!analytics[session.instrument]) {
                    analytics[session.instrument] = {
                        total: 0,
                        wins: 0,
                        losses: 0,
                        breakeven: 0,
                        totalDuration: 0
                    };
                }
                
                analytics[session.instrument].total++;
                if (session.outcome === 'win') analytics[session.instrument].wins++;
                if (session.outcome === 'loss') analytics[session.instrument].losses++;
                if (session.outcome === 'breakeven' || session.outcome === 'no-trade') {
                    analytics[session.instrument].breakeven++;
                }
                if (session.duration) {
                    analytics[session.instrument].totalDuration += session.duration;
                }
            });
            
            // Calculate win rates
            Object.keys(analytics).forEach(instrument => {
                const data = analytics[instrument];
                data.winRate = data.total > 0 ? ((data.wins / data.total) * 100).toFixed(1) : 0;
                data.avgDuration = data.total > 0 ? Math.round(data.totalDuration / data.total) : 0;
            });
            
            return analytics;
        },
        
        getAnalyticsByMood() {
            const analytics = {};
            
            this.state.sessions.forEach(session => {
                if (!analytics[session.mood]) {
                    analytics[session.mood] = { total: 0, wins: 0, losses: 0 };
                }
                
                analytics[session.mood].total++;
                if (session.outcome === 'win') analytics[session.mood].wins++;
                if (session.outcome === 'loss') analytics[session.mood].losses++;
            });
            
            Object.keys(analytics).forEach(mood => {
                const data = analytics[mood];
                data.winRate = data.total > 0 ? ((data.wins / data.total) * 100).toFixed(1) : 0;
            });
            
            return analytics;
        },
        
        getMistakeFrequency() {
            const mistakes = {};
            
            this.state.sessions.forEach(session => {
                if (session.mistakes && session.mistakes.length > 0) {
                    session.mistakes.forEach(mistake => {
                        mistakes[mistake] = (mistakes[mistake] || 0) + 1;
                    });
                }
            });
            
            return Object.entries(mistakes)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
        },
        
        showAdvancedAnalytics() {
            const modal = document.getElementById('analytics-modal');
            const body = document.getElementById('analytics-body');
            
            const byInstrument = this.getAnalyticsByInstrument();
            const byMood = this.getAnalyticsByMood();
            const mistakes = this.getMistakeFrequency();
            
            body.innerHTML = `
                <div class="space-y-6">
                    <!-- By Instrument -->
                    <div class="stat-card">
                        <h3 class="text-sm font-semibold text-primary mb-4 uppercase tracking-wide">Performance by Instrument</h3>
                        <div class="space-y-3">
                            ${Object.entries(byInstrument).map(([instrument, data]) => `
                                <div class="flex items-center justify-between p-3 bg-[#0a0a0a] border border-[#222222] rounded">
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-primary">${instrument}</div>
                                        <div class="text-xs text-muted">${data.total} sessions ‚Ä¢ ${data.avgDuration}m avg</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-bold ${parseFloat(data.winRate) >= 50 ? 'text-success' : 'text-error'}">${data.winRate}%</div>
                                        <div class="text-xs text-muted">${data.wins}W ${data.losses}L</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- By Mood -->
                    <div class="stat-card">
                        <h3 class="text-sm font-semibold text-primary mb-4 uppercase tracking-wide">Performance by Mood</h3>
                        <div class="space-y-3">
                            ${Object.entries(byMood).map(([mood, data]) => `
                                <div class="flex items-center justify-between p-3 bg-[#0a0a0a] border border-[#222222] rounded">
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-primary capitalize">${mood}</div>
                                        <div class="text-xs text-muted">${data.total} sessions</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-bold ${parseFloat(data.winRate) >= 50 ? 'text-success' : 'text-error'}">${data.winRate}%</div>
                                        <div class="text-xs text-muted">${data.wins}W ${data.losses}L</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Top Mistakes -->
                    ${mistakes.length > 0 ? `
                        <div class="stat-card">
                            <h3 class="text-sm font-semibold text-primary mb-4 uppercase tracking-wide">Most Common Mistakes</h3>
                            <div class="space-y-2">
                                ${mistakes.map(([mistake, count]) => `
                                    <div class="flex items-center justify-between p-2 bg-[#0a0a0a] border border-[#222222] rounded">
                                        <div class="text-sm text-warning">${mistake}</div>
                                        <div class="text-xs text-muted">${count}x</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <button onclick="app.closeAnalytics()" class="btn-primary w-full">Close</button>
                </div>
            `;
            
            modal.classList.add('active');
        },
        
        closeAnalytics() {
            document.getElementById('analytics-modal').classList.remove('active');
        },
        
        // ========== FAVORITE INSTRUMENTS SYSTEM ==========
        
        showLoading(message = 'Loading...') {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.add('active');
                const msgEl = overlay.querySelector('.loading-message');
                if (msgEl) msgEl.textContent = message;
            }
        },
        
        hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
        },
        
        toggleFavoriteInstrument(instrument) {
            if (!instrument) return;
            
            const index = this.state.favoriteInstruments.indexOf(instrument);
            if (index > -1) {
                // Remove from favorites
                this.state.favoriteInstruments.splice(index, 1);
                this.showToast(`Removed ${instrument} from favorites`, 'success');
            } else {
                // Add to favorites
                this.state.favoriteInstruments.push(instrument);
                this.showToast(`Added ${instrument} to favorites`, 'success');
            }
            
            // Save to localStorage
            localStorage.setItem('edgemetrics_favorites', JSON.stringify(this.state.favoriteInstruments));
            this.updateInstrumentDropdown();
        },
        
        isFavoriteInstrument(instrument) {
            return this.state.favoriteInstruments.includes(instrument);
        },
        
        updateInstrumentDropdown() {
            const select = document.getElementById('session-instrument');
            if (!select) return;
            
            const currentValue = select.value;
            const favGroup = document.getElementById('favorites-optgroup');
            
            if (!favGroup) return;
            
            // Clear existing favorites
            favGroup.innerHTML = '';
            
            // Show or hide the favorites optgroup based on whether there are favorites
            if (this.state.favoriteInstruments.length > 0) {
                favGroup.style.display = '';
                
                this.state.favoriteInstruments.forEach(fav => {
                    // Find the option in all optgroups
                    const allOptions = select.querySelectorAll('option');
                    const originalOption = Array.from(allOptions).find(opt => opt.value === fav);
                    if (originalOption) {
                        const option = document.createElement('option');
                        option.value = fav;
                        option.textContent = originalOption.textContent;
                        favGroup.appendChild(option);
                    }
                });
            } else {
                favGroup.style.display = 'none';
            }
            
            // Add favorite toggle button after select
            this.addFavoriteToggleButton();
            
            // Restore selected value
            select.value = currentValue;
        },
        
        addFavoriteToggleButton() {
            const select = document.getElementById('session-instrument');
            if (!select) return;
            
            // Remove existing button if any
            const existingBtn = document.getElementById('favorite-toggle-btn');
            if (existingBtn) existingBtn.remove();
            
            const currentInstrument = select.value;
            if (!currentInstrument) return;
            
            const isFav = this.isFavoriteInstrument(currentInstrument);
            
            const button = document.createElement('button');
            button.id = 'favorite-toggle-btn';
            button.type = 'button';
            button.className = 'btn-secondary px-3 py-2 text-xs ml-2';
            button.innerHTML = `
                <iconify-icon icon="solar:${isFav ? 'star-bold' : 'star-linear'}" width="16" class="${isFav ? 'text-yellow-500' : ''}"></iconify-icon>
                <span class="ml-1">${isFav ? 'Remove from' : 'Add to'} Favorites</span>
            `;
            button.onclick = () => this.toggleFavoriteInstrument(currentInstrument);
            
            // Insert after the select element
            select.parentNode.insertBefore(button, select.nextSibling);
        },
        
        // ========== STREAK TRACKING ==========
        
        calculateWinStreak() {
            const sessions = [...this.state.sessions]
                .sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
            
            let streak = 0;
            for (const session of sessions) {
                if (session.outcome === 'win') {
                    streak++;
                } else if (session.outcome === 'loss') {
                    break;
                }
            }
            return streak;
        },
        
        calculateJournalingStreak() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let streak = 0;
            let checkDate = new Date(today);
            
            while (true) {
                const dayStr = checkDate.toDateString();
                const hasSession = this.state.sessions.some(s => 
                    new Date(s.startTime).toDateString() === dayStr
                );
                
                if (hasSession) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            return streak;
        },
        
        updateStreakDisplays() {
            const winStreak = this.calculateWinStreak();
            const journalingStreak = this.calculateJournalingStreak();
            
            const headerStreak = document.getElementById('header-win-streak');
            if (headerStreak) {
                headerStreak.textContent = winStreak;
            }
        },
        
        // ========== KEYBOARD SHORTCUTS HELP ==========
        
        showKeyboardShortcuts() {
            const modal = document.getElementById('shortcuts-modal');
            if (!modal) {
                this.createShortcutsModal();
                return this.showKeyboardShortcuts();
            }
            modal.classList.add('active');
        },
        
        closeKeyboardShortcuts() {
            const modal = document.getElementById('shortcuts-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        },
        
        createShortcutsModal() {
            const modalHTML = `
                <div id="shortcuts-modal" class="modal-overlay">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-primary">‚å®Ô∏è Keyboard Shortcuts</h2>
                            <button onclick="app.closeKeyboardShortcuts()" class="text-secondary hover:text-primary">
                                <iconify-icon icon="solar:close-circle-bold" width="28"></iconify-icon>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div class="p-3 bg-[#111111] border border-[#222222] rounded flex justify-between items-center">
                                <span class="text-sm">New Session</span>
                                <kbd class="kbd">Ctrl+N</kbd>
                            </div>
                            <div class="p-3 bg-[#111111] border border-[#222222] rounded flex justify-between items-center">
                                <span class="text-sm">Search Sessions</span>
                                <kbd class="kbd">Ctrl+F</kbd>
                            </div>
                            <div class="p-3 bg-[#111111] border border-[#222222] rounded flex justify-between items-center">
                                <span class="text-sm">Export Data</span>
                                <kbd class="kbd">Ctrl+E</kbd>
                            </div>
                            <div class="p-3 bg-[#111111] border border-[#222222] rounded flex justify-between items-center">
                                <span class="text-sm">Close Modal</span>
                                <kbd class="kbd">Esc</kbd>
                            </div>
                            <div class="p-3 bg-[#111111] border border-[#222222] rounded flex justify-between items-center">
                                <span class="text-sm">Show Shortcuts</span>
                                <kbd class="kbd">?</kbd>
                            </div>
                        </div>
                        <button onclick="app.closeKeyboardShortcuts()" class="btn-primary w-full mt-6">Got it!</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        },
        
        // ========== AUTO-SAVE DRAFT ==========
        
        initAutoSave() {
            setInterval(() => this.autoSaveDraft(), 30000);
        },
        
        autoSaveDraft() {
            const form = document.querySelector('#session-overlay');
            if (!form || !form.classList.contains('active')) return;
            
            const draft = {
                instrument: document.getElementById('session-instrument')?.value || '',
                preNotes: document.getElementById('session-pre-notes')?.value || '',
                timestamp: new Date().toISOString()
            };
            
            if (draft.instrument || draft.preNotes) {
                localStorage.setItem('edgemetrics_session_draft', JSON.stringify(draft));
            }
        },
        
        clearDraft() {
            localStorage.removeItem('edgemetrics_session_draft');
        },
        
        // Helper method to clear all data and regenerate samples (for testing)
        clearAllDataAndRegenerate() {
            if (confirm('This will delete all your trading data and generate new sample data. Are you sure?')) {
                localStorage.clear();
                this.state.sessions = this.generateSampleSessions();
                this.saveSessions();
                this.renderDashboard();
                this.updateUserStats();
                this.updateQuickStats();
                this.updatePnL();
                this.showToast('Data cleared and regenerated with sample sessions', 'success');
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        app.init();
        app.initKeyboardShortcuts();
        app.showDataWarning();
        app.initAutoSave();
        app.updateStreakDisplays();
    });
    </script>
    
    <!-- Session Detail Modal -->
    <div id="session-detail-modal" class="session-detail-modal">
        <div class="session-detail-content">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-primary">Session Details</h2>
                <button onclick="app.closeSessionDetail()" class="text-secondary hover:text-primary transition-colors">
                    <iconify-icon icon="solar:close-circle-bold" width="28"></iconify-icon>
                </button>
            </div>
            <div id="session-detail-body">
                <!-- Session details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- NEW: Advanced Analytics Modal -->
    <div id="analytics-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-primary">Advanced Analytics</h2>
                    <p class="text-sm text-secondary mt-1">Detailed performance breakdowns and insights</p>
                </div>
                <button onclick="app.closeAnalytics()" class="text-secondary hover:text-primary transition-colors">
                    <iconify-icon icon="solar:close-circle-bold" width="28"></iconify-icon>
                </button>
            </div>
            <div id="analytics-body">
                <!-- Analytics content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- 10/10 ENHANCEMENTS - NEW FEATURES BELOW -->
    <!-- ============================================ -->

    <!-- Enhancement #1: Interactive Tutorial System -->
    <div id="tutorial-overlay" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="tutorial-content">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-2">üëã Welcome to EdgeMetrics!</h2>
                    <p class="text-secondary">Let's take a quick tour of your new trading journal</p>
                </div>
                
                <div id="tutorial-steps">
                    <!-- Step 1 -->
                    <div class="tutorial-step active" data-step="1">
                        <div class="text-sm text-muted mb-2">1/5</div>
                        <iconify-icon icon="solar:notes-bold" width="48" class="text-green-500 mb-4"></iconify-icon>
                        <h3 class="text-xl font-bold mb-2">Start Your First Session</h3>
                        <p class="text-secondary mb-4">Click "Start Session" to log your trading activity in real-time</p>
                        <button onclick="app.nextTutorialStep()" class="btn-primary w-full">Next ‚Üí</button>
                    </div>
                    
                    <!-- Step 2 -->
                    <div class="tutorial-step hidden" data-step="2">
                        <div class="text-sm text-muted mb-2">2/5</div>
                        <iconify-icon icon="solar:chart-bold" width="48" class="text-blue-500 mb-4"></iconify-icon>
                        <h3 class="text-xl font-bold mb-2">Track Your Performance</h3>
                        <p class="text-secondary mb-4">EdgeMetrics automatically calculates your P&L, win rate, and streaks</p>
                        <button onclick="app.nextTutorialStep()" class="btn-primary w-full">Next ‚Üí</button>
                    </div>
                    
                    <!-- Step 3 -->
                    <div class="tutorial-step hidden" data-step="3">
                        <div class="text-sm text-muted mb-2">3/5</div>
                        <iconify-icon icon="solar:star-shine-bold" width="48" class="text-yellow-500 mb-4"></iconify-icon>
                        <h3 class="text-xl font-bold mb-2">Your EdgeScore‚Ñ¢</h3>
                        <p class="text-secondary mb-4">Get a comprehensive 0-100 score measuring consistency, discipline, and quality</p>
                        <button onclick="app.nextTutorialStep()" class="btn-primary w-full">Next ‚Üí</button>
                    </div>
                    
                    <!-- Step 4 -->
                    <div class="tutorial-step hidden" data-step="4">
                        <div class="text-sm text-muted mb-2">4/5</div>
                        <iconify-icon icon="solar:shield-check-bold" width="48" class="text-purple-500 mb-4"></iconify-icon>
                        <h3 class="text-xl font-bold mb-2">Privacy First</h3>
                        <p class="text-secondary mb-4">All your data stays on YOUR device. No cloud, no tracking, no servers.</p>
                        <button onclick="app.nextTutorialStep()" class="btn-primary w-full">Next ‚Üí</button>
                    </div>
                    
                    <!-- Step 5 -->
                    <div class="tutorial-step hidden" data-step="5">
                        <div class="text-sm text-muted mb-2">5/5</div>
                        <iconify-icon icon="solar:rocket-2-bold" width="48" class="text-green-500 mb-4"></iconify-icon>
                        <h3 class="text-xl font-bold mb-2">You're Ready!</h3>
                        <p class="text-secondary mb-4">Press Ctrl+N anytime to start a new session. Good luck trading! üöÄ</p>
                        <button onclick="app.completeTutorial()" class="btn-primary w-full">Start Trading</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhancement #2: Keyboard Shortcuts Panel -->
    <button onclick="app.toggleShortcutsPanel()" 
            class="fixed bottom-6 right-6 w-12 h-12 bg-green-500 hover:bg-green-600 rounded-full shadow-lg flex items-center justify-center z-40 transition-all hover:scale-110">
        <iconify-icon icon="solar:keyboard-bold" width="24" class="text-white"></iconify-icon>
    </button>

    <div id="shortcuts-panel" class="fixed top-0 right-0 h-full w-80 bg-[#0a0a0a] border-l border-[#222] shadow-2xl transform translate-x-full transition-transform duration-300 z-50 overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold">‚å®Ô∏è Keyboard Shortcuts</h3>
                <button onclick="app.toggleShortcutsPanel()" class="text-secondary hover:text-primary">
                    <iconify-icon icon="solar:close-circle-bold" width="24"></iconify-icon>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="shortcut-group">
                    <div class="text-xs text-secondary uppercase mb-2">Navigation</div>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm">New Session</span>
                            <kbd class="kbd">Ctrl+N</kbd>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">Quick Log</span>
                            <kbd class="kbd">Ctrl+Q</kbd>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">Analytics</span>
                            <kbd class="kbd">Ctrl+A</kbd>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">Search</span>
                            <kbd class="kbd">Ctrl+F</kbd>
                        </div>
                    </div>
                </div>
                
                <div class="shortcut-group">
                    <div class="text-xs text-secondary uppercase mb-2">Actions</div>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm">Export Menu</span>
                            <kbd class="kbd">Ctrl+E</kbd>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">Achievements</span>
                            <kbd class="kbd">Ctrl+H</kbd>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">Learning</span>
                            <kbd class="kbd">Ctrl+L</kbd>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">Close Modal</span>
                            <kbd class="kbd">Esc</kbd>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">This Help</span>
                            <kbd class="kbd">?</kbd>
                        </div>
                    </div>
                </div>
                
                <div class="shortcut-group border-t border-[#222] pt-4">
                    <div class="text-xs text-secondary uppercase mb-2">üí° Pro Tips</div>
                    <div class="text-xs text-secondary leading-relaxed space-y-1">
                        <div>‚Ä¢ Use Tab to navigate forms quickly</div>
                        <div>‚Ä¢ Press Enter to submit forms</div>
                        <div>‚Ä¢ Double-click sessions to view details</div>
                        <div>‚Ä¢ Hold Shift for batch selection</div>
                    </div>
                </div>
                
                <div class="border-t border-[#222] pt-4">
                    <button onclick="app.showTutorial()" class="btn-secondary w-full text-xs py-2">
                        üìö Replay Tutorial
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhancement #3: Session Comparison Modal -->
    <div id="comparison-overlay" class="modal-overlay">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">üìä Session Comparison</h2>
                <button onclick="app.closeComparison()" class="text-secondary hover:text-primary">
                    <iconify-icon icon="solar:close-circle-bold" width="28"></iconify-icon>
                </button>
            </div>
            
            <div class="mb-4 text-sm text-secondary">
                Select two sessions from your journal to compare them side-by-side
            </div>
            
            <div class="grid grid-cols-2 gap-6" id="comparison-container">
                <div class="border border-[#222] rounded p-4">
                    <div class="text-sm text-muted mb-4">Session 1</div>
                    <div id="comparison-session-1" class="text-sm text-secondary">
                        No session selected
                    </div>
                </div>
                
                <div class="border border-[#222] rounded p-4">
                    <div class="text-sm text-muted mb-4">Session 2</div>
                    <div id="comparison-session-2" class="text-sm text-secondary">
                        No session selected
                    </div>
                </div>
            </div>
            
            <div id="comparison-insights-container" class="mt-6 p-4 bg-green-500/5 border border-green-500/20 rounded hidden">
                <div class="font-semibold mb-2">üîç Key Insights</div>
                <div id="comparison-insights" class="text-sm text-secondary space-y-1"></div>
            </div>
            
            <button onclick="app.clearComparison()" class="btn-secondary w-full mt-4">
                Clear Selection
            </button>
        </div>
    </div>

    <style>
    /* Tutorial Step Styles */
    .tutorial-step {
        text-align: center;
    }
    .tutorial-step.hidden {
        display: none !important;
    }
    .tutorial-step.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Shortcuts Panel Slide */
    #shortcuts-panel.active {
        transform: translateX(0) !important;
    }
    
    /* Comparison Selected State */
    .comparison-selected {
        border: 2px solid #10b981 !important;
        background: #10b981/5 !important;
    }
    </style>

    <script>
    // ============================================
    // 10/10 ENHANCEMENT JAVASCRIPT
    // ============================================

    // Enhancement #1: Tutorial System
    app.showTutorial = function() {
        const hasSeenTutorial = localStorage.getItem('edgemetrics_tutorial_completed');
        if (!hasSeenTutorial) {
            document.getElementById('tutorial-overlay').classList.add('active');
        }
    };

    app.nextTutorialStep = function() {
        const steps = document.querySelectorAll('.tutorial-step');
        const activeStep = document.querySelector('.tutorial-step.active');
        if (!activeStep) return;
        
        const currentIndex = parseInt(activeStep.dataset.step);
        
        if (currentIndex < steps.length) {
            activeStep.classList.remove('active');
            activeStep.classList.add('hidden');
            const nextStep = document.querySelector(`.tutorial-step[data-step="${currentIndex + 1}"]`);
            if (nextStep) {
                nextStep.classList.remove('hidden');
                nextStep.classList.add('active');
            }
        }
    };

    app.completeTutorial = function() {
        localStorage.setItem('edgemetrics_tutorial_completed', 'true');
        document.getElementById('tutorial-overlay').classList.remove('active');
        this.showToast('Tutorial complete! Press Ctrl+N to start trading üöÄ', 'success', 3000);
    };

    // Enhancement #2: Shortcuts Panel
    app.toggleShortcutsPanel = function() {
        const panel = document.getElementById('shortcuts-panel');
        panel.classList.toggle('active');
    };

    // Enhancement #3: Session Comparison
    app.comparisonSessions = [];

    app.selectForComparison = function(sessionId) {
        if (this.comparisonSessions.includes(sessionId)) {
            this.comparisonSessions = this.comparisonSessions.filter(id => id !== sessionId);
            this.showToast('Session removed from comparison', 'info');
        } else if (this.comparisonSessions.length < 2) {
            this.comparisonSessions.push(sessionId);
            this.showToast(`Session selected (${this.comparisonSessions.length}/2)`, 'info');
            
            if (this.comparisonSessions.length === 2) {
                setTimeout(() => this.showComparison(), 300);
            }
        } else {
            this.showToast('Already comparing 2 sessions. Clear to select new ones.', 'warning');
        }
        
        // Update UI
        document.querySelectorAll('.session-card').forEach(card => {
            card.classList.remove('comparison-selected');
        });
        this.comparisonSessions.forEach(id => {
            const card = document.querySelector(`[data-session-id="${id}"]`);
            if (card) card.classList.add('comparison-selected');
        });
    };

    app.showComparison = function() {
        if (this.comparisonSessions.length !== 2) return;
        
        const session1 = this.state.sessions.find(s => s.id === this.comparisonSessions[0]);
        const session2 = this.state.sessions.find(s => s.id === this.comparisonSessions[1]);
        
        if (!session1 || !session2) return;
        
        // Render session 1
        document.getElementById('comparison-session-1').innerHTML = this.renderSessionSummary(session1);
        
        // Render session 2
        document.getElementById('comparison-session-2').innerHTML = this.renderSessionSummary(session2);
        
        // Generate insights
        const insights = this.generateComparisonInsights(session1, session2);
        const insightsContainer = document.getElementById('comparison-insights-container');
        const insightsDiv = document.getElementById('comparison-insights');
        
        if (insights.length > 0) {
            insightsContainer.classList.remove('hidden');
            insightsDiv.innerHTML = insights.map(i => `<div>‚Ä¢ ${i}</div>`).join('');
        }
        
        // Show modal
        document.getElementById('comparison-overlay').classList.add('active');
    };

    app.renderSessionSummary = function(session) {
        const date = new Date(session.startTime);
        const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const formattedTime = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        
        return `
            <div class="space-y-3">
                <div>
                    <div class="text-xs text-muted">Date & Time</div>
                    <div class="font-medium">${formattedDate} ${formattedTime}</div>
                </div>
                <div>
                    <div class="text-xs text-muted">Instrument</div>
                    <div class="font-medium">${session.instrument}</div>
                </div>
                <div>
                    <div class="text-xs text-muted">Outcome</div>
                    <div class="font-medium capitalize ${session.outcome === 'win' ? 'text-success' : session.outcome === 'loss' ? 'text-error' : 'text-muted'}">
                        ${session.outcome}
                    </div>
                </div>
                ${session.pnl !== null && session.pnl !== undefined ? `
                <div>
                    <div class="text-xs text-muted">P&L</div>
                    <div class="font-medium ${session.pnl > 0 ? 'text-success' : session.pnl < 0 ? 'text-error' : ''}">
                        ${session.pnl > 0 ? '+' : ''}$${Math.abs(session.pnl).toFixed(2)}
                    </div>
                </div>
                ` : ''}
                <div>
                    <div class="text-xs text-muted">Mood</div>
                    <div class="font-medium capitalize">${session.mood}</div>
                </div>
                <div>
                    <div class="text-xs text-muted">Duration</div>
                    <div class="font-medium">${session.duration || 0} minutes</div>
                </div>
                ${session.mistakes && session.mistakes.length > 0 ? `
                <div>
                    <div class="text-xs text-muted">Mistakes</div>
                    <div class="font-medium text-error">${session.mistakes.length} violations</div>
                </div>
                ` : ''}
            </div>
        `;
    };

    app.generateComparisonInsights = function(s1, s2) {
        const insights = [];
        
        // Outcome comparison
        if (s1.outcome !== s2.outcome) {
            insights.push(`Different outcomes: ${s1.outcome.toUpperCase()} vs ${s2.outcome.toUpperCase()}`);
        }
        
        // P&L comparison
        if (s1.pnl !== null && s2.pnl !== null) {
            const diff = Math.abs(s1.pnl - s2.pnl);
            if (diff > 100) {
                insights.push(`Significant P&L difference: $${diff.toFixed(2)}`);
            }
            if (s1.pnl > 0 && s2.pnl < 0) {
                insights.push(`Session 1 was profitable, Session 2 was a loss`);
            } else if (s1.pnl < 0 && s2.pnl > 0) {
                insights.push(`Session 2 was profitable, Session 1 was a loss`);
            }
        }
        
        // Mood comparison
        if (s1.mood !== s2.mood) {
            insights.push(`Different emotional states: ${s1.mood} vs ${s2.mood}`);
        }
        
        // Mistake comparison
        const s1Mistakes = s1.mistakes ? s1.mistakes.length : 0;
        const s2Mistakes = s2.mistakes ? s2.mistakes.length : 0;
        if (s1Mistakes > s2Mistakes) {
            insights.push(`Session 1 had more rule violations (${s1Mistakes} vs ${s2Mistakes})`);
        } else if (s2Mistakes > s1Mistakes) {
            insights.push(`Session 2 had more rule violations (${s2Mistakes} vs ${s1Mistakes})`);
        }
        
        // Duration comparison
        if (s1.duration && s2.duration) {
            const durationDiff = Math.abs(s1.duration - s2.duration);
            if (durationDiff > 30) {
                insights.push(`Session duration varies by ${durationDiff} minutes`);
            }
        }
        
        // Instrument comparison
        if (s1.instrument !== s2.instrument) {
            insights.push(`Different instruments: ${s1.instrument} vs ${s2.instrument}`);
        }
        
        return insights;
    };

    app.closeComparison = function() {
        document.getElementById('comparison-overlay').classList.remove('active');
        // Clear comparison highlights when closing
        this.comparisonSessions = [];
        document.querySelectorAll('.session-card').forEach(card => {
            card.classList.remove('comparison-selected');
        });
    };

    app.clearComparison = function() {
        this.comparisonSessions = [];
        document.querySelectorAll('.session-card').forEach(card => {
            card.classList.remove('comparison-selected');
        });
        document.getElementById('comparison-insights-container').classList.add('hidden');
        document.getElementById('comparison-session-1').innerHTML = '<div class="text-secondary">No session selected</div>';
        document.getElementById('comparison-session-2').innerHTML = '<div class="text-secondary">No session selected</div>';
        this.closeComparison();
        this.showToast('Comparison cleared', 'info');
    };

    // Enhancement #4: Auto-Backup System
    app.checkBackupReminder = function() {
        const lastBackup = localStorage.getItem('edgemetrics_last_backup');
        const sessionCount = this.state.sessions.length;
        
        if (!lastBackup) {
            if (sessionCount >= 10) {
                this.showBackupReminder();
            }
        } else {
            const daysSinceBackup = (Date.now() - parseInt(lastBackup)) / (1000 * 60 * 60 * 24);
            const sessionsSinceBackup = sessionCount - (parseInt(localStorage.getItem('edgemetrics_backup_session_count')) || 0);
            
            if (daysSinceBackup >= 30 || sessionsSinceBackup >= 50) {
                this.showBackupReminder();
            }
        }
    };

    app.showBackupReminder = function() {
        const banner = document.createElement('div');
        banner.id = 'backup-reminder-banner';
        banner.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 z-50 bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 max-w-md shadow-lg';
        banner.innerHTML = `
            <div class="flex items-start gap-3">
                <iconify-icon icon="solar:cloud-upload-bold" width="24" class="text-yellow-500"></iconify-icon>
                <div class="flex-1">
                    <div class="font-semibold text-sm mb-1">üíæ Backup Reminder</div>
                    <div class="text-sm text-secondary mb-3">
                        You have ${this.state.sessions.length} sessions. Back up your data to prevent loss!
                    </div>
                    <div class="flex gap-2">
                        <button onclick="app.exportToJSON(); app.dismissBackupReminder();" class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-black text-xs rounded font-medium">
                            Backup Now
                        </button>
                        <button onclick="app.snoozeBackupReminder();" class="px-3 py-1 bg-[#222] hover:bg-[#333] text-xs rounded">
                            Remind in 7 Days
                        </button>
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="text-secondary hover:text-primary">
                    <iconify-icon icon="solar:close-circle-line-duotone" width="20"></iconify-icon>
                </button>
            </div>
        `;
        
        // Remove existing banner if present
        const existing = document.getElementById('backup-reminder-banner');
        if (existing) existing.remove();
        
        document.body.appendChild(banner);
        
        setTimeout(() => {
            if (banner.parentElement) banner.remove();
        }, 10000);
    };

    app.dismissBackupReminder = function() {
        localStorage.setItem('edgemetrics_last_backup', Date.now().toString());
        localStorage.setItem('edgemetrics_backup_session_count', this.state.sessions.length.toString());
        const banner = document.getElementById('backup-reminder-banner');
        if (banner) banner.remove();
    };

    app.snoozeBackupReminder = function() {
        const snoozeUntil = Date.now() + (7 * 24 * 60 * 60 * 1000);
        localStorage.setItem('edgemetrics_last_backup', snoozeUntil.toString());
        const banner = document.getElementById('backup-reminder-banner');
        if (banner) banner.remove();
        this.showToast('Reminder snoozed for 7 days', 'info');
    };

    // Initialize new features on load
    document.addEventListener('DOMContentLoaded', function() {
        // Show tutorial for first-time users
        setTimeout(() => {
            app.showTutorial();
        }, 1000);
        
        // Check backup reminder
        setTimeout(() => {
            app.checkBackupReminder();
        }, 5000);
        
        // Initialize new features
        setTimeout(() => {
            app.initializeScreenshotUpload();
            app.initializeTagSuggestions();
            app.refreshPredictiveInsights();
            app.loadThemeSettings();
            app.showDailyPrompt(); // Ensure reflection prompt loads
        }, 500);
        
        // Add keyboard shortcut for help panel
        document.addEventListener('keydown', function(e) {
            if (e.key === '?' && !e.ctrlKey && !e.altKey) {
                const activeElement = document.activeElement;
                if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    app.toggleShortcutsPanel();
                }
            }
        });
    });

    // ============================================
    // ENHANCEMENT #5: Screenshot Upload System (with Compression & IndexedDB)
    // ============================================
    
    // Initialize IndexedDB for screenshot storage
    app.initImageDB = function() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('EdgeMetricsImages', 1);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('screenshots')) {
                    db.createObjectStore('screenshots', { keyPath: 'id' });
                }
            };
        });
    };

    // Compress image before storing
    app.compressImage = function(file, maxWidth = 800, quality = 0.8) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Resize if too large
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to compressed blob
                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/jpeg', quality);
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    };

    // Save screenshot to IndexedDB
    app.saveScreenshotToDB = function(blob, sessionId, index) {
        return new Promise(async (resolve, reject) => {
            try {
                const db = await this.initImageDB();
                const transaction = db.transaction(['screenshots'], 'readwrite');
                const store = transaction.objectStore('screenshots');
                
                const id = `${sessionId}-${index}`;
                const screenshot = {
                    id: id,
                    sessionId: sessionId,
                    blob: blob,
                    timestamp: Date.now()
                };
                
                const request = store.put(screenshot);
                request.onsuccess = () => resolve(id);
                request.onerror = () => reject(request.error);
            } catch (error) {
                reject(error);
            }
        });
    };

    // Load screenshot from IndexedDB
    app.loadScreenshotFromDB = function(screenshotId) {
        return new Promise(async (resolve, reject) => {
            try {
                const db = await this.initImageDB();
                const transaction = db.transaction(['screenshots'], 'readonly');
                const store = transaction.objectStore('screenshots');
                
                const request = store.get(screenshotId);
                request.onsuccess = () => {
                    if (request.result && request.result.blob) {
                        const url = URL.createObjectURL(request.result.blob);
                        resolve(url);
                    } else {
                        resolve(null);
                    }
                };
                request.onerror = () => reject(request.error);
            } catch (error) {
                reject(error);
            }
        });
    };

    // Delete screenshot from IndexedDB
    app.deleteScreenshotFromDB = function(screenshotId) {
        return new Promise(async (resolve, reject) => {
            try {
                const db = await this.initImageDB();
                const transaction = db.transaction(['screenshots'], 'readwrite');
                const store = transaction.objectStore('screenshots');
                
                const request = store.delete(screenshotId);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            } catch (error) {
                reject(error);
            }
        });
    };
    
    app.initializeScreenshotUpload = function() {
        const input = document.getElementById('session-screenshots');
        const preview = document.getElementById('screenshot-preview');
        
        if (!input || !preview) return;
        
        // Remove existing listener
        input.replaceWith(input.cloneNode(true));
        const newInput = document.getElementById('session-screenshots');
        
        newInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            
            if (!this.state.currentSession.screenshots) {
                this.state.currentSession.screenshots = [];
            }
            
            // Show loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'text-xs text-secondary text-center py-2';
            loadingDiv.textContent = 'Compressing images...';
            preview.appendChild(loadingDiv);
            
            for (const file of files) {
                try {
                    // Compress the image
                    const compressedBlob = await this.compressImage(file);
                    
                    // Save to IndexedDB
                    const sessionId = this.state.currentSession.id;
                    const index = this.state.currentSession.screenshots.length;
                    const screenshotId = await this.saveScreenshotToDB(compressedBlob, sessionId, index);
                    
                    // Store only the ID reference (not the actual image data)
                    this.state.currentSession.screenshots.push(screenshotId);
                    
                    console.log(`Screenshot compressed and saved: ${screenshotId}`);
                } catch (error) {
                    console.error('Error processing screenshot:', error);
                    this.showToast('Error uploading screenshot', 'error');
                }
            }
            
            // Remove loading indicator and refresh preview
            loadingDiv.remove();
            await this.refreshScreenshotPreview();
            this.showToast(`${files.length} screenshot(s) uploaded & compressed`, 'success');
        });
    };

    app.refreshScreenshotPreview = async function() {
        const preview = document.getElementById('screenshot-preview');
        if (!preview) return;
        
        preview.innerHTML = '';
        
        if (!this.state.currentSession.screenshots || this.state.currentSession.screenshots.length === 0) {
            return;
        }
        
        for (let i = 0; i < this.state.currentSession.screenshots.length; i++) {
            const screenshotId = this.state.currentSession.screenshots[i];
            
            const imgContainer = document.createElement('div');
            imgContainer.className = 'relative group';
            
            // Load image from IndexedDB
            try {
                const imgUrl = await this.loadScreenshotFromDB(screenshotId);
                
                if (imgUrl) {
                    const img = document.createElement('img');
                    img.src = imgUrl;
                    img.className = 'w-full h-20 object-cover rounded border border-[#222] hover:border-[#333]';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white rounded-full w-5 h-5 hidden group-hover:flex items-center justify-center text-xs';
                    removeBtn.innerHTML = '√ó';
                    
                    // Capture index in closure
                    const currentIndex = i;
                    removeBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.removeScreenshot(currentIndex);
                    });
                    
                    imgContainer.appendChild(img);
                    imgContainer.appendChild(removeBtn);
                    preview.appendChild(imgContainer);
                }
            } catch (error) {
                console.error('Error loading screenshot:', error);
            }
        }
    };

    app.removeScreenshot = async function(index) {
        if (this.state.currentSession.screenshots && index < this.state.currentSession.screenshots.length) {
            const screenshotId = this.state.currentSession.screenshots[index];
            
            // Delete from IndexedDB
            try {
                await this.deleteScreenshotFromDB(screenshotId);
                console.log(`Screenshot deleted: ${screenshotId}`);
            } catch (error) {
                console.error('Error deleting screenshot:', error);
            }
            
            // Remove from array
            this.state.currentSession.screenshots.splice(index, 1);
            await this.refreshScreenshotPreview();
            this.showToast('Screenshot removed', 'info');
        }
    };

    // ============================================
    // ENHANCEMENT #6: Tag System
    // ============================================
    
    app.initializeTagSuggestions = function() {
        const popularTags = [
            'üî• Breakout', 'üîÑ Reversal', 'üì∞ News Event', '‚ö° Momentum',
            'üìä Range Trading', 'üéØ Scalp', 'üåä Trend Following', '‚è∞ Opening Range',
            'üíé High Conviction', 'üé≤ Speculative', 'üìà Continuation', '‚ö†Ô∏è Risky Setup'
        ];
        
        const tagSuggestions = document.getElementById('tag-suggestions');
        if (!tagSuggestions) return;
        
        tagSuggestions.innerHTML = popularTags.map(tag => `
            <button type="button" onclick="app.addTagToInput('${tag.split(' ').slice(1).join(' ')}')" 
                    class="text-xs px-2 py-1 bg-[#1a1a1a] hover:bg-[#222] border border-[#333] rounded">
                ${tag}
            </button>
        `).join('');
    };

    app.addTagToInput = function(tag) {
        const input = document.getElementById('session-tags');
        if (!input) return;
        
        const currentTags = input.value.split(',').map(t => t.trim()).filter(t => t);
        if (!currentTags.includes(tag)) {
            currentTags.push(tag);
            input.value = currentTags.join(', ');
        }
    };

    // Save tags with session
    const originalStartSession = app.startSession;
    app.startSession = function() {
        originalStartSession.call(this);
        setTimeout(() => {
            app.initializeTagSuggestions();
        }, 100);
    };

    // ============================================
    // ENHANCEMENT #7: Predictive AI Insights
    // ============================================
    
    app.refreshPredictiveInsights = function() {
        const sessions = this.state.sessions.slice(0, 30);
        if (sessions.length < 5) {
            const container = document.getElementById('predictive-insights');
            if (container) {
                container.innerHTML = `
                    <div class="col-span-2 text-center py-8 text-secondary">
                        <iconify-icon icon="solar:chart-2-bold" width="48" class="opacity-50 mb-2"></iconify-icon>
                        <div>Need at least 5 sessions to generate AI insights</div>
                    </div>
                `;
            }
            return;
        }
        
        const insights = this.generatePredictiveInsights(sessions);
        const container = document.getElementById('predictive-insights');
        
        if (container && insights.length > 0) {
            container.innerHTML = insights.map(insight => `
                <div class="p-4 bg-[#111] border border-[#222] rounded hover:border-[#333] transition-colors">
                    <div class="flex items-start gap-3">
                        <div class="text-2xl">${insight.icon}</div>
                        <div class="flex-1">
                            <div class="font-semibold text-sm mb-1">${insight.title}</div>
                            <div class="text-xs text-secondary">${insight.message}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    };

    app.generatePredictiveInsights = function(sessions) {
        const insights = [];
        
        // 1. Best Trading Time Analysis
        const timePatterns = this.analyzeTimePatterns(sessions);
        if (timePatterns.bestHour !== null) {
            insights.push({
                type: 'time',
                icon: '‚è∞',
                title: 'Optimal Trading Time',
                message: `You perform best between ${timePatterns.bestHour}:00-${timePatterns.bestHour + 1}:00 with ${timePatterns.winRate.toFixed(1)}% win rate`
            });
        }
        
        // 2. Instrument Performance
        const instrumentStats = {};
        sessions.forEach(s => {
            if (!instrumentStats[s.instrument]) {
                instrumentStats[s.instrument] = { wins: 0, total: 0 };
            }
            instrumentStats[s.instrument].total++;
            if (s.outcome === 'win') instrumentStats[s.instrument].wins++;
        });
        
        let bestInstrument = null;
        let bestWinRate = 0;
        Object.keys(instrumentStats).forEach(inst => {
            const winRate = instrumentStats[inst].wins / instrumentStats[inst].total;
            if (instrumentStats[inst].total >= 3 && winRate > bestWinRate) {
                bestWinRate = winRate;
                bestInstrument = inst;
            }
        });
        
        if (bestInstrument) {
            insights.push({
                type: 'instrument',
                icon: 'üéØ',
                title: 'Strongest Instrument',
                message: `${bestInstrument} shows your highest win rate at ${(bestWinRate * 100).toFixed(1)}%`
            });
        }
        
        // 3. Mood Impact Analysis
        const moodPerformance = {};
        sessions.forEach(s => {
            if (!moodPerformance[s.mood]) {
                moodPerformance[s.mood] = { wins: 0, total: 0 };
            }
            moodPerformance[s.mood].total++;
            if (s.outcome === 'win') moodPerformance[s.mood].wins++;
        });
        
        let bestMood = null;
        let bestMoodRate = 0;
        Object.keys(moodPerformance).forEach(mood => {
            const winRate = moodPerformance[mood].wins / moodPerformance[mood].total;
            if (moodPerformance[mood].total >= 3 && winRate > bestMoodRate) {
                bestMoodRate = winRate;
                bestMood = mood;
            }
        });
        
        if (bestMood) {
            insights.push({
                type: 'mood',
                icon: 'üß†',
                title: 'Emotional State Impact',
                message: `You trade best when feeling "${bestMood}" with ${(bestMoodRate * 100).toFixed(1)}% win rate`
            });
        }
        
        // 4. Risk Analysis
        const winSessions = sessions.filter(s => s.outcome === 'win');
        const lossSessions = sessions.filter(s => s.outcome === 'loss');
        
        if (winSessions.length > 0 && lossSessions.length > 0) {
            const avgRiskWins = winSessions.reduce((sum, s) => sum + parseFloat(s.risk || 2), 0) / winSessions.length;
            const avgRiskLosses = lossSessions.reduce((sum, s) => sum + parseFloat(s.risk || 2), 0) / lossSessions.length;
            
            if (avgRiskLosses > avgRiskWins + 0.5) {
                insights.push({
                    type: 'risk',
                    icon: '‚ö†Ô∏è',
                    title: 'Risk Management Insight',
                    message: `Winning trades average ${avgRiskWins.toFixed(1)}% risk vs ${avgRiskLosses.toFixed(1)}% on losses. Consider reducing position size.`
                });
            }
        }
        
        // 5. Session Duration Pattern
        if (sessions.filter(s => s.duration).length > 5) {
            const durSessions = sessions.filter(s => s.duration && s.outcome === 'win');
            if (durSessions.length > 3) {
                const avgDuration = durSessions.reduce((sum, s) => sum + s.duration, 0) / durSessions.length;
                insights.push({
                    type: 'duration',
                    icon: '‚è±Ô∏è',
                    title: 'Session Duration Sweet Spot',
                    message: `Your winning sessions average ${Math.round(avgDuration)} minutes. Stay focused!`
                });
            }
        }
        
        // 6. Mistake Pattern
        const recentMistakes = sessions.slice(0, 10).filter(s => s.mistakes && s.mistakes.length > 0);
        if (recentMistakes.length >= 3) {
            const allMistakes = {};
            recentMistakes.forEach(s => {
                s.mistakes.forEach(m => {
                    allMistakes[m] = (allMistakes[m] || 0) + 1;
                });
            });
            const topMistake = Object.keys(allMistakes).reduce((a, b) => allMistakes[a] > allMistakes[b] ? a : b);
            insights.push({
                type: 'mistake',
                icon: 'üö®',
                title: 'Common Mistake Alert',
                message: `"${topMistake}" appears in ${allMistakes[topMistake]} of your last 10 sessions. Focus here!`
            });
        }
        
        return insights;
    };

    app.analyzeTimePatterns = function(sessions) {
        const hourlyStats = {};
        
        sessions.forEach(s => {
            const hour = new Date(s.startTime).getHours();
            if (!hourlyStats[hour]) {
                hourlyStats[hour] = { wins: 0, total: 0 };
            }
            hourlyStats[hour].total++;
            if (s.outcome === 'win') hourlyStats[hour].wins++;
        });
        
        let bestHour = null;
        let bestWinRate = 0;
        
        Object.keys(hourlyStats).forEach(hour => {
            const winRate = hourlyStats[hour].wins / hourlyStats[hour].total;
            if (hourlyStats[hour].total >= 3 && winRate > bestWinRate) {
                bestWinRate = winRate;
                bestHour = parseInt(hour);
            }
        });
        
        return { bestHour, winRate: bestWinRate * 100 };
    };

    // ============================================
    // ENHANCEMENT #8: PDF Export with Charts
    // ============================================
    
    app.exportToPDF = function() {
        // Load jsPDF from CDN if not already loaded
        if (typeof window.jspdf === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
            script.onload = () => this.generatePDF();
            document.head.appendChild(script);
        } else {
            this.generatePDF();
        }
    };

    app.generatePDF = function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Title
        doc.setFontSize(24);
        doc.setTextColor(16, 185, 129); // Green
        doc.text('EdgeMetrics Trading Report', 20, 20);
        
        // Date Range
        doc.setFontSize(10);
        doc.setTextColor(128, 128, 128);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 28);
        
        // Stats Summary
        doc.setFontSize(16);
        doc.setTextColor(0, 0, 0);
        doc.text('Performance Summary', 20, 40);
        
        const totalSessions = this.state.sessions.length;
        const wins = this.state.sessions.filter(s => s.outcome === 'win').length;
        const winRate = totalSessions > 0 ? ((wins / totalSessions) * 100).toFixed(1) : 0;
        const totalPnL = this.state.sessions.reduce((sum, s) => sum + (s.pnl || 0), 0);
        const edgeScore = this.calculateEdgeScore(this.state.sessions);
        
        doc.setFontSize(11);
        doc.text(`Total Sessions: ${totalSessions}`, 25, 50);
        doc.text(`Win Rate: ${winRate}%`, 25, 58);
        doc.text(`Total P&L: $${totalPnL.toFixed(2)}`, 25, 66);
        doc.text(`EdgeScore: ${edgeScore}/100`, 25, 74);
        
        // Try to add chart if available
        const canvas = document.querySelector('#pnl-chart');
        if (canvas) {
            try {
                const chartImage = canvas.toDataURL('image/png');
                doc.addImage(chartImage, 'PNG', 20, 85, 170, 70);
            } catch (e) {
                console.log('Could not add chart to PDF');
            }
        }
        
        // Recent Sessions
        doc.addPage();
        doc.setFontSize(16);
        doc.text('Recent Trading Sessions', 20, 20);
        
        let yPos = 35;
        this.state.sessions.slice(0, 15).forEach((session, i) => {
            if (yPos > 270) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(9);
            const date = new Date(session.startTime).toLocaleDateString();
            const outcome = session.outcome.toUpperCase();
            const pnl = session.pnl !== null && session.pnl !== undefined ? `$${session.pnl.toFixed(2)}` : 'N/A';
            
            // Color code by outcome
            if (session.outcome === 'win') {
                doc.setTextColor(16, 185, 129);
            } else if (session.outcome === 'loss') {
                doc.setTextColor(239, 68, 68);
            } else {
                doc.setTextColor(128, 128, 128);
            }
            
            doc.text(`${i + 1}. ${date} | ${session.instrument} | ${outcome} | ${pnl}`, 25, yPos);
            doc.setTextColor(0, 0, 0);
            yPos += 8;
        });
        
        // Footer
        doc.setFontSize(8);
        doc.setTextColor(128, 128, 128);
        doc.text('Generated by EdgeMetrics - Your Privacy-First Trading Journal', 20, 285);
        
        // Save
        const filename = `EdgeMetrics-Report-${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(filename);
        this.showToast('PDF report generated successfully! üìÑ', 'success');
    };

    // ============================================
    // ENHANCEMENT #9: Advanced Search System
    // ============================================
    
    app.toggleAdvancedSearch = function() {
        const panel = document.getElementById('advanced-search');
        if (panel) {
            panel.classList.toggle('hidden');
        }
    };

    app.applyAdvancedSearch = function() {
        const dateFrom = document.getElementById('search-date-from').value;
        const dateTo = document.getElementById('search-date-to').value;
        const pnlMin = document.getElementById('search-pnl-min').value;
        const pnlMax = document.getElementById('search-pnl-max').value;
        const mood = document.getElementById('search-mood').value;
        const tags = document.getElementById('search-tags').value;
        
        let filtered = [...this.state.sessions];
        
        // Date range filter
        if (dateFrom) {
            filtered = filtered.filter(s => new Date(s.startTime) >= new Date(dateFrom));
        }
        if (dateTo) {
            filtered = filtered.filter(s => new Date(s.startTime) <= new Date(dateTo + 'T23:59:59'));
        }
        
        // P&L range filter
        if (pnlMin) {
            filtered = filtered.filter(s => (s.pnl || 0) >= parseFloat(pnlMin));
        }
        if (pnlMax) {
            filtered = filtered.filter(s => (s.pnl || 0) <= parseFloat(pnlMax));
        }
        
        // Mood filter
        if (mood) {
            filtered = filtered.filter(s => s.mood === mood);
        }
        
        // Tags filter
        if (tags) {
            const searchTags = tags.toLowerCase().split(',').map(t => t.trim());
            filtered = filtered.filter(s => {
                const sessionTags = (s.tags || '').toLowerCase();
                return searchTags.some(tag => sessionTags.includes(tag));
            });
        }
        
        this.state.filteredSessions = filtered;
        this.renderDashboard();
        this.showToast(`Found ${filtered.length} sessions`, 'info');
        this.toggleAdvancedSearch();
    };

    app.clearAdvancedSearch = function() {
        document.getElementById('search-date-from').value = '';
        document.getElementById('search-date-to').value = '';
        document.getElementById('search-pnl-min').value = '';
        document.getElementById('search-pnl-max').value = '';
        document.getElementById('search-mood').value = '';
        document.getElementById('search-tags').value = '';
        
        this.state.filteredSessions = null;
        this.renderDashboard();
        this.showToast('Filters cleared', 'info');
    };

    app.saveCurrentFilter = function() {
        const filterName = prompt('Enter a name for this filter:');
        if (!filterName) return;
        
        const filter = {
            name: filterName,
            dateFrom: document.getElementById('search-date-from').value,
            dateTo: document.getElementById('search-date-to').value,
            pnlMin: document.getElementById('search-pnl-min').value,
            pnlMax: document.getElementById('search-pnl-max').value,
            mood: document.getElementById('search-mood').value,
            tags: document.getElementById('search-tags').value
        };
        
        const savedFilters = JSON.parse(localStorage.getItem('edgemetrics_saved_filters') || '[]');
        savedFilters.push(filter);
        localStorage.setItem('edgemetrics_saved_filters', JSON.stringify(savedFilters));
        
        this.loadSavedFilters();
        this.showToast('Filter saved!', 'success');
    };

    app.loadSavedFilters = function() {
        const savedFilters = JSON.parse(localStorage.getItem('edgemetrics_saved_filters') || '[]');
        const container = document.getElementById('saved-filters');
        
        if (container) {
            if (savedFilters.length === 0) {
                container.innerHTML = '<div class="text-xs text-muted text-center py-2">No saved filters</div>';
            } else {
                container.innerHTML = savedFilters.map((filter, i) => `
                    <div class="flex items-center justify-between p-2 bg-[#1a1a1a] rounded hover:bg-[#222]">
                        <button onclick="app.applySavedFilter(${i})" class="flex-1 text-left text-xs">${filter.name}</button>
                        <button onclick="app.deleteSavedFilter(${i})" class="text-red-500 hover:text-red-400 text-xs ml-2">√ó</button>
                    </div>
                `).join('');
            }
        }
    };

    app.applySavedFilter = function(index) {
        const savedFilters = JSON.parse(localStorage.getItem('edgemetrics_saved_filters') || '[]');
        const filter = savedFilters[index];
        
        if (filter) {
            document.getElementById('search-date-from').value = filter.dateFrom || '';
            document.getElementById('search-date-to').value = filter.dateTo || '';
            document.getElementById('search-pnl-min').value = filter.pnlMin || '';
            document.getElementById('search-pnl-max').value = filter.pnlMax || '';
            document.getElementById('search-mood').value = filter.mood || '';
            document.getElementById('search-tags').value = filter.tags || '';
            
            this.applyAdvancedSearch();
        }
    };

    app.deleteSavedFilter = function(index) {
        const savedFilters = JSON.parse(localStorage.getItem('edgemetrics_saved_filters') || '[]');
        savedFilters.splice(index, 1);
        localStorage.setItem('edgemetrics_saved_filters', JSON.stringify(savedFilters));
        this.loadSavedFilters();
        this.showToast('Filter deleted', 'info');
    };

    // ============================================
    // ENHANCEMENT #10: Theme Customization
    // ============================================
    
    app.toggleThemeMenu = function() {
        const menu = document.getElementById('theme-menu');
        if (menu) {
            menu.classList.toggle('hidden');
        }
    };

    app.setTheme = function(theme) {
        localStorage.setItem('edgemetrics_theme', theme);
        
        if (theme === 'light') {
            document.body.classList.add('light-theme');
        } else if (theme === 'dark') {
            document.body.classList.remove('light-theme');
        } else if (theme === 'auto') {
            // Check system preference
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (prefersDark) {
                document.body.classList.remove('light-theme');
            } else {
                document.body.classList.add('light-theme');
            }
        }
        
        this.showToast(`Theme changed to ${theme}`, 'success');
    };

    app.setAccentColor = function(color) {
        const colorMap = {
            green: '#10b981',
            blue: '#3b82f6',
            purple: '#a855f7',
            orange: '#f97316',
            pink: '#ec4899'
        };
        
        document.documentElement.style.setProperty('--accent-color', colorMap[color]);
        localStorage.setItem('edgemetrics_accent', color);
        this.showToast(`Accent color changed to ${color}`, 'success');
    };

    app.toggleReducedMotion = function() {
        const enabled = document.getElementById('reduced-motion').checked;
        if (enabled) {
            document.body.classList.add('reduce-motion');
        } else {
            document.body.classList.remove('reduce-motion');
        }
        localStorage.setItem('edgemetrics_reduced_motion', enabled);
    };

    app.toggleHighContrast = function() {
        const enabled = document.getElementById('high-contrast').checked;
        if (enabled) {
            document.body.classList.add('high-contrast');
        } else {
            document.body.classList.remove('high-contrast');
        }
        localStorage.setItem('edgemetrics_high_contrast', enabled);
    };

    app.loadThemeSettings = function() {
        // Load theme
        const theme = localStorage.getItem('edgemetrics_theme') || 'dark';
        const themeRadio = document.querySelector(`input[name="theme"][value="${theme}"]`);
        if (themeRadio) themeRadio.checked = true;
        this.setTheme(theme);
        
        // Load accent color
        const accent = localStorage.getItem('edgemetrics_accent');
        if (accent) {
            this.setAccentColor(accent);
        }
        
        // Load accessibility settings
        const reducedMotion = localStorage.getItem('edgemetrics_reduced_motion') === 'true';
        const highContrast = localStorage.getItem('edgemetrics_high_contrast') === 'true';
        
        const reducedMotionCheckbox = document.getElementById('reduced-motion');
        const highContrastCheckbox = document.getElementById('high-contrast');
        
        if (reducedMotionCheckbox) reducedMotionCheckbox.checked = reducedMotion;
        if (highContrastCheckbox) highContrastCheckbox.checked = highContrast;
        
        if (reducedMotion) document.body.classList.add('reduce-motion');
        if (highContrast) document.body.classList.add('high-contrast');
        
        // Load saved filters
        this.loadSavedFilters();
    };

    // Close menus when clicking outside
    document.addEventListener('click', function(e) {
        const themeMenu = document.getElementById('theme-menu');
        const themeToggle = document.getElementById('theme-toggle');
        const advancedSearch = document.getElementById('advanced-search');
        
        if (themeMenu && !themeMenu.contains(e.target) && !themeToggle.contains(e.target)) {
            themeMenu.classList.add('hidden');
        }
        
        if (advancedSearch && !advancedSearch.contains(e.target)) {
            const searchInput = document.getElementById('search-input');
            if (!searchInput.contains(e.target) && !e.target.closest('button[onclick*="toggleAdvancedSearch"]')) {
                // Don't close if clicking the toggle button
            }
        }
    });
    </script>
    
    <!-- Additional CSS for new features -->
    <style>
    /* Predictive Insights Card Hover */
    #predictive-insights > div:hover {
        transform: translateY(-2px);
        transition: transform 0.2s ease;
    }
    
    /* Screenshot Preview */
    #screenshot-preview img {
        transition: transform 0.2s ease;
    }
    #screenshot-preview img:hover {
        transform: scale(1.05);
    }
    
    /* Advanced Search Panel */
    #advanced-search {
        animation: slideDown 0.2s ease;
    }
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Theme Menu Animation */
    #theme-menu:not(.hidden) {
        animation: fadeIn 0.2s ease;
    }
    
    /* Light Theme Support */
    .light-theme {
        background: #ffffff;
        color: #000000;
    }
    .light-theme .bg-\[#0a0a0a\],
    .light-theme .bg-\[#0d0d0d\],
    .light-theme .bg-\[#111\],
    .light-theme .bg-\[#111111\] {
        background: #f5f5f5 !important;
    }
    .light-theme .border-\[#222\],
    .light-theme .border-\[#222222\] {
        border-color: #e0e0e0 !important;
    }
    .light-theme .text-secondary {
        color: #666666 !important;
    }
    
    /* High Contrast Mode */
    .high-contrast {
        --accent-color: #00ff00 !important;
    }
    .high-contrast .text-secondary {
        color: #cccccc !important;
    }
    
    /* Reduced Motion */
    .reduce-motion * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
    
    /* Accent Color Variable */
    :root {
        --accent-color: #10b981;
    }
    .btn-primary {
        background-color: var(--accent-color) !important;
    }
    .text-success {
        color: var(--accent-color) !important;
    }
    </style>
    
    <!-- Week 2-4 UX Improvements - Integrated -->
    <script>
    (function() {
        'use strict';
        
        console.log('üé® Loading Week 2-4 UX Improvements...');
        
        // ============================================
        // KEYBOARD SHORTCUTS GUIDE
        // ============================================
        
        window.showKeyboardShortcuts = function() {
            let modal = document.getElementById('shortcuts-modal');
            if (modal) {
                modal.remove();
            }
            
            modal = document.createElement('div');
            modal.id = 'shortcuts-modal';
            modal.className = 'modal-overlay active';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 32px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h2 style="font-size: 24px; font-weight: 600; color: var(--text-primary);">‚å®Ô∏è Keyboard Shortcuts</h2>
                            <p style="color: var(--text-secondary); font-size: 14px; margin-top: 4px;">Master EdgeMetrics like a pro</p>
                        </div>
                        <button onclick="document.getElementById('shortcuts-modal').remove()" style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 28px; padding: 0; line-height: 1;">√ó</button>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #10b981; font-size: 12px; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">SESSIONS</h3>
                        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                            <span style="color: var(--text-primary);">Start new trading session</span>
                            <kbd style="background: var(--bg-tertiary); border: 1px solid var(--border-hover); border-radius: 4px; padding: 4px 12px; font-family: monospace; font-size: 12px; color: #10b981;">Ctrl/‚åò + N</kbd>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                            <span style="color: var(--text-primary);">Quick log trade</span>
                            <kbd style="background: var(--bg-tertiary); border: 1px solid var(--border-hover); border-radius: 4px; padding: 4px 12px; font-family: monospace; font-size: 12px; color: #10b981;">Ctrl/‚åò + Q</kbd>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #10b981; font-size: 12px; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">NAVIGATION</h3>
                        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                            <span style="color: var(--text-primary);">Open analytics</span>
                            <kbd style="background: var(--bg-tertiary); border: 1px solid var(--border-hover); border-radius: 4px; padding: 4px 12px; font-family: monospace; font-size: 12px; color: #10b981;">Ctrl/‚åò + A</kbd>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                            <span style="color: var(--text-primary);">Focus search</span>
                            <kbd style="background: var(--bg-tertiary); border: 1px solid var(--border-hover); border-radius: 4px; padding: 4px 12px; font-family: monospace; font-size: 12px; color: #10b981;">/</kbd>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                            <span style="color: var(--text-primary);">Close modals</span>
                            <kbd style="background: var(--bg-tertiary); border: 1px solid var(--border-hover); border-radius: 4px; padding: 4px 12px; font-family: monospace; font-size: 12px; color: #10b981;">Escape</kbd>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: #10b981; font-size: 12px; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">HELP</h3>
                        <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                            <span style="color: var(--text-primary);">Show shortcuts</span>
                            <kbd style="background: var(--bg-tertiary); border: 1px solid var(--border-hover); border-radius: 4px; padding: 4px 12px; font-family: monospace; font-size: 12px; color: #10b981;">Ctrl/‚åò + K</kbd>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px 0;">
                            <span style="color: var(--text-primary);">Show help</span>
                            <kbd style="background: var(--bg-tertiary); border: 1px solid var(--border-hover); border-radius: 4px; padding: 4px 12px; font-family: monospace; font-size: 12px; color: #10b981;">?</kbd>
                        </div>
                    </div>
                    
                    <div style="background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; padding: 16px; border-radius: 4px;">
                        <div style="color: #10b981; font-weight: 600; margin-bottom: 4px;">üí° Pro Tip</div>
                        <div style="color: var(--text-primary); font-size: 14px;">
                            Press <kbd style="background: var(--bg-tertiary); padding: 2px 8px; border-radius: 3px; font-family: monospace;">Ctrl/‚åò + K</kbd> anytime to see this guide!
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on click outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        };
        
        // ============================================
        // KEYBOARD SHORTCUTS HANDLERS
        // ============================================
        
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + K: Show shortcuts
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                window.showKeyboardShortcuts();
            }
            
            // ?: Show help
            if (e.key === '?' && !e.target.matches('input, textarea')) {
                e.preventDefault();
                window.showKeyboardShortcuts();
            }
            
            // /: Focus search
            if (e.key === '/' && !e.target.matches('input, textarea')) {
                e.preventDefault();
                const searchInput = document.getElementById('search-input');
                if (searchInput) searchInput.focus();
            }
        });
        
        // ============================================
        // ADD HELP BUTTON TO HEADER
        // ============================================
        
        function addHelpButton() {
            setTimeout(() => {
                const header = document.querySelector('header .flex.items-center.gap-4');
                if (!header || document.getElementById('help-button')) return;
                
                const helpButton = document.createElement('button');
                helpButton.id = 'help-button';
                helpButton.innerHTML = '‚ùì';
                helpButton.title = 'Help & Shortcuts (Ctrl+K)';
                helpButton.style.cssText = `
                    background: transparent;
                    border: 1px solid var(--border-hover);
                    color: var(--text-secondary);
                    width: 32px;
                    height: 32px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 16px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s;
                `;
                
                helpButton.onmouseover = () => {
                    helpButton.style.borderColor = '#10b981';
                    helpButton.style.color = '#10b981';
                };
                
                helpButton.onmouseout = () => {
                    helpButton.style.borderColor = 'var(--border-hover)';
                    helpButton.style.color = 'var(--text-secondary)';
                };
                
                helpButton.onclick = () => {
                    window.showKeyboardShortcuts();
                };
                
                header.appendChild(helpButton);
            }, 1000);
        }
        
        // ============================================
        // INTERACTIVE ONBOARDING TOUR
        // ============================================
        
        function startOnboarding() {
            if (localStorage.getItem('edgemetrics_onboarding_completed')) {
                return; // Already completed
            }
            
            const steps = [
                {
                    message: 'üëã Welcome to EdgeMetrics! Press Ctrl+K anytime to see keyboard shortcuts.',
                    duration: 4000
                },
                {
                    message: 'üîç Use the search bar to find any session instantly.',
                    duration: 3000
                },
                {
                    message: '‚å®Ô∏è Tip: Press / to focus search quickly!',
                    duration: 3000
                },
                {
                    message: 'üìä Click Analytics to see your performance charts.',
                    duration: 3000
                },
                {
                    message: '‚úÖ You\'re all set! Start logging your trades.',
                    duration: 3000
                }
            ];
            
            let currentStep = 0;
            
            function showStep() {
                if (currentStep >= steps.length) {
                    localStorage.setItem('edgemetrics_onboarding_completed', 'true');
                    return;
                }
                
                const step = steps[currentStep];
                
                // Create toast notification
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    padding: 16px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    z-index: 9999;
                    max-width: 350px;
                    font-size: 14px;
                    animation: slideInRight 0.3s ease;
                `;
                toast.textContent = step.message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        toast.remove();
                        currentStep++;
                        if (currentStep < steps.length) {
                            setTimeout(showStep, 500);
                        } else {
                            localStorage.setItem('edgemetrics_onboarding_completed', 'true');
                        }
                    }, 300);
                }, step.duration);
            }
            
            // Start after 2 seconds
            setTimeout(showStep, 2000);
        }
        
        // Add animations
        const animStyles = document.createElement('style');
        animStyles.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(animStyles);
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        window.addEventListener('load', () => {
            addHelpButton();
            startOnboarding();
            console.log('‚úÖ Week 2-4 UX Improvements loaded!');
            console.log('üìù Press Ctrl+K for keyboard shortcuts');
            console.log('üìù Press ? for help');
            console.log('üìù Press / to focus search');
        });
        
    })();
    </script>
    
    <script>
// Register PWA Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(registration => {
        console.log('EdgeMetrics PWA: Service Worker registered!');
      })
      .catch(error => {
        console.log('EdgeMetrics PWA: Service Worker registration failed:', error);
      });
  });
}

// PWA Install Prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  // Show install button/banner
  showInstallPrompt();
});

function showInstallPrompt() {
  // Create install prompt banner
  const banner = document.createElement('div');
  banner.id = 'pwa-install-banner';
  banner.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 16px;
    max-width: 90%;
    animation: slideUp 0.3s ease;
  `;
  
  banner.innerHTML = `
    <div style="flex: 1;">
      <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">üì± Install EdgeMetrics</div>
      <div style="font-size: 12px; opacity: 0.9;">Add to your home screen for a better experience</div>
    </div>
    <button id="pwa-install-btn" style="background: white; color: #10b981; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
      Install
    </button>
    <button id="pwa-close-btn" style="background: transparent; color: white; border: none; padding: 8px; cursor: pointer; font-size: 18px; opacity: 0.8;">
      √ó
    </button>
  `;
  
  document.body.appendChild(banner);
  
  // Install button click
  document.getElementById('pwa-install-btn').addEventListener('click', () => {
    banner.remove();
    if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('User accepted the install prompt');
        }
        deferredPrompt = null;
      });
    }
  });
  
  // Close button click
  document.getElementById('pwa-close-btn').addEventListener('click', () => {
    banner.remove();
  });
}

// Add slide up animation
const style = document.createElement('style');
style.textContent = `
  @keyframes slideUp {
    from {
      transform: translate(-50%, 100px);
      opacity: 0;
    }
    to {
      transform: translate(-50%, 0);
      opacity: 1;
    }
  }
`;
document.head.appendChild(style);
</script>
</body>
</html>
